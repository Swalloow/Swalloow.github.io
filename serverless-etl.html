<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>Serverless ETL 서비스들에 대한 리뷰</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- [[! highlight.js ]] -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    
        <meta property="og:site_name" content="Swalloow Blog" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="Serverless ETL 서비스들에 대한 리뷰" />
        <meta property="og:description" content="​ 15년 AWS Lambda가 출시된 이후, 뜨거운 반응을 보이며 다양한 서버리스 서비스들이 출시되었다. 그 중 ETL에 관련되어 있는 서비스들을 사용해보면서..." />
        <meta property="og:url" content="/" />
        <meta property="og:image" content="/assets/images/cover_main.jpg" />
    

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Swalloow Blog" />
    <meta name="twitter:description" content="About Data Science, Data Engineering" />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image:src" content="/assets/images/cover_main.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Swalloow Blog",
    "url": "/",
    "image": "/assets/images/cover_main.jpg",
    "description": "About Data Science, Data Engineering"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Swalloow Blog" href="/feed.xml" />

</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        <li class="nav-personal " role="presentation"><a href="/tag/Personal">Personal</a></li>
        <li class="nav-develop " role="presentation"><a href="/tag/Develop">Develop</a></li>
        <li class="nav-devops " role="presentation"><a href="/tag/DevOps">DevOps</a></li>
        <li class="nav-datascience " role="presentation"><a href="/tag/DataScience">DataScience</a></li>
        <li class="nav-dataengineering " role="presentation"><a href="/tag/DataEngineering">DataEngineering</a></li>
        <li class="nav-financial " role="presentation"><a href="/tag/Financial">Financial</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/ghost.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-DataEngineering">

        <header class="post-header">
            <h1 class="post-title">Serverless ETL 서비스들에 대한 리뷰</h1>
            <section class="post-meta">
            <!-- <a href='/'>Swalloow</a> -->
            <time class="post-date" datetime="2019-08-23">23 Aug 2019</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/DataEngineering'>Dataengineering</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>​</p>

<p>15년 AWS Lambda가 출시된 이후, 뜨거운 반응을 보이며 다양한 서버리스 서비스들이 출시되었다.
그 중 ETL에 관련되어 있는 서비스들을 사용해보면서 느낀 점에 대해 정리해보려 한다.</p>

<p>​</p>

<h2 id="lambda-athena--">Lambda와 Athena를 활용한 쿼리</h2>

<p>Athena는 Presto를 기반으로 만든 대화형 쿼리 서비스이다.
쿼리 당 스캔한 데이터의 TB당 5 USD 만 내면 된다.
보통 분석용 쿼리를 위한 클러스터는 리소스 요청이 불규칙적인 경우가 많다.
운영을 위한 비용까지 고려한다면 정말 좋은 서비스라고 볼 수 있다.
하지만 모든 서비스가 그렇듯 장점만 있는 것은 아니다.
특히 Athena를 분석용 쿼리가 아닌 다른 용도로 사용한다면 몇 가지 제한사항을 마주칠 수도 있다.</p>

<p><img src="http://drive.google.com/uc?export=view&amp;id=13Q_Ke3ZJuJxwR3Ahy479hT5nPJcNiSRV" alt="" /></p>

<p>Athena를 ETL 용도로 사용하고 싶다면 위 그림과 같이 Lambda, CloudWatch를 통해 트리거할 수 있다.
Athena 뿐만 아니라 Glue, EMR 등 다른 서비스도 모두 Lambda를 통해 실행할 수 있기 때문에
정말 온디멘드로 띄워놓는 인스턴스 하나도 없이 ETL을 구성할 수도 있다.
하지만 정말 데이터가 많고 복잡한 작업이라면 아래와 같은 제약사항들을 잘 이해하고 선택해야 한다.</p>

<p>​</p>

<h4 id="section">구글의 빅쿼리와 달리 쿼리 비용을 추정하는 기능이 없다</h4>

<p>Athena는 쿼리 비용을 추정하는 기능이 없기 때문에 잘 모르고 쿼리를 막 날린다면 과금 폭탄을 맞이할 수 있다.
물론 처음 사용하는 경우, AWS에 실수한 상황을 설명하면 어느정도 과금을 물러주기도 한다.</p>

<p>​</p>

<h4 id="athena------">Athena에는 동시 쿼리 제한과 시간 제한이 존재한다</h4>

<p>Athena의 기본 계정 당 쿼리 한도는 20개이다. Support에 요청하면 늘려주기도 하지만 이 역시 제한이 있다.
또한 30분이라는 쿼리 제한 시간이 존재한다.
따라서 오래걸리거나 무거운 작업에 Athena 쿼리를 활용하는 경우, 앞단에 큐를 두는 경우가 많다.</p>

<p>​</p>

<h4 id="athena-udf--">Athena는 UDF를 지원하지 않는다</h4>

<p>어쩌면 크게 다가올 수 있는 제한사항 중에 하나이다.
UDF를 많이 등록하고 사용했다면 사용자 입장에서 불편할 수 있다.</p>

<p>​</p>

<h4 id="athena-ctas----">Athena의 CTAS 쿼리에는 파티션 한도가 존재한다</h4>

<p>CTAS 쿼리란 SELECT의 결과로 채워지는 새 테이블을 생성하는 쿼리를 말한다.
CTAS 쿼리를 사용하는 경우, WITH 절의 external_location을 통해 저장될 위치를 지정한다.
이 때 Athena가 생성하는 쿼리 결과 파티션이 100개를 넘어가는 경우 오류가 발생한다.</p>

<p>​</p>

<h2 id="glue-etl-data-catalog">Glue ETL, Data Catalog</h2>

<p>Glue와 S3 Batch는 Athena와 달리 태생부터 ETL을 위해 만들어진 서버리스 서비스이다.
특히 Hive Metastore를 대체할 수 있는 Glue Data Catalog와 
자동으로 스키마를 생성해주는 Glue Crawler는 정말 편하게 사용할 수 있다.
Glue Data Catalog를 사용한다면 Athena, EMR 내에서 Glue를 중심으로 데이터 소스를 통합할 수 있다.</p>

<p><img src="http://drive.google.com/uc?export=view&amp;id=1rN1-SFqxqljQNQXhEqv0uTpC1ymrVXbo" alt="" /></p>

<p>하지만 Glue ETL와 S3 Batch 서비스는 요금에 비해 활용도가 낮다고 생각한다.
먼저 Glue ETL은 위 그림과 같이 input과 output을 정의하고 그 사이에 transform 작업을 정의할 수 있다.
Spark의 DataFrame을 기반으로 하며 DynamicFrame, Built-In Transform 등을 사용하여 스크립트를 작성한다.
서비스 중간에 추가되는 간단한 ETL Batch에 사용하기는 무난해보이지만 그게 아니라면 아래와 같은 사항들을 고려해야 한다.</p>

<p>​</p>

<h4 id="glue-etl-dpu---">Glue ETL은 DPU를 기준으로 요금이 계산된다</h4>

<p>Glue ETL의 요금은 DPU라는 하나의 처리 단위를 기준으로 산정되는데 1 DPU는 4CPU와 16GB의 메모리를 가진다.
DPU 시간당 0.44 USD, 초 단위로 청구되며 Apache Spark 유형 ETL 작업당 최소 시간은 10분이다.
Spark 기반의 ETL에서는 Executor에 대한 설정이 중요하다.
작업에 따라 CPU가 많이 필요할 수도 있고 메모리가 많이 필요할 수도 있다.
하지만 Glue는 DPU라는 단위로 고정되어 있다보니 비용 효율적으로 사용하기 어려웠다.
만일 자체 클러스터를 사용하고 전체 파이프라인 내에서 리소스를 효율적으로 사용할 수 있다면
GlueContext가 뜨는 시간까지 고려했을때 정말 저렴한 서비스인지 잘 모르겠다.</p>

<p>​</p>

<h4 id="glue-etl-----">Glue ETL은 디버깅, 모니터링 기능이 아직 부족하다</h4>

<p>Spark에는 Spark UI 라는 휼륭한 모니터링 대시보드가 존재하지만 Glue에서는 아직 이를 지원하지 않는다.
대신 자체적으로 CloudWatch를 통해 메모리, 로그를 제공하는데 아직 지표가 많이 부족해보였다.
DAG가 어떻게 구성되는지와 Shuffle 관련 지표도 볼 수가 없어 무거운 작업이라면 많은 노력이 필요하다.
아직 오픈한지 얼마 지나지 않은 서비스라 이 부분은 앞으로 많이 개선될거라 생각한다.</p>

<p>​</p>

<h2 id="step-function--etl-workflow-">Step Function을 사용한 ETL Workflow 관리</h2>

<p>Step Function은 Serverless 기반의 Workflow 서비스다.
여기에서는 가장 많이 사용하는 Airflow와 비교해가며 Serverless ETL이 가지는 특징을 설명해보려 한다.</p>

<p>​</p>

<h4 id="step-function-asl--">Step Function은 ASL이라는 언어로 정의된다</h4>

<p>Step Function에 들어가는 각 단계에는 Lambda, Fargate 등의 서버리스 서비스가 들어갈 수 있다.
그리고 각 단계는 Amazon States Language 라는 json 기반의 구조화된 언어로 정의된다.
Airflow가 많이 사용되는 이유 중에 하나가 파이썬으로 DAG를 구성할 수 있다는 점인데
이에 비해 json 기반의 Step Function은 너무 복잡하게 느껴졌다.</p>

<p>​</p>

<h4 id="step-function-operator-sensor-">Step Function에는 Operator, Sensor가 없다</h4>

<p><img src="http://drive.google.com/uc?export=view&amp;id=1u8wxsTHUK_TMh8ZUfuuY5d7OMbJSur4R" alt="" /></p>

<p>Lambda와 같은 서버리스 서비스는 수행에 대한 제한 시간이 존재한다.
각 단계가 대부분 람다 기반이다 보니 위 그림과 같이 Loop를 돌며 체크하는 패턴으로 Sensor를 구현한다.
Airflow에는 리소스마다 미리 정의된 Operator, Sensor가 많지만 Step Function에서는 이를 다 구현해야 한다.
만일 Loop를 피하고 싶다면 Fargate로 Sensor를 구현할 수 있지만 Fargate는 요금이 많이 나온다.</p>

<p>​</p>

<h2 id="section-1">정리하면서</h2>

<p>쓰다보니 단점만 나열한 것 같아 보이지만 AWS 서비스와 요금은 지속적으로 업데이트 되기 때문에
나중에는 이러한 제한사항들이 해결될지도 모른다. 그리고 상황에 따라 적절히 사용한다면 장점이 많다.
그리고 서버리스가 아니라 언급하지 않았지만 Managed Cluster 서비스인 EMR을 사용해서 모두 해결하는 방법도 있다.
만일 Event 기반의 간단한 ETL 이라면 Serverless ETL이 가지는 장점을 크게 활용해보길 추천한다.</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/Swalloow" style="background-image: url(/assets/images/avatar.png)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/Swalloow">Swalloow</a></h4>

                
                    <p> Interested in Data Science & Engineering</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Seoul, Korea</span>
                    <span class="author-link icon-link"><a href="http://swalloow.github.io/"> swalloow.github.io/</a></span>
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Serverless ETL 서비스들에 대한 리뷰&amp;url=http://swalloow.github.io/serverless-etl"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://swalloow.github.io/serverless-etl"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://swalloow.github.io/serverless-etl"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'swalloow'; // required: replace example with your forum shortname
        var disqus_identifier = '/serverless-etl';
        var disqus_url = 'http://swalloow.github.io//serverless-etl';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev no-cover" href="/openinfra">
            <section class="post">
                <h2>Open Infra Days 2019 후기</h2>
                <p>​ 19일부터 진행했던 Open Infra Days 2019에 참여하면서 배운 점들을 간단히 정리해보고자 한다. 해외의 CNCF...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Swalloow Blog</a> &copy; 2019</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-89689523-1', 'auto');
	    ga('send', 'pageview');

     </script>
</body>
</html>
