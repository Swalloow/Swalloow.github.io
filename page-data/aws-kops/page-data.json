{"componentChunkName":"component---src-templates-post-js","path":"/aws-kops/","result":{"data":{"contentfulPost":{"id":"22782f34-788f-5197-a6f7-35b71f4da0c9","title":"KOPS로 AWS에 Kubernetes 클러스터 구축하기","slug":"aws-kops","metaDescription":null,"publishDate":"February 10, 2019","publishDateISO":"2019-02-10","tags":[{"title":"DevOps","id":"701ee587-d6e3-5391-af93-e295765b6f45","slug":"devops"}],"heroImage":{"id":"f36c235f-3e3e-517d-bd80-697bc6183072","title":"cover-devops","fluid":{"aspectRatio":1.5,"src":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1800&q=50","srcSet":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=450&h=300&q=50 450w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=900&h=600&q=50 900w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1080&h=720&q=50 1080w","srcWebp":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1800&q=50&fm=webp","srcSetWebp":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=450&h=300&q=50&fm=webp 450w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=900&h=600&q=50&fm=webp 900w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1080&h=720&q=50&fm=webp 1080w","sizes":"(max-width: 1800px) 100vw, 1800px"},"ogimg":{"src":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1800&fl=progressive&q=50"}},"body":{"id":"39b3b781-063c-5008-81ca-6b2620548d99","childMarkdownRemark":{"id":"861450a3-c3ca-512b-9d61-4eb1dfeea051","timeToRead":4,"html":"<p>Kubernetes 클러스터를 구성하는 방법은 여러 가지가 있습니다.\n그 중에서 kubeadam은 온프레미스 환경에서 많이 사용하고 kops는 클라우드 환경에서 많이 사용하고 있습니다. 이번 글에서는 kops로 AWS EC2에 Kubernetes 클러스터 구축하는 방법에 대해 정리해보겠습니다.</p>\n<br>\n<h2 id=\"kops-kubectl-awscli-설치-linux\" style=\"position:relative;\"><a href=\"#kops-kubectl-awscli-%EC%84%A4%EC%B9%98-linux\" aria-label=\"kops kubectl awscli 설치 linux permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>kops, kubectl, awscli 설치 (Linux)</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># kops 설치</span>\n<span class=\"token function\">wget</span> -O kops https://github.com/kubernetes/kops/releases/download/<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> -s https://api.github.com/repos/kubernetes/kops/releases/latest <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> tag_name <span class=\"token operator\">|</span> <span class=\"token function\">cut</span> -d <span class=\"token string\">'\"'</span> -f <span class=\"token number\">4</span><span class=\"token variable\">)</span></span>/kops-linux-amd64\n<span class=\"token function\">chmod</span> +x ./kops\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> ./kops /usr/local/bin/\n\n<span class=\"token comment\"># kubectl 설치</span>\n<span class=\"token function\">wget</span> -O kubectl https://storage.googleapis.com/kubernetes-release/release/<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> -s https://storage.googleapis.com/kubernetes-release/release/stable.txt<span class=\"token variable\">)</span></span>/bin/linux/amd64/kubectl\n<span class=\"token function\">chmod</span> +x ./kubectl\n<span class=\"token function\">sudo</span> <span class=\"token function\">mv</span> ./kubectl /usr/local/bin/kubectl\n\n<span class=\"token comment\"># aws-cli 설치 (amazon linux라면 불필요)</span>\npip <span class=\"token function\">install</span> awscli</code></pre></div>\n<br>\n<h2 id=\"iam-user-설정\" style=\"position:relative;\"><a href=\"#iam-user-%EC%84%A4%EC%A0%95\" aria-label=\"iam user 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>IAM User 설정</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 아래의 권한이 필요</span>\nAmazonEC2FullAccess\nAmazonRoute53FullAccess\nAmazonS3FullAccess\nIAMFullAccess\nAmazonVPCFullAccess</code></pre></div>\n<br>\n<h2 id=\"aws-cli로-iam-계정-생성\" style=\"position:relative;\"><a href=\"#aws-cli%EB%A1%9C-iam-%EA%B3%84%EC%A0%95-%EC%83%9D%EC%84%B1\" aria-label=\"aws cli로 iam 계정 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>aws-cli로 IAM 계정 생성</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">aws iam create-group --group-name kops\n\naws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonEC2FullAccess --group-name kops\naws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonRoute53FullAccess --group-name kops\naws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess --group-name kops\naws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/IAMFullAccess --group-name kops\naws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonVPCFullAccess --group-name kops\n\naws iam create-user --user-name kops\naws iam add-user-to-group --user-name kops --group-name kops\naws iam create-access-key --user-name kops\n\naws configure   <span class=\"token comment\"># AccessKeyID와 SecretAccessKey 등록</span></code></pre></div>\n<br>\n<h2 id=\"dns-cluster-state-storage-설정\" style=\"position:relative;\"><a href=\"#dns-cluster-state-storage-%EC%84%A4%EC%A0%95\" aria-label=\"dns cluster state storage 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DNS, Cluster State storage 설정</h2>\n<ul>\n<li>kops 1.6.2 버전 이상이라면 DNS 설정은 옵션 (gossip-based cluster)</li>\n<li>Cluster Configuration Storage로 S3를 사용 (Bucket 미리 생성해야 함)</li>\n<li>S3 default bucket encryption을 사용할 수 있음</li>\n<li>default encryption 설정이 안되어 있다면 kops에서 AES256 encryption</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Create Bucket</span>\naws s3api create-bucket <span class=\"token punctuation\">\\</span>\n    --bucket prefix-example-com-state-store <span class=\"token punctuation\">\\</span>\n    --region ap-northeast-2\n\n<span class=\"token comment\"># S3 versioning</span>\naws s3api put-bucket-versioning <span class=\"token punctuation\">\\</span>\n    --bucket prefix-example-com-state-store <span class=\"token punctuation\">\\</span>\n    --versioning-configuration <span class=\"token assign-left variable\">Status</span><span class=\"token operator\">=</span>Enabled</code></pre></div>\n<br>\n<h2 id=\"kubernetes-cluster-생성\" style=\"position:relative;\"><a href=\"#kubernetes-cluster-%EC%83%9D%EC%84%B1\" aria-label=\"kubernetes cluster 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Kubernetes Cluster 생성</h2>\n<ul>\n<li>kops를 통해 생성된 인스턴스는 자동으로 Auto Scaling 그룹에 들어감</li>\n<li><code class=\"language-text\">kops create</code>: cluster configuration을 생성, SSH-Key가 필요</li>\n<li><code class=\"language-text\">kops edit</code>: cluster configuation을 수정</li>\n<li><code class=\"language-text\">kops update</code>: Build 단계, kubernetes component를 모두 설치하고 나면 ready 상태로 전환</li>\n<li><code class=\"language-text\">kops delete</code>: cluster 제거, --yes (구성요소까지 전부 삭제)</li>\n<li><code class=\"language-text\">kops rolling-update</code>: downtime이 없는 rolling-update 실행</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># Environment</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>myfirstcluster.example.com  <span class=\"token comment\"># DNS가 설정되어 있는 경우</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span>myfirstcluster.k8s.local    <span class=\"token comment\"># DNS가 설정되어 있지 않은 경우</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">KOPS_STATE_STORE</span><span class=\"token operator\">=</span>s3://prefix-example-com-state-store\n\n<span class=\"token comment\"># Seoul region</span>\naws ec2 describe-availability-zones --region ap-northeast-2\nkops create cluster --zones ap-northeast-2 <span class=\"token variable\">${NAME}</span>\nkops edit cluster <span class=\"token variable\">${NAME}</span>\nkops update cluster <span class=\"token variable\">${NAME}</span> --yes\nkops validate cluster\n\n<span class=\"token comment\"># Kubectl</span>\nkubectl get nodes\nkubectl cluster-info\nkubectl -n kube-system get po   <span class=\"token comment\"># system pod</span>\n\n<span class=\"token comment\"># Dashboard</span>\nkops get secrets admin -oplaintext\nkubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml\n\n<span class=\"token comment\"># Access https://&lt;kubernetes-master-hostname>/ui</span>\nkops get secrets admin --type secret -oplaintext\n\n<span class=\"token comment\"># Stop cluster</span>\n<span class=\"token comment\"># Change minSize, MaxSize to 0</span>\nkops get ig\nkops edit ig nodes\nkops edit ig master</code></pre></div>\n<br>\n<h2 id=\"advanced\" style=\"position:relative;\"><a href=\"#advanced\" aria-label=\"advanced permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Advanced</h2>\n<ul>\n<li>Network topology를 설정할 수 있음 (public, private)</li>\n<li>Private: VPC내의 private subnet으로 생성</li>\n<li>Public: VPC내의 public subnet으로 생성 (routed to Internet Gateway)</li>\n<li>Multiple zone, HA Master를 구성할 수 있음 (--master-zones=us-east-1b,us-east-1c,us-east-1d)</li>\n<li>Instance Group을 지정 가능 (<a href=\"https://github.com/kubernetes/kops/blob/master/docs/instance_groups.md\">https://github.com/kubernetes/kops/blob/master/docs/instance_groups.md</a>)</li>\n<li>AMI를 지정가능, CoreOS AMI</li>\n<li>Container Network Interface (CNI) 지정 가능 (<a href=\"https://kubernetes.io/docs/concepts/cluster-administration/networking/\">https://kubernetes.io/docs/concepts/cluster-administration/networking/</a>)</li>\n<li>Authorization (<a href=\"https://kubernetes.io/docs/reference/access-authn-authz/authorization/\">https://kubernetes.io/docs/reference/access-authn-authz/authorization/</a>)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># SSH Key</span>\nssh-keygen -t rsa -f <span class=\"token variable\">$NAME</span>.key -N <span class=\"token string\">''</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">PUBKEY</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$NAME</span>.key.pub\"</span>\n\n<span class=\"token comment\"># CoreOS Image</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">IMAGE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> -s https://coreos.com/dist/aws/aws-stable.json<span class=\"token operator\">|</span><span class=\"token function\">sed</span> <span class=\"token string\">'s/-/_/g'</span><span class=\"token operator\">|</span>jq <span class=\"token string\">'.'</span>$REGION<span class=\"token string\">'.hvm'</span><span class=\"token operator\">|</span><span class=\"token function\">sed</span> <span class=\"token string\">'s/_/-/g'</span> <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token string\">'s/<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>//g'</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># Create Cluster</span>\nkops create cluster --kubernetes-version<span class=\"token operator\">=</span><span class=\"token number\">1.12</span>.1 <span class=\"token punctuation\">\\</span>\n    --ssh-public-key <span class=\"token variable\">$PUBKEY</span> <span class=\"token punctuation\">\\</span>\n    --networking flannel <span class=\"token punctuation\">\\</span>\n    --api-loadbalancer-type public <span class=\"token punctuation\">\\</span>\n    --admin-access <span class=\"token number\">0.0</span>.0.0/0 <span class=\"token punctuation\">\\</span>\n    --authorization RBAC <span class=\"token punctuation\">\\</span>\n    --zones ap-northeast-2 <span class=\"token punctuation\">\\</span>\n    --master-zones ap-northeast-2 <span class=\"token punctuation\">\\</span>\n    --master-size t2.medium <span class=\"token punctuation\">\\</span>\n    --node-size t2.medium <span class=\"token punctuation\">\\</span>\n    --image <span class=\"token variable\">$IMAGE</span> <span class=\"token punctuation\">\\</span>\n    --node-count <span class=\"token number\">3</span> <span class=\"token punctuation\">\\</span>\n    --cloud aws <span class=\"token punctuation\">\\</span>\n    --bastion <span class=\"token punctuation\">\\</span>\n    --name <span class=\"token variable\">$NAME</span> <span class=\"token punctuation\">\\</span>\n    --yes</code></pre></div>\n<br>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://github.com/kubernetes/kops\">https://github.com/kubernetes/kops</a></li>\n<li><a href=\"https://kubernetes.io/ko/docs/setup/custom-cloud/kops/\">https://kubernetes.io/ko/docs/setup/custom-cloud/kops/</a></li>\n</ul>\n<br>","excerpt":"Kubernetes 클러스터를 구성하는 방법은 여러 가지가 있습니다.\n그 중에서 kubeadam은 온프레미스 환경에서 많이 사용하고 kops는 클라우드 환경에서 많이 사용하고 있습니다. 이번 글에서는 kops로 AWS EC2에 Kubernetes 클러스터 구축하는 방법에 대해 정리해보겠습니다. kops, kubectl, awscli 설치 (Linux) IAM User 설정 aws-cli로 IAM 계정 생성 DNS, Cluster State storage 설정 kops 1.6.2 버전 이상이라면 DNS 설정은 옵션 (gossip-based cluster) Cluster…"}}}},"pageContext":{"slug":"aws-kops","basePath":"","prev":{"slug":"why-kubeflow","publishDate":"2019-03-09"},"next":{"slug":"container-patterns","publishDate":"2019-01-26"}}}}