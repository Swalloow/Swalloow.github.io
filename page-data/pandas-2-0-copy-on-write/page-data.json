{"componentChunkName":"component---src-templates-post-js","path":"/pandas-2-0-copy-on-write/","result":{"data":{"contentfulPost":{"title":"Pandas 2.0의 Copy-on-Write에 대하여","slug":"pandas-2-0-copy-on-write","metaDescription":null,"publishDate":"December 24, 2023","publishDateISO":"2023-12-24","tags":[{"title":"DataEngineering","id":"25d7d0d6-3cf7-5e19-a5cb-9c3fa926046f","slug":"dataengineering"}],"heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiFBMeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgjileglOuFeTk6fC2ZH6BKV7ugEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":7,"html":"<p>Pandas 2.0 버전부터 <code class=\"language-text\">Copy-on-Write (CoW)</code>가 추가되었으며 3.0 버전부터 기본 값이 활성화로 변경됩니다. 이번 글에서는 Pandas Copy-on-Write가 Pandas가 가진 문제를 어떻게 해결하는지에 대해 알아보겠습니다.</p>\n<ul>\n<li><a href=\"https://swalloow.github.io/pandas-2-0-copy-on-write/#pandas-dataframe\">Pandas DataFrame</a></li>\n<li><a href=\"https://swalloow.github.io/pandas-2-0-copy-on-write/#pandas-settingwithcopywarning\">Pandas SettingWithCopyWarning</a></li>\n<li><a href=\"https://swalloow.github.io/pandas-2-0-copy-on-write/#pandas-copy-on-write\">Pandas Copy-on-Write</a></li>\n<li><a href=\"https://swalloow.github.io/pandas-2-0-copy-on-write/#pandas-copy-on-write-mode\">Pandas Copy-on-Write Mode</a></li>\n</ul>\n<br>\n<h2 id=\"pandas-dataframe\" style=\"position:relative;\"><a href=\"#pandas-dataframe\" aria-label=\"pandas dataframe permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pandas DataFrame</h2>\n<p>Pandas CoW에 대해 알아보기 이전에 먼저 DataFrame의 내부 구조에 대한 이해가 필요합니다.<br> <code class=\"language-text\">DataFrame</code>은 Pandas의 행, 열 기반 2차원 데이터 구조입니다.<br>\n초기에 Pandas는 아주 느린 컬럼 기반 연산을 빠르게 처리하기 위해 <code class=\"language-text\">BlockManager</code>를 추가했습니다.</p>\n<p><strong>BlockManager</strong><br>\nBlockManager는 numpy array로 저장된 데이터를 참조하는 블록을 관리하는 역할을 합니다.<br>\n아래 코드를 통해 자세히 알아보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>DataFrame<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">)</span>\n\n   c1 c2  c3\n<span class=\"token number\">0</span>   <span class=\"token number\">1</span>  a  <span class=\"token number\">10</span>\n<span class=\"token number\">1</span>   <span class=\"token number\">2</span>  b  <span class=\"token number\">20</span>\n<span class=\"token number\">2</span>   <span class=\"token number\">3</span>  c  <span class=\"token number\">30</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">.</span>_data<span class=\"token punctuation\">)</span>\n\nBlockManager\nItems<span class=\"token punctuation\">:</span> Index<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'c1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'c2'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'c3'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span><span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span>\nAxis <span class=\"token number\">1</span><span class=\"token punctuation\">:</span> RangeIndex<span class=\"token punctuation\">(</span>start<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> stop<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> step<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\nNumpyBlock<span class=\"token punctuation\">:</span> <span class=\"token builtin\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> x <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> dtype<span class=\"token punctuation\">:</span> int64\nNumpyBlock<span class=\"token punctuation\">:</span> <span class=\"token builtin\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> x <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> dtype<span class=\"token punctuation\">:</span> <span class=\"token builtin\">object</span></code></pre></div>\n<p>DataFrame을 생성하고 internal API를 통해 BlockManager 구조에 접근할 수 있습니다.<br>\n위 예시에서는 2개의 블록이 존재하며 그 중 int 타입을 가지는 <code class=\"language-text\">c1</code>, <code class=\"language-text\">c3</code>는 하나의 블록으로 통합되어 있습니다. 이처럼 BlockManager는 <strong>메모리 최적화와 효율적인 데이터 접근을 위해 동일한 타입을 하나의 블록으로 통합</strong>하여 관리합니다. 이번에는 동일한 타입을 가지는 <code class=\"language-text\">c4</code> 컬럼을 추가하고 다시 확인해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df<span class=\"token punctuation\">[</span><span class=\"token string\">'c4'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span><span class=\"token number\">300</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">.</span>_data<span class=\"token punctuation\">)</span>\n\nBlockManager\nItems<span class=\"token punctuation\">:</span> Index<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'c1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'c2'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'c3'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'c4'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span><span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span>\nAxis <span class=\"token number\">1</span><span class=\"token punctuation\">:</span> RangeIndex<span class=\"token punctuation\">(</span>start<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> stop<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> step<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\nNumpyBlock<span class=\"token punctuation\">:</span> <span class=\"token builtin\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span> x <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> dtype<span class=\"token punctuation\">:</span> int64\nNumpyBlock<span class=\"token punctuation\">:</span> <span class=\"token builtin\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> x <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> dtype<span class=\"token punctuation\">:</span> <span class=\"token builtin\">object</span>\nNumpyBlock<span class=\"token punctuation\">:</span> <span class=\"token builtin\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> x <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> dtype<span class=\"token punctuation\">:</span> int64</code></pre></div>\n<p>이번에는 새로운 블록이 추가된 것을 확인할 수 있습니다.<br>\n<strong>BlockManager는 새로운 블록이 추가될때마다 동일한 타입의 블록을 통합하지 않습니다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df<span class=\"token punctuation\">.</span>_data<span class=\"token punctuation\">.</span>consolidate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nBlockManager\nItems<span class=\"token punctuation\">:</span> Index<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'c1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'c2'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'c3'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'c4'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span><span class=\"token string\">'object'</span><span class=\"token punctuation\">)</span>\nAxis <span class=\"token number\">1</span><span class=\"token punctuation\">:</span> RangeIndex<span class=\"token punctuation\">(</span>start<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> stop<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> step<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\nNumpyBlock<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span> <span class=\"token number\">2</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span> x <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> dtype<span class=\"token punctuation\">:</span> int64\nNumpyBlock<span class=\"token punctuation\">:</span> <span class=\"token builtin\">slice</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> x <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> dtype<span class=\"token punctuation\">:</span> <span class=\"token builtin\">object</span></code></pre></div>\n<p>DataFrame 연산이 실행되기 직전에 <code class=\"language-text\">consolidate()</code> 메서드를 통해 자동으로 통합합니다.<br>\n구체적으로는 블록 통합이 연산에 유리한 경우에만 블록 통합이 이루어집니다.</p>\n<p><br><br></p>\n<h2 id=\"pandas-settingwithcopywarning\" style=\"position:relative;\"><a href=\"#pandas-settingwithcopywarning\" aria-label=\"pandas settingwithcopywarning permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pandas SettingWithCopyWarning</h2>\n<p>앞서 Pandas가 BlockManager를 통해 어떻게 블록을 관리하는지 알아보았습니다.<br>\n이번에는 CoW에서 해결하고자 하는 <code class=\"language-text\">SettingWithCopyWarning</code> 문제에 대해 알아보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> pandas <span class=\"token keyword\">as</span> pd\n\ndf <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>DataFrame<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">)</span>\n\n   student_id grade\n<span class=\"token number\">0</span>           <span class=\"token number\">1</span>     A\n<span class=\"token number\">1</span>           <span class=\"token number\">2</span>     C\n<span class=\"token number\">2</span>           <span class=\"token number\">3</span>     D</code></pre></div>\n<p>위와 같은 DataFrame에서 첫 번째 행의 <code class=\"language-text\">grade</code> 값을 E로 변경해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">grades <span class=\"token operator\">=</span> df<span class=\"token punctuation\">[</span><span class=\"token string\">\"grade\"</span><span class=\"token punctuation\">]</span>\ngrades<span class=\"token punctuation\">.</span>iloc<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"E\"</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">)</span>\n\n   student_id grade\n<span class=\"token number\">0</span>           <span class=\"token number\">1</span>     E\n<span class=\"token number\">1</span>           <span class=\"token number\">2</span>     C\n<span class=\"token number\">2</span>           <span class=\"token number\">3</span>     D\n\nSettingWithCopyWarning<span class=\"token punctuation\">:</span> \nA value <span class=\"token keyword\">is</span> trying to be <span class=\"token builtin\">set</span> on a copy of a <span class=\"token builtin\">slice</span> <span class=\"token keyword\">from</span> a DataFrame</code></pre></div>\n<p>코드만 보면 <code class=\"language-text\">grade</code> 변수에만 변경내용이 적용된 것처럼 보입니다.<br>\n하지만 실제로는 <code class=\"language-text\">df</code> 내용도 변경되어 있으며 <code class=\"language-text\">SettingWithCopyWarning</code> 경고 문구가 나타납니다.\n<code class=\"language-text\">ChainedIndexing</code>을 사용한 다른 예시도 확인해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df<span class=\"token punctuation\">[</span>df<span class=\"token punctuation\">[</span><span class=\"token string\">\"student_id\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">></span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"grades\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"F\"</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>df<span class=\"token punctuation\">)</span>\n\n   student_id grade\n<span class=\"token number\">0</span>           <span class=\"token number\">1</span>     E\n<span class=\"token number\">1</span>           <span class=\"token number\">2</span>     C\n<span class=\"token number\">2</span>           <span class=\"token number\">3</span>     D</code></pre></div>\n<p>이번에도 <code class=\"language-text\">SettingWithCopyWarning</code> 경고 문구가 나타나며 <code class=\"language-text\">df</code>에는 어떠한 변화도 없는 것을 확인할 수 있습니다.\n이러한 문제가 발생하는 <strong>원인은 Pandas, Numpy가 내부적으로 view 또는 copy를 반환하는 방식</strong>에서 찾아볼 수 있습니다.</p>\n<p><strong>Views and Copies</strong><br></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n\norigin <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nview <span class=\"token operator\">=</span> origin<span class=\"token punctuation\">.</span>view<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ncopy <span class=\"token operator\">=</span> origin<span class=\"token punctuation\">.</span>copy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\narr<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>origin<span class=\"token punctuation\">)</span>\narray<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>view<span class=\"token punctuation\">)</span>\narray<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>copy<span class=\"token punctuation\">)</span>\narray<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">9</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>위 코드 결과를 보면 <code class=\"language-text\">origin</code>, <code class=\"language-text\">view</code>는 변경된 값으로 반영되어 있지만 <code class=\"language-text\">copy</code>는 반영안되어 있는 것을 확인할 수 있습니다. <strong>view는 자체적으로 데이터가 없는 numpy 배열</strong> 입니다. 반면에 <strong>copy는 원본 배열의 요소를 새 배열에 복사하여 전체 복사본의 데이터</strong>를 가지고 있습니다.</p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 44.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAASCAAAAAAMdMN6AAABG0lEQVQoz5XSy1LEQAgFUP//A11pqTWWmqQz/QAaGjrgxtFVqpy7Pgvg8hD/zMM98OjEQ2aEcmeRiFBEFBAiBkLh+QNZ8rJr1a+VU8IGsl0I84655AU2SEVusO9vH4xzTbAsS+11/2QquUJtuVG7lvEDfQiReMQcakOC4xhDRhcewsLcj5NlyE+WmSTcUSOYEYiizRM4Jl3qTPD8JOvSCK/HCZTev6qgwdbSlkiPszu6mqlGxCEsOu9qxt3DPdzd/Q8adhldI4A7dfIIwVYpY4NWW0HS24yzvaxe5OWVPz8K7fX9cXDeIENZOOFWbwcXpHVjCrlSue5kPlLHypmBoI0K8NuMzmkWEYfp0BkRrmqmZqZqZur3vtm/8g0Krb/xf4FbzAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"view-copy\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/RKHHbP0caT2iSgCohNwSj/a66eab638f2a77b5f452ccabfc866a67/view-copy.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/RKHHbP0caT2iSgCohNwSj/a66eab638f2a77b5f452ccabfc866a67/view-copy.png?w=240 240w,\nhttps://images.ctfassets.net/tushy4jlcik7/RKHHbP0caT2iSgCohNwSj/a66eab638f2a77b5f452ccabfc866a67/view-copy.png?w=480 480w,\nhttps://images.ctfassets.net/tushy4jlcik7/RKHHbP0caT2iSgCohNwSj/a66eab638f2a77b5f452ccabfc866a67/view-copy.png?w=960 960w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>이처럼 view, copy에 따라 원본 객체인지 아닌지 달라지며 이는 일관된 동작을 보장하지 못하게 됩니다.<br>\n결국 <code class=\"language-text\">SettingWithCopyWarning</code>은 코드에서 사용자가 의도하지 않은 동작이 발생할 가능성이 있음을 경고하는 warning 입니다. 이 문제를 해결하기 위해 Pandas 2.0에 <code class=\"language-text\">Copy-on-Write</code>가 추가되었습니다.</p>\n<p><br><br></p>\n<h2 id=\"pandas-copy-on-write\" style=\"position:relative;\"><a href=\"#pandas-copy-on-write\" aria-label=\"pandas copy on write permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pandas Copy-on-Write</h2>\n<p>Pandas Copy-on-Write는 <strong>다른 DataFrame으로부터 생성된 모든 DataFrame이 항상 복사본으로 동작하도록 보장</strong>합니다. 다시 말해, 더 이상 단일 연산으로 두 가지 이상의 객체가 수정될 수 없습니다. (ex. 처음 예시에서 grade만 변경되고 df는 변경되지 않음)</p>\n<p>이를 구현하기 위한 가장 쉬운 방법은 항상 데이터를 복사하는 방법입니다.<br>\n하지만 적용 시 성능이 크게 떨어지기 때문에 다른 방식을 적용해야 했습니다.</p>\n<p><strong>BlockValuesRefs</strong><br>\n불필요한 복사를 방지하려면 복사를 트리거할 시기를 정확히 알아야 합니다.<br>\n결국 DataFrame 데이터가 다른 DataFrame과 공유되는 경우에만 복사를 트리거해야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df <span class=\"token operator\">=</span> pd<span class=\"token punctuation\">.</span>DataFrame<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\ndf2 <span class=\"token operator\">=</span> df<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p>위 코드에서는 <code class=\"language-text\">df</code>와 df의 view 객체인 <code class=\"language-text\">df2</code>를 생성합니다.<br>\n현재 <code class=\"language-text\">df</code>와 <code class=\"language-text\">df2</code>는 동일한 numpy 배열을 참조하고 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df<span class=\"token punctuation\">.</span>iloc<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">100</span></code></pre></div>\n<p>코드를 통해 둘 중 하나가 수정되는 경우, 복사가 트리거됩니다.<br>\n이 때 다른 Pandas 객체가 참조하고 있는지를 추적해야 합니다.<br>\n이를 위해 <code class=\"language-text\">BlockValuesRefs</code>가 추가되었습니다.</p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 29.48453608247423%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAMCAAAAAA1qKCRAAAAiklEQVQY053RwQ7CIAwG4L3/A7qDF6Mmm1lApBRoKdvY9CYa9E96ab7QpnRLY7p/oZ4aoQ9NMG3h7/BxHW4RNYJC2RsSiSjmNxitQwKLWKoIuo8zusShOjqry3AeNWcR8cYf+ynFKhRrwBij5lwSoD+c6AP05a0MTwhslaP66IX3vPbg7QLzzz+zAtRU2T+Pwn2fAAAAOHRFWHRpY2M6Y29weXJpZ2h0AENvcHlyaWdodCAoYykgMTk5OCBIZXdsZXR0LVBhY2thcmQgQ29tcGFueflXeTcAAAAhdEVYdGljYzpkZXNjcmlwdGlvbgBzUkdCIElFQzYxOTY2LTIuMVet2kcAAAAmdEVYdGljYzptYW51ZmFjdHVyZXIASUVDIGh0dHA6Ly93d3cuaWVjLmNoHH8ATAAAADd0RVh0aWNjOm1vZGVsAElFQyA2MTk2Ni0yLjEgRGVmYXVsdCBSR0IgY29sb3VyIHNwYWNlIC0gc1JHQkRTSKkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"ref1\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/2D9OCQfiqBrPnFVvYCKhpd/dc7eedf889af33d58efa757176b0e380/ref1.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/2D9OCQfiqBrPnFVvYCKhpd/dc7eedf889af33d58efa757176b0e380/ref1.png?w=243 243w,\nhttps://images.ctfassets.net/tushy4jlcik7/2D9OCQfiqBrPnFVvYCKhpd/dc7eedf889af33d58efa757176b0e380/ref1.png?w=485 485w,\nhttps://images.ctfassets.net/tushy4jlcik7/2D9OCQfiqBrPnFVvYCKhpd/dc7eedf889af33d58efa757176b0e380/ref1.png?w=970 970w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p><code class=\"language-text\">BlockValuesRefs</code>는 numpy 배열을 감싸고 이 참조를 내부적으로 저장하는 블록을 가리키는 <code class=\"language-text\">weakref</code>를 생성합니다.\n위의 예시와 같이 동일한 타입의 <code class=\"language-text\">a</code>, <code class=\"language-text\">b</code> 컬럼은 BlockManager를 통해 하나의 블록에 존재합니다.\n그리고 블록에 대해 <code class=\"language-text\">weakref</code>를 가지는 Block Reference Tracker가 추가됩니다.<br>\n이제 다음 예시에서 새로운 블록을 추가해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df2 <span class=\"token operator\">=</span> df<span class=\"token punctuation\">.</span>reset_index<span class=\"token punctuation\">(</span>drop<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 53.276955602537%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAVCAAAAAARcfPCAAAA6klEQVQoz42SUW/DIAyE+///3rTtaa0mdU2WBpqE2MEGnMKyTm1Gk9wDQuhDhrvbjRu1+9vZciuoN4JJ3jvnnSyCXVmdCS5gFNB0wlHE/0DQbUumReh6kxB7stwPvg+50aJP5bFSGB/guKLvt0+yWTC0qtF1UwcRGS3tX9/1ExAlBLGFC1EIQ60YsuBIDB3//gU/cHDs8vZEN+F2B9jnffSY1mI/GTLgI3cHFi9pjMNp7pybJxP0USIBds49JFPHZEyjwAJxeBrhXTKKWZZLkZL5qpTJ1SKTjD7IWs0CxkSE7Hof6UeyDi7oCivaO5xj5XBWAAAAOHRFWHRpY2M6Y29weXJpZ2h0AENvcHlyaWdodCAoYykgMTk5OCBIZXdsZXR0LVBhY2thcmQgQ29tcGFueflXeTcAAAAhdEVYdGljYzpkZXNjcmlwdGlvbgBzUkdCIElFQzYxOTY2LTIuMVet2kcAAAAmdEVYdGljYzptYW51ZmFjdHVyZXIASUVDIGh0dHA6Ly93d3cuaWVjLmNoHH8ATAAAADd0RVh0aWNjOm1vZGVsAElFQyA2MTk2Ni0yLjEgRGVmYXVsdCBSR0IgY29sb3VyIHNwYWNlIC0gc1JHQkRTSKkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"ref2\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/4239ZGl27LRzj0fIxiW2Ut/149499a3ad41a0c2635bdd04fd9e9006/ref2.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/4239ZGl27LRzj0fIxiW2Ut/149499a3ad41a0c2635bdd04fd9e9006/ref2.png?w=237 237w,\nhttps://images.ctfassets.net/tushy4jlcik7/4239ZGl27LRzj0fIxiW2Ut/149499a3ad41a0c2635bdd04fd9e9006/ref2.png?w=473 473w,\nhttps://images.ctfassets.net/tushy4jlcik7/4239ZGl27LRzj0fIxiW2Ut/149499a3ad41a0c2635bdd04fd9e9006/ref2.png?w=946 946w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p><code class=\"language-text\">BlockValuesRefs</code>는 이제 <code class=\"language-text\">df</code>를 위한 블록과 <code class=\"language-text\">df2</code>를 위해 새로 생성된 블록을 가리킵니다.\n이를 통해 동일한 메모리를 가리키는 모든 DataFrame을 항상 인식할 수 있습니다.\n동일한 numpy 배열을 가리키는 블록이 몇 개 남아 있는지 참조 추적 객체를 통해 알아낼 수 있습니다.\n이러한 과정을 통해 <strong>둘 중 하나가 내부에서 수정되면 내부적으로 복사본을 트리거</strong>할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df2<span class=\"token punctuation\">.</span>iloc<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">100</span></code></pre></div>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 46.99646643109541%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAATCAAAAADHKBDfAAAAw0lEQVQoz52Sy24CMQxF+f/fY8OuUDQdzVAESRzHz2kt2HRBRNS7iqUjWz7O7mcwuz/vbRDM62jHwdFSgKhAKfQo3dzsJYjrd8Fcg9RIKgxM0hsN8zytyVQt1eWwSBdEQKgXdHel+XDqd2zMwtlClGMrtWl36y3yVs/mgx6X4/gJXVXU3oAwzbd2h3zHR0mxFvkr0FmsppwhEREvpa2ofeHn6fPrKuGR8WN/bH2PFswV48rS8vnCXVA48rTMIsLbP77ZL3aG7fHkwXDEAAAAOHRFWHRpY2M6Y29weXJpZ2h0AENvcHlyaWdodCAoYykgMTk5OCBIZXdsZXR0LVBhY2thcmQgQ29tcGFueflXeTcAAAAhdEVYdGljYzpkZXNjcmlwdGlvbgBzUkdCIElFQzYxOTY2LTIuMVet2kcAAAAmdEVYdGljYzptYW51ZmFjdHVyZXIASUVDIGh0dHA6Ly93d3cuaWVjLmNoHH8ATAAAADd0RVh0aWNjOm1vZGVsAElFQyA2MTk2Ni0yLjEgRGVmYXVsdCBSR0IgY29sb3VyIHNwYWNlIC0gc1JHQkRTSKkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"ref3\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/2KJYLOXOASBuJ8ixTCW5pE/ec5eb23be8f4a9289113ce8f2970269b/ref3.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/2KJYLOXOASBuJ8ixTCW5pE/ec5eb23be8f4a9289113ce8f2970269b/ref3.png?w=283 283w,\nhttps://images.ctfassets.net/tushy4jlcik7/2KJYLOXOASBuJ8ixTCW5pE/ec5eb23be8f4a9289113ce8f2970269b/ref3.png?w=566 566w,\nhttps://images.ctfassets.net/tushy4jlcik7/2KJYLOXOASBuJ8ixTCW5pE/ec5eb23be8f4a9289113ce8f2970269b/ref3.png?w=1132 1132w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>이제 <code class=\"language-text\">df2</code>의 블록은 전체 복사를 통해 복사되어 자체 데이터와 <code class=\"language-text\">BlockValuesRefs</code>가 있는 새로운 블록을 생성합니다. <code class=\"language-text\">df</code>와 <code class=\"language-text\">df2</code>는 더 이상 메모리를 공유하지 않습니다.<br>\n이해를 위해 몇 가지 상황을 더 살펴보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span>\ndf2<span class=\"token punctuation\">.</span>iloc<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">100</span></code></pre></div>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAUCAAAAADaLSBnAAAA8UlEQVQoz43STW/DIAwG4P7/vzdpx0ltkpZpSYggYBt/9TBpW7Wg9j358MgGw8lfzOm3VH5MF0L9qO071KgV60FUtD/BLgRsxGXfc4YfaEcwny9jzsu+xSwisidExHI0Wsw4LsscY60VbjcZJybtwGUMQ1ibqkKd394/8QiqGVcVkbAzc0k0B6h2cBlAwpTnLRcionpdgFs7OKOpqaqs1VREJWPrrMf1i93turq7eyXu7dHbmdx9F3e3Qv0ndDU1wClC09K4/ynaMEylxJpS+u8eOrq7bjHGtLH4E2jrEC5hAH8GFcxMkz+FTkRE/ALs5g4s2hOdSXdY1QAAADh0RVh0aWNjOmNvcHlyaWdodABDb3B5cmlnaHQgKGMpIDE5OTggSGV3bGV0dC1QYWNrYXJkIENvbXBhbnn5V3k3AAAAIXRFWHRpY2M6ZGVzY3JpcHRpb24Ac1JHQiBJRUM2MTk2Ni0yLjFXrdpHAAAAJnRFWHRpY2M6bWFudWZhY3R1cmVyAElFQyBodHRwOi8vd3d3LmllYy5jaBx/AEwAAAA3dEVYdGljYzptb2RlbABJRUMgNjE5NjYtMi4xIERlZmF1bHQgUkdCIGNvbG91ciBzcGFjZSAtIHNSR0JEU0ipAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"ref4\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/59lcqpTQ7nXgJwhI2HjJq8/8ca826f0fe02648afe9c3a01323eaeee/ref4.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/59lcqpTQ7nXgJwhI2HjJq8/8ca826f0fe02648afe9c3a01323eaeee/ref4.png?w=265 265w,\nhttps://images.ctfassets.net/tushy4jlcik7/59lcqpTQ7nXgJwhI2HjJq8/8ca826f0fe02648afe9c3a01323eaeee/ref4.png?w=530 530w,\nhttps://images.ctfassets.net/tushy4jlcik7/59lcqpTQ7nXgJwhI2HjJq8/8ca826f0fe02648afe9c3a01323eaeee/ref4.png?w=1060 1060w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>이 경우에는 <code class=\"language-text\">df2</code>를 수정하기 전 <code class=\"language-text\">df</code>가 <code class=\"language-text\">None</code>이 됩니다.\n결국 <code class=\"language-text\">df</code> <code class=\"language-text\">BlockValuesRefs</code>의 <code class=\"language-text\">weakref</code>는 None으로 평가되며, 이를 통해 복사를 실행하지 않아도 <code class=\"language-text\">df2</code>를 수정할 수 있습니다.\n마지막으로 <code class=\"language-text\">BlockValuesRefs</code> 객체는 복사를 트리거하지 않고 하나의 DataFrame만 가리키면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df2 <span class=\"token operator\">=</span> df<span class=\"token punctuation\">.</span>copy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 50.67437379576107%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAUCAAAAADaLSBnAAAA20lEQVQoz53Su27DMAxA0fz/57VLp6KNA9vxS5YViQ+JZIZ0jGKnHIULCDzgyQ7O6R/hMB8MRY+FmahQjLcQy+NBVfVZODWtAx+ii6giCoEAMVWWics8OhcJka4hffcClTAN/dDNm5lawebzy2ElhKKicC2lCEccR6p9XZi2zH/Lcc5cquDkddfRrWbmf2A37CczU78LLqLKEM4J5HU4/F5m8CEtkUzVOCIiVMHXddn8DRGp26gZtQYe20vbjIuICMP54wW4qBpOIiKcoOur4BmJCB+STMyU37/wOyR0FDjBhtYmAAAAOHRFWHRpY2M6Y29weXJpZ2h0AENvcHlyaWdodCAoYykgMTk5OCBIZXdsZXR0LVBhY2thcmQgQ29tcGFueflXeTcAAAAhdEVYdGljYzpkZXNjcmlwdGlvbgBzUkdCIElFQzYxOTY2LTIuMVet2kcAAAAmdEVYdGljYzptYW51ZmFjdHVyZXIASUVDIGh0dHA6Ly93d3cuaWVjLmNoHH8ATAAAADd0RVh0aWNjOm1vZGVsAElFQyA2MTk2Ni0yLjEgRGVmYXVsdCBSR0IgY29sb3VyIHNwYWNlIC0gc1JHQkRTSKkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"ref5\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/46iwHfm29GfeSWfKvX58fz/ac17e591224ce0112dbf2f63468c985a/ref5.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/46iwHfm29GfeSWfKvX58fz/ac17e591224ce0112dbf2f63468c985a/ref5.png?w=260 260w,\nhttps://images.ctfassets.net/tushy4jlcik7/46iwHfm29GfeSWfKvX58fz/ac17e591224ce0112dbf2f63468c985a/ref5.png?w=519 519w,\nhttps://images.ctfassets.net/tushy4jlcik7/46iwHfm29GfeSWfKvX58fz/ac17e591224ce0112dbf2f63468c985a/ref5.png?w=1038 1038w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p><code class=\"language-text\">copy</code>를 실행하는 경우는 간단합니다. DataFrame <code class=\"language-text\">df2</code>에 대한 새로운 <code class=\"language-text\">BlockValuesRefs</code>가 즉시 생성되며 데이터를 공유하지 않습니다.</p>\n<br>\n<p><strong>Optimizing inplace copies</strong><br>\n앞서 복사를 트리거하는 시점에 대해 알아보았습니다.<br>\n이번에는 복사본을 최대한 효율적으로 생성하는 방법에 대해 알아보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">df<span class=\"token punctuation\">.</span>iloc<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">100</span></code></pre></div>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 33.489618218352305%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAANCAAAAAD+9HM0AAAAyElEQVQoz43RsXLDIAwG4Lz/y3Xolq1LY9/ZJgUhgUD6O8RNfLhDNP73IZC44M26ACj5nIufoVNWCpmL5JDqnieHw93dAd+hxcRxy1mEtrg3p/VHwkwkktaZ+n410AxY5rkD5QFVKlPizEwpUntCLaokolrl+agKbNM03Rr6qyPMjJp0s9cMRZtmrVWbHCAAtbsex/Rudjfu1g1HqPSdyrgkReiHPT6y5XMaoYSw8gg70yIjvH58yQhhKONvlHSL5QT/KXf43+FfaSL/sGtmZeIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"ref6\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/3fJ8S8VGWGaCkq06jPf8zB/835a17c800496fb37b83b3a434f60083/ref6.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/3fJ8S8VGWGaCkq06jPf8zB/835a17c800496fb37b83b3a434f60083/ref6.png?w=373 373w,\nhttps://images.ctfassets.net/tushy4jlcik7/3fJ8S8VGWGaCkq06jPf8zB/835a17c800496fb37b83b3a434f60083/ref6.png?w=747 747w,\nhttps://images.ctfassets.net/tushy4jlcik7/3fJ8S8VGWGaCkq06jPf8zB/835a17c800496fb37b83b3a434f60083/ref6.png?w=1493 1493w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>위 예시는 DataFrame에 n개의 정수 컬럼이 있으며 모두 하나의 블록으로 통합되어 있습니다.\n다른 블록에서도 DataFrame을 참조하고 있기 때문에 하나의 값을 수정하기 위해 전체 블록을 복사해야 하는 상황입니다.\n이 방식은 위 그림과 같이 복사할 필요가 없는 n-1개의 컬럼을 복사해야 합니다.\nCoW에서는 이러한 상황을 최적화하기 위해 <code class=\"language-text\">Block Splitting</code>을 추가했습니다.</p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 48.84135472370767%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAUCAAAAADaLSBnAAAA20lEQVQoz6XSy1LDMAwF0P7/17Fg2EFb2jKljV2a2HpZymUBO5IQBm3kxRnNyLobrKzN32E7jCsnOhAR7hHh7l99ArbLNQudE9d0KsXESn1L1H7CKIWk5H7o75mqidWa+mLTy+jz7rhnANzlVAG0Ng1b3R7VAHD66AoAn4PDQFRMzcibmRrNQNyGsbp76CVEwt3nPjwA+n40W7iMs+rJACi3fF2AfM+5MOAiWczmoe4fns4KBG8fD9LmocjrjgVwTS/vSxNNhEWBkUlu3bgmZg6hVXkMRPw7uL/UJ47PFPx7Y3ZiAAAAOHRFWHRpY2M6Y29weXJpZ2h0AENvcHlyaWdodCAoYykgMTk5OCBIZXdsZXR0LVBhY2thcmQgQ29tcGFueflXeTcAAAAhdEVYdGljYzpkZXNjcmlwdGlvbgBzUkdCIElFQzYxOTY2LTIuMVet2kcAAAAmdEVYdGljYzptYW51ZmFjdHVyZXIASUVDIGh0dHA6Ly93d3cuaWVjLmNoHH8ATAAAADd0RVh0aWNjOm1vZGVsAElFQyA2MTk2Ni0yLjEgRGVmYXVsdCBSR0IgY29sb3VyIHNwYWNlIC0gc1JHQkRTSKkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"ref7\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/3hAt9dVwj7X0HOcRNPPKsR/8827b8e9237d7982ba4dd37b31dc596d/ref7.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/3hAt9dVwj7X0HOcRNPPKsR/8827b8e9237d7982ba4dd37b31dc596d/ref7.png?w=281 281w,\nhttps://images.ctfassets.net/tushy4jlcik7/3hAt9dVwj7X0HOcRNPPKsR/8827b8e9237d7982ba4dd37b31dc596d/ref7.png?w=561 561w,\nhttps://images.ctfassets.net/tushy4jlcik7/3hAt9dVwj7X0HOcRNPPKsR/8827b8e9237d7982ba4dd37b31dc596d/ref7.png?w=1122 1122w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>위 그림과 같이 <code class=\"language-text\">Block Splitting</code>을 통해 분할되어 내부적으로 첫 번째 컬럼만 복사됩니다.\n다른 모든 컬럼은 이전 배열의 view로 간주되며 새로운 블록은 다른 열과 참조를 공유하지 않습니다.\n이전 블록은 view일 뿐이므로 그대로 다른 객체와 참조를 공유합니다.\n<strong>이 방식은 불필요한 복사를 방지할 수 있지만 이전 블록에 대한 정보에 새로운 블록까지 추가하므로 더 많은 메모리를 사용한다는 단점</strong>이 있습니다.</p>\n<p><br><br></p>\n<h2 id=\"pandas-copy-on-write-mode\" style=\"position:relative;\"><a href=\"#pandas-copy-on-write-mode\" aria-label=\"pandas copy on write mode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Pandas Copy-on-Write Mode</h2>\n<p>Pandas CoW를 통해 <strong>복사에 대한 지연, 최적화를 통해 빠른 성능</strong>을 얻을 수 있으며\n<strong>DataFrame의 일관된 동작을 보장</strong>할 수 있습니다.\n2.0 버전의 경우, 간단한 설정만 추가하면 <code class=\"language-text\">Copy-on-Write</code> 모드를 사용할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">pd<span class=\"token punctuation\">.</span>options<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">.</span>copy_on_write <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></code></pre></div>\n<p>간단한 체이닝 연산을 통해 수행 시간의 차이를 확인해보면 다음과 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token operator\">%</span><span class=\"token operator\">%</span>timeit\n<span class=\"token punctuation\">(</span>\n    df<span class=\"token punctuation\">.</span>rename<span class=\"token punctuation\">(</span>columns<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"col_1\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"new_index\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>assign<span class=\"token punctuation\">(</span>sum_val<span class=\"token operator\">=</span>df<span class=\"token punctuation\">[</span><span class=\"token string\">\"col_1\"</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">+</span> df<span class=\"token punctuation\">[</span><span class=\"token string\">\"col_2\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>drop<span class=\"token punctuation\">(</span>columns<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"col_10\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"col_20\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>astype<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"col_5\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"int32\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>reset_index<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span>set_index<span class=\"token punctuation\">(</span><span class=\"token string\">\"new_index\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># without CoW</span>\n<span class=\"token number\">2.45</span> s ± <span class=\"token number\">293</span> ms per loop <span class=\"token punctuation\">(</span>mean ± std<span class=\"token punctuation\">.</span> dev<span class=\"token punctuation\">.</span> of <span class=\"token number\">7</span> runs<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span> loop each<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># with CoW</span>\n<span class=\"token number\">13.7</span> ms ± <span class=\"token number\">286</span> µs per loop <span class=\"token punctuation\">(</span>mean ± std<span class=\"token punctuation\">.</span> dev<span class=\"token punctuation\">.</span> of <span class=\"token number\">7</span> runs<span class=\"token punctuation\">,</span> <span class=\"token number\">100</span> loops each<span class=\"token punctuation\">)</span></code></pre></div>\n<p>위 예시에서는 대략 200배 정도 개선되었지만 연산에 따라 결과는 다를 수 있습니다.<br>\n특히 <code class=\"language-text\">drop(axis=1)</code>, <code class=\"language-text\">rename()</code>과 같은 연산에서 큰 성능 향상을 확인하실 수 있습니다.</p>\n<p><br><br></p>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://realpython.com/pandas-settingwithcopywarning/\">https://realpython.com/pandas-settingwithcopywarning/</a></li>\n<li><a href=\"https://pandas.pydata.org/docs/user_guide/copy_on_write.html\">https://pandas.pydata.org/docs/user_guide/copy_on_write.html</a></li>\n<li><a href=\"https://pandas.pydata.org/pdeps/0007-copy-on-write.html\">https://pandas.pydata.org/pdeps/0007-copy-on-write.html</a></li>\n<li><a href=\"https://phofl.github.io/cow-deep-dive.html\">https://phofl.github.io/cow-deep-dive.html</a></li>\n</ul>","excerpt":"Pandas 2.0 버전부터 가 추가되었으며 3.0 버전부터 기본 값이 활성화로 변경됩니다. 이번 글에서는 Pandas Copy-on-Write가 Pandas가 가진 문제를 어떻게 해결하는지에 대해 알아보겠습니다. Pandas DataFrame Pandas SettingWithCopyWarning Pandas Copy-on-Write Pandas Copy-on-Write Mode Pandas DataFrame Pandas CoW에 대해 알아보기 이전에 먼저 DataFrame의 내부 구조에 대한 이해가 필요합니다. 은 Pandas의 행, 열 기반…"}}}},"pageContext":{"slug":"pandas-2-0-copy-on-write","basePath":"","prev":{"slug":"llm-dataplatform","publishDate":"2024-01-21"},"next":{"slug":"spark-on-kubernetes-scheduler-2","publishDate":"2023-12-10"}}},"staticQueryHashes":["1946181227","2744905544","3732430097"]}