{"componentChunkName":"component---src-templates-post-js","path":"/airflow-multi-tenent-1/","result":{"data":{"contentfulPost":{"title":"여러 조직이 함께 사용하는 Airflow 만들기","slug":"airflow-multi-tenent-1","metaDescription":null,"publishDate":"August 15, 2021","publishDateISO":"2021-08-15","tags":[{"title":"DataEngineering","id":"25d7d0d6-3cf7-5e19-a5cb-9c3fa926046f","slug":"dataengineering"}],"heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAlgCWAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiExYeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgtxW9EylQu8nTotmo+gHfAEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":6,"html":"<p>사내 데이터가 다양해지고 사용자가 많아지면 접근 제어와 권한 등 다양한 고민이 생기게 됩니다.\n이 글에서는 여러 조직이 함께 사용하는 Airflow를 만들 때 알아두면 좋은 내용들에 대해 정리해보려고 합니다.</p>\n<ul>\n<li><a href=\"https://swalloow.github.io/airflow-multi-tenent-1/#airflow-rbac\">Airflow RBAC</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-multi-tenent-1/#dag-level-permissions\">DAG-Level Permissions</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-multi-tenent-1/#connection-variable-access-control\">Connection, Variable Permissions</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-multi-tenent-1/#cluster-policy\">Cluster Policy</a></li>\n</ul>\n<br>\n<h2 id=\"접근-제어가-필요한-경우\" style=\"position:relative;\"><a href=\"#%EC%A0%91%EA%B7%BC-%EC%A0%9C%EC%96%B4%EA%B0%80-%ED%95%84%EC%9A%94%ED%95%9C-%EA%B2%BD%EC%9A%B0\" aria-label=\"접근 제어가 필요한 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>접근 제어가 필요한 경우</h2>\n<p>먼저 접근 제어는 모든 조직에 필요한 내용은 아닙니다. 다만 아래와 같은 경우에는 필요할 수 있습니다.</p>\n<ul>\n<li>다른 사람이 실행, 중지 권한을 가져서는 안될 만큼 중요한 DAG이 존재하는 경우</li>\n<li>민감한 데이터를 다루는 DAG이 존재하는 경우 (HR, 매출 데이터 등)</li>\n<li>팀에서 운영하는 DAG, Connection, Variable을 우리 팀만 보고 싶은 경우</li>\n</ul>\n<p>특히 Airflow Connections, Variable에는 DB 또는 클러스터 접속 정보, API키 등 민감한 정보가 많이 저장됩니다. 물론 마스킹 기능을 통해 UI에서 볼 수 없게 만들 수 있지만 id는 볼 수 있기 때문에 쉽게 값을 가져올 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> airflow<span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> Variable\n<span class=\"token keyword\">from</span> airflow<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">.</span>base_hook <span class=\"token keyword\">import</span> BaseHook\n\nvariable <span class=\"token operator\">=</span> Variable<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"myvar\"</span><span class=\"token punctuation\">)</span>\nconnection <span class=\"token operator\">=</span> BaseHook<span class=\"token punctuation\">.</span>get_connection<span class=\"token punctuation\">(</span><span class=\"token string\">\"myconn\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<p>이 문제를 해결하기 위한 방법으로 조직마다 Airflow 환경을 분리하는 방법이 있습니다.\n하지만 이 방법은 운영과 모니터링이 힘들 수 있어 프라이빗 클라우드를 운영해야하는 상황이 아니라면 추천하지 않습니다. 두 번째 방법은 <strong>Airflow의 RBAC 기능</strong>을 활용하는 방법 입니다.</p>\n<br>\n<h2 id=\"airflow-rbac\" style=\"position:relative;\"><a href=\"#airflow-rbac\" aria-label=\"airflow rbac permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow RBAC</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 26.629834254143645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAALCAQAAACnzwd+AAAACXBIWXMAAA9hAAAPYQGoP6dpAAAAB3RJTUUH6AMfBickm1IkUAAAATZJREFUKM+lkj1PwlAYhR8KqGmrEioJRIwSB2cHZ0f/gbtOTk5OOjm5uLk4GTd/ADHGUeMvMNHEEAOopAXFj7S0KA2vQ1FKgos9d7n3ybknb869EFHVbUfs31U3lUhpY2junEaCFh6goxrRAhO42ieMoJEgHqDSmmr0HY2zxRu4XZ5c6jPnbqEIVzOFVWI/zG/vHh75CNIt2Y0g28fGtXAkrPoewFsxzD6uAR43BoxyPAtow4YGoEwGHail0Ym/j6cACyEHdJJk8O6NPE+0gS5ZJjjP0UT5M7DQO06/4kDKBsj2WLLDM8w3IR+6uGKeOEMnNNcHOwQw992LcIcA1VNlK9zhZS3YVTbTO32vZ0V6ZHRiDwcivnhiiy8i9le0b+OjtkYBLF5wwx3+U21QKw4wFZSD2/wG6NCb2GjgR5cAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"airflow-rbac\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/013LcVaNqjXcpl8koBPKo6/a98b75aadeef40c7b09bc083cc61f2ec/airflow-rbac.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/013LcVaNqjXcpl8koBPKo6/a98b75aadeef40c7b09bc083cc61f2ec/airflow-rbac.png?w=226 226w,\nhttps://images.ctfassets.net/tushy4jlcik7/013LcVaNqjXcpl8koBPKo6/a98b75aadeef40c7b09bc083cc61f2ec/airflow-rbac.png?w=453 453w,\nhttps://images.ctfassets.net/tushy4jlcik7/013LcVaNqjXcpl8koBPKo6/a98b75aadeef40c7b09bc083cc61f2ec/airflow-rbac.png?w=905 905w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>Airflow RBAC은 1.10 버전부터 추가되었고 2.0 버전부터 기본 설정으로 제공됩니다.\nAirflow의 Security Model은 위의 그림과 같은 구조를 따르고 있습니다.\n사용자는 User, Role로 구성되어 있습니다. 여기서 User는 하나 이상의 Role을 가질 수 있습니다.</p>\n<p>접근 권한은 <strong>Permission, ViewMenu</strong> 그리고 이를 조합한 <strong>PermissionView</strong>로 구성되어 있습니다.\nRole은 여러 개의 Permission을 가질 수 있습니다. PermissionView에 대한 예시는 아래와 같습니다.</p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 42.29950319375443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"permissionview\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/09unii6nTbCJk4DK7VK32/2f2b05f6317b7bf671437738d1f22b95/permissionview.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/09unii6nTbCJk4DK7VK32/2f2b05f6317b7bf671437738d1f22b95/permissionview.png?w=705 705w,\nhttps://images.ctfassets.net/tushy4jlcik7/09unii6nTbCJk4DK7VK32/2f2b05f6317b7bf671437738d1f22b95/permissionview.png?w=1409 1409w,\nhttps://images.ctfassets.net/tushy4jlcik7/09unii6nTbCJk4DK7VK32/2f2b05f6317b7bf671437738d1f22b95/permissionview.png?w=2818 2818w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>Connections <strong>ViewMenu</strong> 와 can_edit <strong>Permission</strong> 을 조합하면 <code class=\"language-text\">can edit on Connections</code>라는 <strong>PermissionView</strong> 가 생성됩니다. 이 권한을 가진 사용자만 Connections UI에서 편집을 할 수 있습니다. 이러한 방식을 Airflow에서는 <strong>Resource-Based permissions</strong>라고 정의하고 있습니다.</p>\n<p>Airflow에는 다양한 리소스에 대해 권한이 이미 정의되어 있고, 기본적으로 Admin을 포함한 5개의 Role을 제공합니다. 조직마다 다른 Role을 가지고 싶은 경우, BaseRole을 정의하고 Copy Role을 통해 새로 만들면 편하게 운영할 수 있습니다.</p>\n<p>리소스 기반의 권한 제어도 필요하지만 이 기능에서는 DAGs 라는 단일 리소스로 보고 있기 때문에 DAG 단위로 접근 제어를 할 수 없습니다. 이를 지원하기 위해 2.0+ 버전부터 <strong>DAG-level Permission</strong>이 추가되었습니다.</p>\n<br>\n<h2 id=\"dag-level-permissions\" style=\"position:relative;\"><a href=\"#dag-level-permissions\" aria-label=\"dag level permissions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DAG-level Permissions</h2>\n<p>DAG-level Permission을 사용하면 다음과 같은 접근 제어를 할 수 있습니다.</p>\n<ul>\n<li>A 사용자는 A 사용자의 DAG만 볼 수 있음</li>\n<li>A 사용자는 B 사용자의 DAG을 볼 수 없음</li>\n<li>B 사용자가 A 사용자에게 권한을 부여하면 볼 수 있음</li>\n</ul>\n<p>DAG-level Permission은 앞서 얘기했던 리소스 기반 접근 제어에 <code class=\"language-text\">DAG:dag_id</code>라는 리소스를 추가하는 방식으로 구현되었습니다. 예를 들어 A 사용자와 B 사용자에게 example DAG에 대한 읽기 권한을 부여하고 싶은 경우, <code class=\"language-text\">DAG:example.can_read</code>라는 권한을 추가해주어야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">with</span> DAG<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"example_dag\"</span><span class=\"token punctuation\">,</span>\n    default_args<span class=\"token operator\">=</span>default_args<span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string\">\"example dags\"</span><span class=\"token punctuation\">,</span>\n    schedule_interval<span class=\"token operator\">=</span><span class=\"token string\">\"@once\"</span><span class=\"token punctuation\">,</span>\n    access_control<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"myrole\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"can_dag_read\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    start_date<span class=\"token operator\">=</span>days_ago<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> dag<span class=\"token punctuation\">:</span></code></pre></div>\n<p>위와 같이 DAG을 정의하는 단계에서도 <code class=\"language-text\">access_control</code> 파라메터를 통해 DAG의 접근 권한을 정의해주어야 합니다. 이후 BaseRole에 DAGs 리소스 접근 권한을 제거하면 사용자는 오직 허용된 DAG에 대해서만 접근할 수 있게 됩니다.</p>\n<p>DAG access_control이 변경될 때마다 Role에 권한을 추가하는 일은 보통 번거로운 일이 아닙니다. 이를 위해 Airflow에서는 <code class=\"language-text\">airflow sync-perm</code> 이라는 명령어를 제공합니다. 해당 명령어를 실행하면 모든 DAG에 정의된 권한이 연관된 Role에 반영됩니다. Permission Sync 사이드카 컨테이너를 webserver에 배포하면 이 과정을 자동화할 수 있습니다. 관련 내용은 <a href=\"https://swalloow.github.io/airflow-sidecar/#2-permission-sync-container\">사이드카 컨테이너로 Airflow 기능 확장하기</a> 글을 참고해주시면 됩니다.</p>\n<br>\n<h2 id=\"connection-variable-access-control\" style=\"position:relative;\"><a href=\"#connection-variable-access-control\" aria-label=\"connection variable access control permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Connection, Variable Access Control</h2>\n<p>앞서 DAG-level Permission을 보셨다면 느끼셨겠지만 Connection, Variable 또한 각 변수에 대해 접근 제어를 할 수 없고 관련 기능도 없습니다. 하지만 <strong>Alternative Secrets Backend</strong> 라는 기능을 통해 Custom Backend 클래스를 만들면 접근 제어를 구현할 수 있습니다.</p>\n<br>\n<h3 id=\"alternative-secrets-backend\" style=\"position:relative;\"><a href=\"#alternative-secrets-backend\" aria-label=\"alternative secrets backend permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Alternative Secrets Backend</h3>\n<p>원래 Connection, Variable은 Meta DB에 저장됩니다. 하지만 이 기능을 사용하면 AWS Parameter Store, Vault 등 외부 자원을 저장소로 사용할 수 있습니다. airflow에 구현된 코드는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@classmethod</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_connection_from_secrets</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> conn_id<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token string\">'Connection'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Get connection by conn_id.\n    :param conn_id: connection id\n    :return: connection\n    \"\"\"</span>\n    <span class=\"token keyword\">for</span> secrets_backend <span class=\"token keyword\">in</span> ensure_secrets_loaded<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        conn <span class=\"token operator\">=</span> secrets_backend<span class=\"token punctuation\">.</span>get_connection<span class=\"token punctuation\">(</span>conn_id<span class=\"token operator\">=</span>conn_id<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> conn<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> conn\n    <span class=\"token keyword\">raise</span> AirflowNotFoundException<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"The conn_id `</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>conn_id<span class=\"token punctuation\">}</span></span><span class=\"token string\">` not defined\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<p><code class=\"language-text\">BaseHook</code>에서 호출하는 <code class=\"language-text\">get_connection_from_secrets</code> 메서드는 여러 backend로부터 conn_id에 대한 값을 받아오고 리턴합니다. 즉 기존 Meta DB를 사용하고 있더라도 유지하면서 새로운 backend와 호환 가능합니다.</p>\n<p>AWS Parameter Store는 Path 단위로 키를 다르게 값을 저장할 수 있습니다.\n이 점을 활용해서 id 상위 경로로 role을 지정한다면 role 단위로 접근 제어가 가능해집니다.\n접근 제어를 위한 AWS Parameter Store에 저장되는 규칙은 아래와 같습니다.\nAirflow 환경, 역할 별로 구분해서 저장합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">secrets</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"airflow...SystemsManagerParameterStoreBackend\"</span>\n    <span class=\"token key atrule\">backend_kwargs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">\"connections_prefix\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/airflow/prod/connections\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">\"variables_prefix\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/airflow/prod/variables\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">\"profile_name\"</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>/airflow/prod/connections/myrole/connection_id</li>\n<li>/airflow/prod/variables/myrole/variable_id</li>\n</ul>\n<p>기본으로 제공하는 Connections, Variables UI는 세부 경로로 값을 가져오는게 아니기 때문에 secrets backend 설정과 함께 Custom UI Plugin이 필요합니다.</p>\n<br>\n<h2 id=\"access-control-ui-plugin\" style=\"position:relative;\"><a href=\"#access-control-ui-plugin\" aria-label=\"access control ui plugin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Access Control UI Plugin</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 23.714585519412385%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"conn ui\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/337N55s9zxw4kLX05D86AE/ad82d3f0c515e3dddb1dfff42642412c/conn_ui.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/337N55s9zxw4kLX05D86AE/ad82d3f0c515e3dddb1dfff42642412c/conn_ui.png?w=953 953w,\nhttps://images.ctfassets.net/tushy4jlcik7/337N55s9zxw4kLX05D86AE/ad82d3f0c515e3dddb1dfff42642412c/conn_ui.png?w=1906 1906w,\nhttps://images.ctfassets.net/tushy4jlcik7/337N55s9zxw4kLX05D86AE/ad82d3f0c515e3dddb1dfff42642412c/conn_ui.png?w=3812 3812w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>플러그인의 역할은 다음과 같습니다. myrole이라는 Airflow Role을 가진 사용자가 Connections UI 페이지에 접근하면 Custom Backend를 통해 Paramter Store의 <code class=\"language-text\">/airflow/prod/connections/myrole</code> 경로 하위의 값들을 받아오도록 요청해야 합니다. list 뿐만 아니라 create, edit, delete에 대한 기능도 추가해주어야 합니다.</p>\n<p>이를 위해 UI 플러그인에서 현재 접속한 사용자의 Role 이름을 받아올 수 있어야 합니다. 이 때 flask의 global session을 활용하면 쉽게 받아올 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> g\n\nrole_name <span class=\"token operator\">=</span> g<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>roles<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name</code></pre></div>\n<p>이제 UI에서 추가, 편집, 삭제 시 Secrets Backend를 통해 AWS Parameter Store에 반영됩니다. 오직 권한을 가진 사용자만이 DAG, Connection, Variable에 접근할 수 있습니다.</p>\n<br>\n<h2 id=\"cluster-policy\" style=\"position:relative;\"><a href=\"#cluster-policy\" aria-label=\"cluster policy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cluster Policy</h2>\n<p>DAG 작성에 대한 가이드가 있더라도 모두 만족하는지 체크하는건 상당히 번거로운 일 입니다.\nAirflow 2.0+에서는 Cluster Policy를 통해 클러스터 전체에서 DAG 또는 task에 대한 정책을 정의하고 강제하도록 설정할 수 있습니다. 예를 들면 다음과 같은 정책을 정의할 수 있습니다.</p>\n<ul>\n<li>모든 DAG에는 적어도 하나의 태그를 달아야 한다</li>\n<li>특정 task의 timeout은 48시간을 넘을 수 없다</li>\n</ul>\n<p><code class=\"language-text\">airflow_local_settings.py</code> 파일을 만들고 정의하면 적용할 수 있습니다.\n태그를 강제하는 정책 예시는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">dag_policy</span><span class=\"token punctuation\">(</span>dag<span class=\"token punctuation\">:</span> DAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Ensure that DAG has at least one tag\"\"\"</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> dag<span class=\"token punctuation\">.</span>tags<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">raise</span> AirflowClusterPolicyViolation<span class=\"token punctuation\">(</span>\n            <span class=\"token string-interpolation\"><span class=\"token string\">f\"DAG </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dag<span class=\"token punctuation\">.</span>dag_id<span class=\"token punctuation\">}</span></span><span class=\"token string\"> has no tags. At least one tag required. File path: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dag<span class=\"token punctuation\">.</span>filepath<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n        <span class=\"token punctuation\">)</span></code></pre></div>\n<p>위 정책이 적용된 클러스터에 태그가 없는 DAG을 배포하는 경우, <code class=\"language-text\">AirflowClusterPolicyViolation</code> 오류가 발생하기 때문에 DAG을 등록할 수 없습니다.\n자세한 내용은 <a href=\"https://airflow.apache.org/docs/apache-airflow/stable/concepts/cluster-policies.html\">공식문서</a>를 참고하시면 됩니다.</p>\n<br>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>최근 Airflow Summit에서 Multi-Tenent와 관련된 영상들이 많이 올라와서 함께 참고하면 도움이 될 것 같습니다.</p>\n<ul>\n<li><a href=\"https://airflow.apache.org/docs/apache-airflow/stable/security/access-control.html\">https://airflow.apache.org/docs/apache-airflow/stable/security/access-control.html</a></li>\n<li><a href=\"https://eng.lyft.com/securing-apache-airflow-ui-with-dag-level-access-a7bc649a2821\">https://eng.lyft.com/securing-apache-airflow-ui-with-dag-level-access-a7bc649a2821</a></li>\n<li><a href=\"https://airflow.apache.org/docs/apache-airflow/stable/security/secrets/secrets-backend/index.html\">https://airflow.apache.org/docs/apache-airflow/stable/security/secrets/secrets-backend/index.html</a></li>\n</ul>","excerpt":"사내 데이터가 다양해지고 사용자가 많아지면 접근 제어와 권한 등 다양한 고민이 생기게 됩니다.\n이 글에서는 여러 조직이 함께 사용하는 Airflow를 만들 때 알아두면 좋은 내용들에 대해 정리해보려고 합니다. Airflow RBAC DAG-Level Permissions Connection, Variable Permissions Cluster Policy 접근 제어가 필요한 경우 먼저 접근 제어는 모든 조직에 필요한 내용은 아닙니다. 다만 아래와 같은 경우에는 필요할 수 있습니다. 다른 사람이 실행, 중지 권한을 가져서는 안될 만큼 중요한 DAG…"}}}},"pageContext":{"slug":"airflow-multi-tenent-1","basePath":"","prev":{"slug":"spark-on-kubernetes-perf","publishDate":"2021-09-11"},"next":{"slug":"airflow-sidecar","publishDate":"2021-08-01"}}},"staticQueryHashes":["1946181227","2744905544","3732430097"]}