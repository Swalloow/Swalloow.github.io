{"componentChunkName":"component---src-templates-post-js","path":"/eks-cidr/","result":{"data":{"contentfulPost":{"id":"2f37c986-e8fe-58e7-bb2e-2ca5f8cddcc1","title":"EKS 클러스터에 VPC CIDR 추가하기","slug":"eks-cidr","metaDescription":null,"publishDate":"March 14, 2020","publishDateISO":"2020-03-14","tags":[{"title":"DevOps","id":"701ee587-d6e3-5391-af93-e295765b6f45","slug":"devops"}],"heroImage":{"id":"f36c235f-3e3e-517d-bd80-697bc6183072","title":"cover-devops","fluid":{"aspectRatio":1.5,"src":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1800&q=50","srcSet":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=450&h=300&q=50 450w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=900&h=600&q=50 900w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1080&h=720&q=50 1080w","srcWebp":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1800&q=50&fm=webp","srcSetWebp":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=450&h=300&q=50&fm=webp 450w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=900&h=600&q=50&fm=webp 900w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1080&h=720&q=50&fm=webp 1080w","sizes":"(max-width: 1800px) 100vw, 1800px"},"ogimg":{"src":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1800&fl=progressive&q=50"}},"body":{"id":"e085f98a-ff51-5f29-b126-529c3154a075","childMarkdownRemark":{"id":"0bd9b774-803c-53ac-9e9c-8f99d90548c5","timeToRead":2,"html":"<p>앞서 정리했던 <a href=\"https://swalloow.github.io/eks-vpc-cni\">EKS의 VPC 네트워크 구성 이해하기</a> 글을 먼저 보시는걸 권장드립니다. </p>\n<p>내 요구사항보다 적은 범위의 대역으로 클러스터를 생성한다면 VPC CNI로 인한 IP 제한에 마주할 수 있습니다. 처음부터 넓은 범위의 대역으로 생성하면 좋겠지만 이미 클러스터를 생성한 이후에는 어떻게 하면 좋을까요? 이러한 경우에는 VPC에 새로운 CIDR을 할당하고 이를 클러스터에 추가할 수 있습니다.</p>\n<br>\n<h2 id=\"vpc-cidr\" style=\"position:relative;\"><a href=\"#vpc-cidr\" aria-label=\"vpc cidr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VPC CIDR</h2>\n<p><img src=\"http://drive.google.com/uc?export=view&#x26;id=1i0LURjsrJbJWwqaVikpEDg3DQtmPhUp-\"></p>\n<p>먼저 확장하고자 하는 VPC를 선택한 후 새로운 CIDR 범위를 추가해주어야 합니다. 저는 위의 그림과 같이 10.X.X.X와 100.X.X.X 범위를 추가해주었습니다. 이후 새로운 CIDR 범위를 사용하여 서브넷을 생성한 다음 라우팅 테이블을 연결해줍니다.\nEKS에서 서브넷을 검색 가능하도록 하기 위해 아래와 같은 태그를 추가해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token assign-left variable\">Key</span><span class=\"token operator\">=</span>kubernetes.io/cluster/yourClusterName,Value<span class=\"token operator\">=</span>shared</code></pre></div>\n<br>\n<h2 id=\"custom-eni-config\" style=\"position:relative;\"><a href=\"#custom-eni-config\" aria-label=\"custom eni config permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Custom ENI Config</h2>\n<p>이제 새로운 CIDR 범위를 사용하도록 CNI 플러그인 설정을 변경해주어야 합니다. 먼저 클러스터에서 사용 중인 CNI 플러그인 버전을 확인하고 만일 1.5.3 미만인 경우 최신 버전으로 업데이트 합니다. (2020년 3월 기준, 최신 버전은 1.6 입니다)</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl describe daemonset aws-node --namespace kube-system <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> Image <span class=\"token operator\">|</span> <span class=\"token function\">cut</span> -d <span class=\"token string\">\"/\"</span> -f <span class=\"token number\">2</span>\n$ kubectl apply -f https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/master/config/v1.6/aws-k8s-cni.yaml</code></pre></div>\n<p>설치한 이후에 <code class=\"language-text\">kubectl get crd</code>를 통해 <strong>ENIConfig CRD</strong>가 제대로 설치되었는지 확인해줍니다. 만약 설치가 안되었다면 아래의 파일을 통해 CRD를 정의해주시면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> apiextensions.k8s.io/v1beta1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> CustomResourceDefinition\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> eniconfigs.crd.k8s.amazonaws.com\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">scope</span><span class=\"token punctuation\">:</span> Cluster\n  <span class=\"token key atrule\">group</span><span class=\"token punctuation\">:</span> crd.k8s.amazonaws.com\n  <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> v1alpha1\n  <span class=\"token key atrule\">names</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">plural</span><span class=\"token punctuation\">:</span> eniconfigs\n    <span class=\"token key atrule\">singular</span><span class=\"token punctuation\">:</span> eniconfig\n    <span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ENIConfig</code></pre></div>\n<p>이후에 aws-node daemonset에서 커스텀 네트워크 설정을 활성화하는 환경변수를 업데이트 해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ kubectl <span class=\"token builtin class-name\">set</span> <span class=\"token function\">env</span> daemonset aws-node -n kube-system <span class=\"token assign-left variable\">AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG</span><span class=\"token operator\">=</span>true</code></pre></div>\n<p>이제 앞서 생성한 서브넷에 대해 ENIConfig CRD를 생성해줍니다.\n아래는 ap-northeast-2a, 2c에 대한 2개의 서브넷에 대한 파일입니다.\n보안 그룹도 클러스터 설정에 맞게 정의해주시면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> crd.k8s.amazonaws.com/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ENIConfig\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> private<span class=\"token punctuation\">-</span>user<span class=\"token punctuation\">-</span>2a\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">subnet</span><span class=\"token punctuation\">:</span> subnet<span class=\"token punctuation\">-</span>0ddddaaaaddddccdd\n  <span class=\"token key atrule\">securityGroups</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> sg<span class=\"token punctuation\">-</span>05555598cc88ffd00\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> crd.k8s.amazonaws.com/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ENIConfig\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> private<span class=\"token punctuation\">-</span>user<span class=\"token punctuation\">-</span>2c\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">subnet</span><span class=\"token punctuation\">:</span> subnet<span class=\"token punctuation\">-</span>0ccccaaaaddddccee\n  <span class=\"token key atrule\">securityGroups</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> sg<span class=\"token punctuation\">-</span>05555598cc88ffd00</code></pre></div>\n<p>마지막으로 클러스터에 해당하는 노드 그룹의 어노테이션을 수정해주어야 합니다. <a href=\"https://github.com/terraform-aws-modules/terraform-aws-eks\">terraform-aws-eks</a> 모듈을 통해 클러스터를 생성하셨다면 <code class=\"language-text\">worker_groups</code> 하위에 <code class=\"language-text\">kubelet_extra_args</code> 변수 설정을 통해 오토스케일링 그룹 설정을 수정할 수 있습니다.</p>\n<p>추가되어야할 어노테이션 값은 아래와 같습니다.\nValue 값의 경우, 위에서 추가한 ENIConfig CRD의 name metadata를 넣어주시면 됩니다. 업데이트 이후에는 노드를 재시작해주어야 정상적으로 적용됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">k8s.amazonaws.com/eniConfig<span class=\"token operator\">=</span>private-user-2c</code></pre></div>\n<br>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html\">https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html</a></li>\n<li><a href=\"https://aws.amazon.com/ko/premiumsupport/knowledge-center/eks-multiple-cidr-ranges/\">https://aws.amazon.com/ko/premiumsupport/knowledge-center/eks-multiple-cidr-ranges/</a></li>\n</ul>\n<br>","excerpt":"앞서 정리했던 EKS의 VPC 네트워크 구성 이해하기 글을 먼저 보시는걸 권장드립니다.  내 요구사항보다 적은 범위의 대역으로 클러스터를 생성한다면 VPC CNI로 인한 IP 제한에 마주할 수 있습니다. 처음부터 넓은 범위의 대역으로 생성하면 좋겠지만 이미 클러스터를 생성한 이후에는 어떻게 하면 좋을까요? 이러한 경우에는 VPC에 새로운 CIDR을 할당하고 이를 클러스터에 추가할 수 있습니다. VPC CIDR  먼저 확장하고자 하는 VPC를 선택한 후 새로운 CIDR 범위를 추가해주어야 합니다. 저는 위의 그림과 같이 10.X.X.X와 100.X.X.X…"}}}},"pageContext":{"slug":"eks-cidr","basePath":"","prev":{"slug":"gatsby-contentful","publishDate":"2020-04-25"},"next":{"slug":"aws-cert","publishDate":"2019-11-30"}}}}