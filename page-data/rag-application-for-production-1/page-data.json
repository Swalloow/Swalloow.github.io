{"componentChunkName":"component---src-templates-post-js","path":"/rag-application-for-production-1/","result":{"data":{"contentfulPost":{"title":"RAG Application for Production (1)","slug":"rag-application-for-production-1","metaDescription":null,"publishDate":"October 13, 2024","publishDateISO":"2024-10-13","tags":[{"title":"DataEngineering","id":"25d7d0d6-3cf7-5e19-a5cb-9c3fa926046f","slug":"dataengineering"}],"heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAlgCWAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiExYeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgtxW9EylQu8nTotmo+gHfAEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":5,"html":"<p>최근 다양한 영역에서 LLM 기반 서비스 개발 사례가 늘어나고 있습니다.<br>\n그 중에서도 검색 결과를 바탕으로 자연어를 생성하는 RAG 방식이 많이 활용되고 있습니다.<br>\n이번 글에서는 RAG 어플리케이션을 운영하며 고민했던 내용들을 정리해보려 합니다.<br>\n이 글은 시리즈로 작성됩니다.</p>\n<br>\n<ul>\n<li><a href=\"https://swalloow.github.io/rag-application-for-production-1\">1) Performance: Load Balancing, AI Gateway, Semantic Cache</a></li>\n<li>\n<ol start=\"2\">\n<li>Evaluation: Metrics, Dataset, Feedback</li>\n</ol>\n</li>\n<li>\n<ol start=\"3\">\n<li>Model: Selection, Fallback, Retry</li>\n</ol>\n</li>\n<li>\n<ol start=\"4\">\n<li>Observability: Monitoring, Tracing</li>\n</ol>\n</li>\n<li>\n<ol start=\"5\">\n<li>Data: Document Indexing, Data Quality</li>\n</ol>\n</li>\n<li>\n<ol start=\"6\">\n<li>Retriever: VectorDB Index, Filtering, Reranker</li>\n</ol>\n</li>\n</ul>\n<p><br><br></p>\n<h2 id=\"problem\" style=\"position:relative;\"><a href=\"#problem\" aria-label=\"problem permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Problem</h2>\n<p>LLM 기반 서비스는 다양한 형태로 구성될 수 있습니다.<br>\n간단한 요구사항은 [단일 프롬프트 - 응답] 구조를 통해 쉽게 해결할 수 있습니다.</p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 41.86666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAARCAMAAACYVR46AAABYlBMVEX39/f29/b19/X39/f29vf19ffT7NSxzbO31LiyzrS9277S9NPc9d3Z1u+vrcqwrsu1s9GzsM6ysM3Sz/La1/PT7tS82r672Ly62Ly72bzB4MK41rq/3sG82r3N7s7b9dvX1e+/vNy9utnAvd26uNa8utm/vdy7udjBv9+4ttTCv9/Z1vPU7tS+3L/H58nb9dzX1O6+u9q8udi4tdO5t9W9u9q5ttXPzO/x9/Lu9u/s9Ozy9/Ly8vbu7vbo6PDx8fbk5OTY2dna2tr4+Pj6+vr19fXv7+/u7u709PT8/Pzb29vW1tfi4uL////7+/v29vbd3d3U1NTZ2drc3Nze3t75+fnt7e3j4+Pq6urg4ODp6eno6Oj09PXx8fHa29vZ2dmurq+ysrOzs7TS0tLr6+vX19fj4+Tk5OXf39/w8PDz8/Pn5+ft7u79/f3l5eXBwsLY2NnNzc7y8vLg4OHh4eHm5uY9311bAAAAAXRSTlPOPDo30QAAAAlwSFlzAAAsSwAALEsBpT2WqQAAAAd0SU1FB+gKDQA0LAfrbCcAAAExSURBVCjPjdAHU8IwGIDh4IcL3CjiliLuhRu1WiEUW2mpQq1Q9wQVJ/5/uzRtPU/fu1yay3NpLgh5amx54DtvrS0vQlBX39Do81s1Edjc0trW3hEw6wQEXcHuULCn19fXPzDoHyJwOExFRqKjY+PRicnAlAanQzOzXwf65wicjy1QscXI0jIVXlnV4Vp8PW6kTxsEbtI0vUVbbWsQgDF3duBHCfJpwSTGOIUxm3bClDZ2HZDj9zKsIIhZkPYPcolcLg8yHGYFLdYJlaNCpqgen5yenV9cXvG8pDLXN7c65JzwLi+VEmVOzkq8kQTyfabwoDy6IK6YycCmjVjj2k/aSDogiTMrlsG5o0OFIZXw88urfjVVX7mex95b5b36oVRFwf2kbgii+WvxT/hb6J8SfQJoJEvQOHaongAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"llm-service\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/C8rw3MVZjg3ve0pQ7q55C/1dd82263e75b0aaecfec02f34d8d7e8f/llm-service.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/C8rw3MVZjg3ve0pQ7q55C/1dd82263e75b0aaecfec02f34d8d7e8f/llm-service.png?w=188 188w,\nhttps://images.ctfassets.net/tushy4jlcik7/C8rw3MVZjg3ve0pQ7q55C/1dd82263e75b0aaecfec02f34d8d7e8f/llm-service.png?w=375 375w,\nhttps://images.ctfassets.net/tushy4jlcik7/C8rw3MVZjg3ve0pQ7q55C/1dd82263e75b0aaecfec02f34d8d7e8f/llm-service.png?w=750 750w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>하지만 위의 복잡한 시나리오와 같이 2번 이상의 LLM 요청이 필요한 서비스의 경우,<br>\n다음과 같은 문제를 고려해야 합니다.<br></p>\n<p><strong>1. Token Rate Limit</strong><br>\n모든 LLM 요청에는 토큰 제한이 존재합니다.<br>\n예를 들어 Azure OpenAI API의 경우, <code class=\"language-text\">TPM</code>(Tokens Per Minute, 분당 토큰 처리 수)과 <code class=\"language-text\">RPM</code>(Requests Per Minute, 분당 요청 수)을 통해 제한하고 있습니다.</p>\n<p><strong>2. Latency</strong><br>\n복잡한 Chain으로 구성된 경우, 사용자 요청마다 문서 검색과 여러 번의 LLM 요청으로 인해 응답 지연이 발생할 수 있습니다. 그리고 모델과 API 서비스 상황에 따라 응답 지연이 발생할 수 있습니다.</p>\n<p><strong>3. Cost</strong><br>\nLLM 요청 시, Input과 Output 토큰 수에 따라 비용이 발생합니다.<br>\n따라서 사용자가 많거나 여러 번 호출되는 경우, 비용이 크게 발생하지 않도록 최적화가 필요합니다.</p>\n<br>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 70.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAcCAIAAACcd2qBAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH6AoNASo2LwrAtQAAA8NJREFUSMe1VctuG0cQrH7M7JJLLilZlGUYcRAYSHzIIUHy/1+SY2LAthhT4mOX8+ocSMqSH7EoQXMYzAy2qrpneqvp78X7ZVhd6AkIMcbJZIJHjOV6fbVaE6jyOm6ayw8fzGw2m3Vd17bt5eVl27bz+fzly5d6+e7tv/111RJgzFLMHiPc9X3fb4d1nWJYLjP5Wok+LhYELBaLf96+FRFm/rhY0Ivffmmaxqk6detuE2P0zm1DUNWcs3cORCEEEVmt1/fRJuA+sWtWWvUbs0+ZdikAQI6f1gASoHwDs0YnUTLQ55Rzvs14H1USVsul9rWIlFLMLKfUbfvvQ2O6Njz4Vcg7BbDZbEopx0EfobpDKwB7XEEdMSpGNnNMGQyAiJ5OyzyfvBhbxfm8Pj1tnJMaDOApMxYypmZSnzovrZ16X3n9ax0oG7IpACbKX9UWQrbbC6sYyshGBiOACQRks4FAuQ62LcUYcFwxU0Yu5UTd/N2SHC/WaTKszwb1Yr4GQwFU3jsvHEtRYpAxUcgAiiN2YpvEteZtElC24tUFSqKaUlLVErPzsk25ypJjmoorsXDmlLOKdMlWIW6KSUJvdr3qPRBFCIXO/3xj5YFXzYSHQYlJUWw6aFLKxJRi2nSb79fLUKtEBGo81oFSTLnk4yKuDv/xNoQj4t3s/WwbHlh2xYyZWJ27P+bZeX17++Or4ZffzGbVq59Gtef/S7pYiTEeEe1dumqoe9OXvRmcNFqAQuCDOwgTE4TvuAUDYN5zDe6SnrVuB5sc2D9rAtNGvePxSAEMRlo5vpjVv74eZaB2zLU8n7ppo8/G+nzqf5xVTSUXUz8eCABpXpw5loGzbbKTRkP6VONnYxeSVY5zwcCzgUa11AMee6mUcrG2ce3EdV0eTT0xvf5hOHTcnlWxYMlgL83FoDEIUVSe9/l06nUo83WCEc1+/3kgOqpo1Zem4rriy+vEDALNWg3JKqU+mZkJ86pLRnQ2ki5gm3LtRRghWkx5NPRM5d0ijQfsVN5fb73TEJKOfAipIo4pU6W2jkwUUOj8jzd2bGt69CBmhdm0GccUCbRcrY5w/0bdFimlhziPZzWzq6urcnzStIoJD/6Piz55Wxw5xAwimO1myti3xScUJiBkCuVLM1AA5fHFpWSOUex2ZiACgbqv27geLaB8h/p7At9kAsAqUCEi23MdPO2QARFZsV0XpFAAOtzjzQyIfPudDXdfswAKIgJxBn32QcZuZ6CdMBlZMXJq+1AKM5ebWSTnvFvLrXO6OTmgiNlg/wExrQpBJit0RwAAABF0RVh0ZXhpZjpDb2xvclNwYWNlADEPmwJJAAAAE3RFWHRleGlmOkV4aWZPZmZzZXQAMTAyc0IppwAAABl0RVh0ZXhpZjpQaXhlbFhEaW1lbnNpb24AMjQ0Nl8tl4cAAAAZdEVYdGV4aWY6UGl4ZWxZRGltZW5zaW9uADE3MjKnEj5HAAAAGHRFWHRleGlmOlNvZnR3YXJlAFBob3RvU2NhcGV02ZskAAAAXHRFWHRleGlmOlVzZXJDb21tZW50ADY1LCA4MywgNjcsIDczLCA3MywgMCwgMCwgMCwgODMsIDk5LCAxMTQsIDEwMSwgMTAxLCAxMTAsIDExNSwgMTA0LCAxMTEsIDExNkC4H3IAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"llm-loadtest\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/2163UZDXaJTFiqHrM6gOuY/a448450e77bee8c49cde342f01b7a866/llm-loadtest.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/2163UZDXaJTFiqHrM6gOuY/a448450e77bee8c49cde342f01b7a866/llm-loadtest.png?w=188 188w,\nhttps://images.ctfassets.net/tushy4jlcik7/2163UZDXaJTFiqHrM6gOuY/a448450e77bee8c49cde342f01b7a866/llm-loadtest.png?w=375 375w,\nhttps://images.ctfassets.net/tushy4jlcik7/2163UZDXaJTFiqHrM6gOuY/a448450e77bee8c49cde342f01b7a866/llm-loadtest.png?w=750 750w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>위 부하테스트 결과와 같이 일부 모델에서는 사용자 요청이 증가함에 따라 <code class=\"language-text\">Timeout</code>, <code class=\"language-text\">RateLimit</code> 오류도 발생할 수 있습니다.\n이러한 문제들은 사용자 경험과 서비스 성능에 직접적인 영향을 미칠 수 있습니다.<br>\n따라서 이를 개선하기 위한 3가지 방법에 대해 알아보겠습니다.</p>\n<p><br><br></p>\n<h2 id=\"region-load-balancing\" style=\"position:relative;\"><a href=\"#region-load-balancing\" aria-label=\"region load balancing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Region Load Balancing</h2>\n<p>API 제공자의 정책으로 인해 사용 중인 리전 내에서 Rate Limit을 늘리기는 어렵습니다.\n이에 대한 대안으로 리전 로드밸런싱을 적용할 수 있습니다.\n리전 로드밸런싱은 <strong>여러 리전의 API 리소스를 생성하여 트래픽을 분산하는 방법</strong>입니다.\n이 방식을 통해 서비스의 지연 시간을 줄이고, 가용성을 높이며, 장애가 발생할 경우에도 다른 리전으로 요청을 전환(failover)할 수 있습니다.</p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 65.86666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAaCAAAAADgJ0EXAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH6AoNADQsB+tsJwAAAUJJREFUOMuNk01Pg0AURf3/S/0PbtTEpDFuGqOuTGOMlVqFljJQGJgZWr/QUkGOi7rB2JG3m5eTm3dv5u7QcXb+2GVSKW2M8Vc20K++JGKD+DfRY7UFfJvNe/1y93D/6PgCz59fbwMjQKLqBmjS1fpzG/gIPCc6zZQx8ZflxjuAT98No3FudX3bNZ7OoGMF3+ZpHEvlAh7wEifBLJR6XP0GNdSAakAET2iWG7/edfTQiifjfXjvoSdecOb7vfNy9+Dg6PgCZ6SdRRvkR5gE0Ew+SoDgtS5bioWSsVQ6BgRQSKONMcatLa5nALVwRToKa1s80645TrqCnRUDoMiMSqIos/6eOK/QNAA0QizzbWDhhCdX673Ty7P+gFE4HVrK1SgGKlwW7wi5ELYW5lOltNY6WP1TV+rJ0HXHYv1frzdTtp/f/WnwibReDyYAAAASdEVYdGV4aWY6RXhpZk9mZnNldAA3OMnUeycAAAAZdEVYdGV4aWY6UGl4ZWxYRGltZW5zaW9uADE0NDSjlllFAAAAGHRFWHRleGlmOlBpeGVsWURpbWVuc2lvbgA5NTJGV2XKAAAAXHRFWHRleGlmOlVzZXJDb21tZW50ADY1LCA4MywgNjcsIDczLCA3MywgMCwgMCwgMCwgODMsIDk5LCAxMTQsIDEwMSwgMTAxLCAxMTAsIDExNSwgMTA0LCAxMTEsIDExNkC4H3IAAAAodEVYdGljYzpjb3B5cmlnaHQAQ29weXJpZ2h0IEFwcGxlIEluYy4sIDIwMjQN1xqpAAAAF3RFWHRpY2M6ZGVzY3JpcHRpb24ARGlzcGxheRcblbgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"llm-lb-client\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/7oVeIxl8vFfkRgsYa2YGMA/dc991b4e2e38aa2bc550ea2958991ef6/llm-lb-client.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/7oVeIxl8vFfkRgsYa2YGMA/dc991b4e2e38aa2bc550ea2958991ef6/llm-lb-client.png?w=188 188w,\nhttps://images.ctfassets.net/tushy4jlcik7/7oVeIxl8vFfkRgsYa2YGMA/dc991b4e2e38aa2bc550ea2958991ef6/llm-lb-client.png?w=375 375w,\nhttps://images.ctfassets.net/tushy4jlcik7/7oVeIxl8vFfkRgsYa2YGMA/dc991b4e2e38aa2bc550ea2958991ef6/llm-lb-client.png?w=750 750w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>위 예시는 클라이언트 측에서 리전 로드밸런싱을 적용했을 때의 그림입니다.\n사용자의 요청은 라운드 로빈(Round-Robin) 방식을 통해 분산됩니다.\n리전마다 토큰 제한이 다른 경우를 고려하여 <strong>TPM에 비례한 가중치를 부여</strong>합니다.</p>\n<p>이 방식은 클라이언트 측에서 구현하여 쉽게 적용가능하다는 장점이 있습니다.\n반면에 클라이언트에서 리전과 모델 정보를 관리해야 한다는 단점이 있습니다.\n모델과 리전의 수가 증가할 수록 API 키 관리가 복잡해지며 리전 정보가 추가되거나 변경될 때마다 클라이언트의 재시작 또는 업데이트가 필요합니다.\n또한 여러 클라이언트 사이에서 일관성 유지가 어렵습니다.</p>\n<p><br><br></p>\n<h2 id=\"ai-gateway\" style=\"position:relative;\"><a href=\"#ai-gateway\" aria-label=\"ai gateway permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AI Gateway</h2>\n<p>앞서 살펴본 내용과 같이 LLM 기반의 모델과 서비스가 증가함에 따라 클라이언트 방식은 어려움을 마주치게 됩니다. 이를 개선하기 위한 게이트웨이 방식에 대해 알아보겠습니다.</p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAXCAAAAABcuVLJAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAB3RJTUUH6AoNADQsB+tsJwAAAXRJREFUKM+N001v00AUheH8/3+CKsSyC5CyYYGqICElbcB2En+PZ+aOG5ymobU9LwvT1k2gwcu5j2Z8jnQn/Oc3+edEa11kpd4+Q69UqZ07gbZtANSqdAMU7wFzxMppNLt4f/lR6etVMEBDFJa5tiodQ4P0ewBp+26At+0wQI1hxUFFSZzoXy9htFhXC7y6MYf7eruT7i+p4zFM3qjn1Wx9Cu+slFmVQw4PiRNxzu6IUUbnSSbNMxSqplEObI/u948d4FCt3VcdvS/neTNAzc9qJ07K6Dp/1wYqCFfbcHM1jb5dfLj8pNUX/f0OmHBvxIkkUMHuTxlCisUD6NMwGeCcE63Fs+QxnM3nX+PuTOobwHv/MErtbRoXUh8VfnNaT/30K+X4fMlw5QhW/AiVcWkSjWGMFaMr4/SoRwB79NJmnZmFOtSHdJEtghVM8OJEnBzBLtmE08/T2W15lQT5m6tgalMUlSvO7gwSreOlOr9cALyk/g29CnfM9XqS+AAAABJ0RVh0ZXhpZjpFeGlmT2Zmc2V0ADc4ydR7JwAAABl0RVh0ZXhpZjpQaXhlbFhEaW1lbnNpb24AMTczOOcnPfAAAAAYdEVYdGV4aWY6UGl4ZWxZRGltZW5zaW9uADk4NvSU354AAABcdEVYdGV4aWY6VXNlckNvbW1lbnQANjUsIDgzLCA2NywgNzMsIDczLCAwLCAwLCAwLCA4MywgOTksIDExNCwgMTAxLCAxMDEsIDExMCwgMTE1LCAxMDQsIDExMSwgMTE2QLgfcgAAACh0RVh0aWNjOmNvcHlyaWdodABDb3B5cmlnaHQgQXBwbGUgSW5jLiwgMjAyNA3XGqkAAAAXdEVYdGljYzpkZXNjcmlwdGlvbgBEaXNwbGF5FxuVuAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"llm-lb-gateway\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/3vwyA0hE0zloa473s1OUzp/39fcb9aec681bc91018afce45e8112c2/llm-lb-gateway.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/3vwyA0hE0zloa473s1OUzp/39fcb9aec681bc91018afce45e8112c2/llm-lb-gateway.png?w=188 188w,\nhttps://images.ctfassets.net/tushy4jlcik7/3vwyA0hE0zloa473s1OUzp/39fcb9aec681bc91018afce45e8112c2/llm-lb-gateway.png?w=375 375w,\nhttps://images.ctfassets.net/tushy4jlcik7/3vwyA0hE0zloa473s1OUzp/39fcb9aec681bc91018afce45e8112c2/llm-lb-gateway.png?w=750 750w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>게이트웨이 아키텍처는 클라이언트가 모든 요청을 중앙 로드밸런싱 게이트웨이로 보내고, 게이트웨이가 요청을 적절한 리전으로 라우팅하는 방식입니다. 클라이언트는 리전과 모델 정보를 직접 관리하지 않고, 게이트웨이가 로드밸런싱 역할을 수행합니다.</p>\n<p>이 방식은 항상 게이트웨이를 거쳐야한다는 단점이 있습니다. 이는 추가적인 네트워크 통신을 필요로 하며 대량의 트래픽을 처리할 때 게이트웨이의 성능이 전체 시스템의 성능에 영향을 줄 수 있는 단일 장애 지점(Single Point of Failure)이 될 수 있습니다.</p>\n<p>반면에 장점은 다음과 같습니다.</p>\n<ul>\n<li><strong>단순화된 클라이언트 로직</strong>: 클라이언트는 모든 요청을 중앙 게이트웨이에 보냅니다. 따라서 클라이언트 측에서는 로드밸런싱이나 서버 상태를 신경 쓸 필요 없이, 게이트웨이에서 알아서 처리합니다. 이를 통해 클라이언트 코드의 복잡성을 크게 줄일 수 있습니다.</li>\n<li><strong>중앙 집중식 관리</strong>: 모든 로드밸런싱 로직이 게이트웨이에서 이루어지므로, 정책이나 설정 변경 시 한 곳에서 이를 제어할 수 있습니다. API 키가 추가되거나 제거되는 상황에서도 클라이언트 코드를 수정할 필요 없이 게이트웨이만 업데이트하면 반영할 수 있습니다.</li>\n<li><strong>확장성</strong>: 게이트웨이가 여러 리전의 상태와 성능을 중앙에서 모니터링하고 로드밸런싱을 수행하므로, 대상이 수십 개에 달하더라도 일관된 방식으로 관리할 수 있습니다. Fallback, Retry와 같은 전략도 함께 반영할 수 있습니다.</li>\n<li><strong>보안</strong>: 클라이언트가 직접 API 정보에 접근하지 않기 때문에, 게이트웨이가 보안 계층의 역할을 수행할 수 있습니다. API 키 관리, 인증 및 권한 부여, 트래픽 필터링 등의 보안 조치를 게이트웨이 레벨에서 쉽게 구현할 수 있습니다.</li>\n</ul>\n<br>\n<p>AI Gateway를 적용하기 위해 많이 사용하는 오픈소스로는 <a href=\"https://github.com/Portkey-AI/gateway\">Portkey AI Gateway</a>와 <a href=\"https://github.com/BerriAI/litellm\">LiteLLM Proxy</a>가 있습니다.</p>\n<p><br><br></p>\n<h2 id=\"semantic-cache\" style=\"position:relative;\"><a href=\"#semantic-cache\" aria-label=\"semantic cache permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Semantic Cache</h2>\n<p>마지막으로 지연 시간 최적화를 위한 캐싱 전략에 대해 알아보겠습니다.\n기존에 사용하던 Exact Cache는 주어진 질문이 정확히 일치하는 경우에 캐시를 적용하는 방식입니다. 이 방식은 다양한 질문이 들어오는 자연어 질의에서 효과를 보기 어렵습니다.</p>\n<ul>\n<li>어제 비비큐 주문 수 알려줘</li>\n<li>어제 BBQ치킨 주문 수 알려줄래?</li>\n</ul>\n<p>위의 두 질문은 서로 다른 형태지만, 의미는 동일합니다. Semantic Cache는 단순히 특정 입력에 대해 해당 출력을 캐싱하는 것이 아니라, <strong>입력 질의의 유사도를 기반으로 캐싱된 결과를 재사용</strong>할 수 있습니다.</p>\n<br>\n<p>Semantic Cache를 통해 얻을 수 있는 장점은 다음과 같습니다.</p>\n<ul>\n<li><strong>비용 최적화</strong>: LLM의 응답을 생성하기 위한 연산은 상당한 자원과 시간이 소모됩니다. 매번 동일하거나 유사한 질의에 대해 중복해서 모델을 호출하면 자원 낭비와 전체적인 성능 저하가 발생할 수 있습니다.</li>\n<li><strong>지연 시간 개선</strong>: LLM은 복잡한 추론 과정을 통해 응답을 생성하므로, 요청당 지연 시간이 길어질 수 있습니다. 한 번 생성한 결과를 유사한 요청에 재사용하여 지연 시간을 개선할 수 있습니다.</li>\n<li><strong>일관된 응답 품질</strong>: 많은 사용자가 비슷한 질문을 여러 번 하거나, 튜토리얼과 같이 동일한 질문이 여러 세션에서 반복적으로 나타나는 경우가 많습니다. 하지만 LLM의 응답 결과는 불확실하기 때문에 사용자마다 다른 경험을 가질 수 있습니다. 캐시를 사용한다면 일관된 응답을 통해 성능을 개선할 수 있습니다.</li>\n</ul>\n<br>\n<p><strong>Semantic Cache의 구조</strong></p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 60.4%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAlgCWAAD/2wBDAAMCAgMCAgMDAwMEAwMEBQgFBQQEBQoHBwYIDAoMDAsKCwsNDhIQDQ4RDgsLEBYQERMUFRUVDA8XGBYUGBIUFRT/wAALCAAYACgBAREA/8QAGAABAAMBAAAAAAAAAAAAAAAABAIDBQn/xAAsEAACAgEDAwEGBwAAAAAAAAABAgMRBAASIRMxYXEFIkFRobEUFSMyUoGR/9oACAEBAAA/AOnmf7TzYDkKuA3TVSVnD38+dv1q9Wx5CrjCbJimxBdVLPVf3u0L2d7Umz8x1/BOMMXsyUyy+7xQ4+p1qUgkRSsw3kqG6pq6J/l41PckOTHHvIMisQrOSTVdr9dWZBrHlJ7BT9tHyNziW5pI1VwLjoH9o+JHnWDHJtnWRsnOAZi1HDZOD8CxQDiu+6/W+WyvMZQI8VsxNgJnn2xtHy3NFR57aaZMv8yiDRRCLY1kOSe48en257hk6GWCRFq2UgX6aNNHlKszx9LcfeCmzzVePlo/ReOWeWGLc/T/AE2a1LNzwfc4HPez6aYYXkJ3RqLFGpW5H+an0i86SOie4CFINkE141//2Q=='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"llm-cache\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/2n9A0g1R16KiDooF9AkT7N/a0283b0652c72a02b6499dac4f44900a/llm-cache.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/2n9A0g1R16KiDooF9AkT7N/a0283b0652c72a02b6499dac4f44900a/llm-cache.png?w=188 188w,\nhttps://images.ctfassets.net/tushy4jlcik7/2n9A0g1R16KiDooF9AkT7N/a0283b0652c72a02b6499dac4f44900a/llm-cache.png?w=375 375w,\nhttps://images.ctfassets.net/tushy4jlcik7/2n9A0g1R16KiDooF9AkT7N/a0283b0652c72a02b6499dac4f44900a/llm-cache.png?w=750 750w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>위 그림은 <a href=\"https://github.com/zilliztech/GPTCache\">GPTCache</a>의 컴포넌트 아키텍처입니다. 각 컴포넌트는 다음과 같은 역할을 수행합니다.</p>\n<ul>\n<li>Cache Storage: 캐싱을 위해 필요한 QA 데이터와 세션 정보를 저장합니다.</li>\n<li>Vector Store: 유사도 검색에 활용하는 벡터 저장소입니다. 다양한 스토리지 연동이 가능합니다.</li>\n<li>Cache Manager: Eviction 전략, Cache 데이터 보관 등 정책을 정의하고 설정할 수 있습니다.</li>\n<li>Evaluator: 유사도 측정 기준을 결정합니다. 다양한 알고리즘을 적용할 수 있습니다.</li>\n</ul>\n<p>Cache Hit 상황에서는 캐싱된 응답을 바로 전달합니다.\n반면에 Cache Miss 상황에서는 기존과 동일하게 LLM을 통해 응답을 생성하고 캐시 데이터를 저장합니다. 실제 서비스에 적용 시 일부 질의에서는 약 70%의 지연 시간 단축 효과가 있었습니다.</p>\n<p><br><br></p>\n<h2 id=\"마치며\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-label=\"마치며 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마치며</h2>\n<p>이번 글에서는 RAG 어플리케이션의 프로덕션 환경 운영 시 성능에 관한 여러 고려사항들을 살펴보았습니다. 그리고 토큰 제한, 지연 시간, 비용 관리 등의 문제를 개선하기 위한 3가지 방법에 대해 정리해보았습니다. 이 외에도 모델 파라메터나 프롬프트 토큰 최적화를 통한 방법이 있으니 공식 가이드를 읽어보시는 것을 추천드립니다. 다음 글에서는 서비스를 위한 LLM 평가 방법에 대해 알아보겠습니다.</p>\n<ul>\n<li><a href=\"https://platform.openai.com/docs/guides/latency-optimization\">OpenAI Guide Latency Optimization</a></li>\n<li><a href=\"https://docs.anthropic.com/en/docs/test-and-evaluate/strengthen-guardrails/reduce-latency\">Anthropic Reducing latency</a></li>\n</ul>","excerpt":"최근 다양한 영역에서 LLM 기반 서비스 개발 사례가 늘어나고 있습니다.\n그 중에서도 검색 결과를 바탕으로 자연어를 생성하는 RAG 방식이 많이 활용되고 있습니다.\n이번 글에서는 RAG 어플리케이션을 운영하며 고민했던 내용들을 정리해보려 합니다.\n이 글은 시리즈로 작성됩니다. 1) Performance: Load Balancing, AI Gateway, Semantic Cache Evaluation: Metrics, Dataset, Feedback Model: Selection, Fallback, Retry Observability: Monitoring…"}}}},"pageContext":{"slug":"rag-application-for-production-1","basePath":"","prev":null,"next":{"slug":"write-audit-publish","publishDate":"2024-03-31"}}},"staticQueryHashes":["1946181227","2744905544","3732430097"]}