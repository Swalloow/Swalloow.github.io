{"componentChunkName":"component---src-templates-post-js","path":"/spark-on-kubernetes-perf/","result":{"data":{"contentfulPost":{"title":"Spark on Kubernetes: 성능 최적화 방법들","slug":"spark-on-kubernetes-perf","metaDescription":null,"publishDate":"September 11, 2021","publishDateISO":"2021-09-11","tags":[{"title":"DataEngineering","id":"25d7d0d6-3cf7-5e19-a5cb-9c3fa926046f","slug":"dataengineering"}],"heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAlgCWAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiExYeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgtxW9EylQu8nTotmo+gHfAEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":3,"html":"<p>Spark 3.1 버전부터 Spark on Kubernetes가 GA로 변경되었습니다.\n이 글에서는 Spark on YARN 만큼의 성능을 내기 위해서 필요한 설정들에 대해 알아보겠습니다.</p>\n<br>\n<h2 id=\"교차-az-전송-지연-개선\" style=\"position:relative;\"><a href=\"#%EA%B5%90%EC%B0%A8-az-%EC%A0%84%EC%86%A1-%EC%A7%80%EC%97%B0-%EA%B0%9C%EC%84%A0\" aria-label=\"교차 az 전송 지연 개선 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>교차 AZ 전송 지연 개선</h2>\n<p>대부분 사용자들은 가용성을 우려하여 Multi-AZ 사용을 선호합니다.\n하지만 driver, executor pod가 여러 AZ에 분산되어 있는 어플리케이션은 AZ 간 <strong>추가 데이터 전송 비용</strong>이 발생할 수 있습니다. 특히 spark shuffle은 disk IO, network IO에 대한 비용이 많이 드는 연산이므로 latency가 낮은 단일 AZ가 좋은 성능을 보일 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">--conf spark.kubernetes.node.selector.zone='&lt;availability zone>'</code></pre></div>\n<p>Spark on Kubernetes에서는 Pod Template 또는 node selector 설정을 통해 단일 AZ 노드 그룹에서 실행되도록 설정할 수 있습니다.</p>\n<br>\n<h2 id=\"클러스터-노드-가용성-계산하기\" style=\"position:relative;\"><a href=\"#%ED%81%B4%EB%9F%AC%EC%8A%A4%ED%84%B0-%EB%85%B8%EB%93%9C-%EA%B0%80%EC%9A%A9%EC%84%B1-%EA%B3%84%EC%82%B0%ED%95%98%EA%B8%B0\" aria-label=\"클러스터 노드 가용성 계산하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>클러스터 노드 가용성 계산하기</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 63.72430471584038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"k8s-resource\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/2TC5DgSCNitZVsFqBXNWgc/2df2478fb59e2b54a2ae5a2ad3fbf21c/k8s-resource.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/2TC5DgSCNitZVsFqBXNWgc/2df2478fb59e2b54a2ae5a2ad3fbf21c/k8s-resource.png?w=414 414w,\nhttps://images.ctfassets.net/tushy4jlcik7/2TC5DgSCNitZVsFqBXNWgc/2df2478fb59e2b54a2ae5a2ad3fbf21c/k8s-resource.png?w=827 827w,\nhttps://images.ctfassets.net/tushy4jlcik7/2TC5DgSCNitZVsFqBXNWgc/2df2478fb59e2b54a2ae5a2ad3fbf21c/k8s-resource.png?w=1654 1654w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>노드 전체의 리소스를 최대로 사용하기 위해 어느 정도의 리소스를 할당할 수 있는지 계산할 수 있어야 합니다. 모든 Kubernetes 노드는 클러스터 운영을 위해 <strong>OS 시스템과 Kubelet에서 일정량의 리소스를 점유</strong>하고 있습니다. 따라서 Pod에 할당 가능한 리소스를 계산할 때 이 부분은 제외하고 계산해야 합니다. 만약 노드마다 뜨는 daemonset이나 agent와 같은 어플리케이션을 띄웠다면 해당 리소스도 제외되어야 합니다.</p>\n<p>클라우드 인스턴스 유형에 따라 빠르게 보고 싶을 때 <a href=\"https://learnk8s.io/kubernetes-instance-calculator\">Kubernetes Instance Calculator</a>를 사용하면 쉽게 계산할 수 있습니다.</p>\n<br>\n<h2 id=\"셔플-단계에서의-scratch-space-개선\" style=\"position:relative;\"><a href=\"#%EC%85%94%ED%94%8C-%EB%8B%A8%EA%B3%84%EC%97%90%EC%84%9C%EC%9D%98-scratch-space-%EA%B0%9C%EC%84%A0\" aria-label=\"셔플 단계에서의 scratch space 개선 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>셔플 단계에서의 scratch space 개선</h2>\n<p>Spark Shuffle 발생 시 중간 파일들이 생기게 되는데, 보통 driver나 executor의 로컬 디렉토리를 사용합니다. 하지만 Kubernetes의 경우, 기본 값으로 Pod 내부의 볼륨(emptyDir)을 사용하고 있습니다.</p>\n<p>emptyDir 유형의 볼륨은 Docker Storage Driver의 CoW(Copy-On-Write) 오버헤드로 인해 작은 파일 쓰기를 반복하는 경우 속도가 느려질 수 있습니다. 이를 개선하기 위해 Spark on Kubernetes GA 버전에서는 2가지의 설정이 추가되었습니다.</p>\n<br>\n<h3 id=\"1-spark-25262-support-tmpfs-for-local-dirs-in-k8s\" style=\"position:relative;\"><a href=\"#1-spark-25262-support-tmpfs-for-local-dirs-in-k8s\" aria-label=\"1 spark 25262 support tmpfs for local dirs in k8s permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. [SPARK-25262] Support tmpfs for local dirs in k8s</h3>\n<p>먼저 tmpfs를 local dir로 활용하는 방법입니다.\ntmpfs는 RAM 기반 파일 시스템으로 노드 재부팅 시 지워지고, 파일이 컨테이너 메모리 제한에 포함됩니다. 설정 방법은 아래와 같이 간단하지만 tmpfs 사이즈가 커질 수록 Pod OOM이 발생할 가능성이 크다보니 운영할 때는 번거로울 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\"spark.kubernetes.local.dirs.tmpfs\": \"true\"</code></pre></div>\n<br>\n<h3 id=\"2-spark-27499-support-mapping-sparklocaldir-to-hostpath-volume\" style=\"position:relative;\"><a href=\"#2-spark-27499-support-mapping-sparklocaldir-to-hostpath-volume\" aria-label=\"2 spark 27499 support mapping sparklocaldir to hostpath volume permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. [SPARK-27499] Support mapping spark.local.dir to hostPath volume</h3>\n<p>다음은 host에 마운트된 볼륨을 직접 사용하는 방법입니다. hostPath 볼륨을 spark.local.dir에 할당해서 셔플 과정에서의 디스크 성능을 향상시킬 수 있습니다. 다만 인스턴스에 SSD 또는 NVMe와 같은 볼륨을 추가로 마운트하는 경우에 더 좋은 효과를 볼 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">...</span>\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"spark-local-dir-1\"</span>\n      <span class=\"token key atrule\">hostPath</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/tmp/spark-local-dir\"</span>\n  <span class=\"token key atrule\">executor</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">instances</span><span class=\"token punctuation\">:</span> <span class=\"token number\">10</span>\n    <span class=\"token key atrule\">cores</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n    <span class=\"token punctuation\">...</span>.\n    <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"spark-local-dir-1\"</span></code></pre></div>\n<br>\n<h2 id=\"executor-pod-batch-관련-설정\" style=\"position:relative;\"><a href=\"#executor-pod-batch-%EA%B4%80%EB%A0%A8-%EC%84%A4%EC%A0%95\" aria-label=\"executor pod batch 관련 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Executor Pod Batch 관련 설정</h2>\n<p>보통 무거운 작업은 executor 여러 개가 떠서 처리하는 경우가 많습니다.\nSpark on Kubernetes에는 executor pod을 생성할 때 <strong>batch size와 delay</strong>가 존재합니다.</p>\n<p>예를 들어 executor 10개를 띄울 때 기본 설정 값이 <code class=\"language-text\">batch size = 5, delay = 1</code>로 되어 있다면, executor pod 5개가 동시에 뜨고 1초 지연 이후에 5개가 추가로 생성됩니다.\n이 설정 값은 Kubernetes Scheduler와 driver pod의 부하를 고려해서 설정해주어야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\"spark.kubernetes.allocation.batch.size\": \"5\"\n\"spark.kubernetes.allocation.batch.delay\": \"1s\"</code></pre></div>\n<br>\n<p>반면 아직 3.1 버전 기준으로 지원하지 않는 설정들은 아래와 같습니다.</p>\n<ul>\n<li>External Shuffle Service는 지원하지 않음</li>\n<li>Job Queue 없음 (Future Work)</li>\n</ul>\n<br>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://aws.amazon.com/ko/blogs/containers/optimizing-spark-performance-on-kubernetes\">https://aws.amazon.com/ko/blogs/containers/optimizing-spark-performance-on-kubernetes</a></li>\n<li><a href=\"https://aws.github.io/aws-emr-containers-best-practices\">https://aws.github.io/aws-emr-containers-best-practices</a></li>\n<li><a href=\"https://spark.apache.org/docs/latest/running-on-kubernetes.html\">https://spark.apache.org/docs/latest/running-on-kubernetes.html</a></li>\n</ul>","excerpt":"Spark 3.1 버전부터 Spark on Kubernetes가 GA로 변경되었습니다.\n이 글에서는 Spark on YARN 만큼의 성능을 내기 위해서 필요한 설정들에 대해 알아보겠습니다. 교차 AZ 전송 지연 개선 대부분 사용자들은 가용성을 우려하여 Multi-AZ 사용을 선호합니다.\n하지만 driver, executor pod가 여러 AZ에 분산되어 있는 어플리케이션은 AZ 간 추가 데이터 전송 비용이 발생할 수 있습니다. 특히 spark shuffle은 disk IO, network IO에 대한 비용이 많이 드는 연산이므로 latency가 낮은 단일 AZ…"}}}},"pageContext":{"slug":"spark-on-kubernetes-perf","basePath":"","prev":{"slug":"data-mesh-principle","publishDate":"2021-09-25"},"next":{"slug":"airflow-multi-tenent-1","publishDate":"2021-08-15"}}},"staticQueryHashes":["1946181227","2744905544","3732430097"]}