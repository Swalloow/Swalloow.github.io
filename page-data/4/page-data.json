{"componentChunkName":"component---src-templates-posts-js","path":"/4","result":{"data":{"allContentfulPost":{"edges":[{"node":{"title":"여러 조직이 함께 사용하는 Airflow 만들기","id":"0d51ef05-306f-56ae-b726-ab2712215dec","slug":"airflow-multi-tenent-1","publishDate":"August 15, 2021","heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiFBMeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgjileglOuFeTk6fC2ZH6BKV7ugEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":6,"html":"<p>사내 데이터가 다양해지고 사용자가 많아지면 접근 제어와 권한 등 다양한 고민이 생기게 됩니다.\n이 글에서는 여러 조직이 함께 사용하는 Airflow를 만들 때 알아두면 좋은 내용들에 대해 정리해보려고 합니다.</p>\n<ul>\n<li><a href=\"https://swalloow.github.io/airflow-multi-tenent-1/#airflow-rbac\">Airflow RBAC</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-multi-tenent-1/#dag-level-permissions\">DAG-Level Permissions</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-multi-tenent-1/#connection-variable-access-control\">Connection, Variable Permissions</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-multi-tenent-1/#cluster-policy\">Cluster Policy</a></li>\n</ul>\n<br>\n<h2 id=\"접근-제어가-필요한-경우\" style=\"position:relative;\"><a href=\"#%EC%A0%91%EA%B7%BC-%EC%A0%9C%EC%96%B4%EA%B0%80-%ED%95%84%EC%9A%94%ED%95%9C-%EA%B2%BD%EC%9A%B0\" aria-label=\"접근 제어가 필요한 경우 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>접근 제어가 필요한 경우</h2>\n<p>먼저 접근 제어는 모든 조직에 필요한 내용은 아닙니다. 다만 아래와 같은 경우에는 필요할 수 있습니다.</p>\n<ul>\n<li>다른 사람이 실행, 중지 권한을 가져서는 안될 만큼 중요한 DAG이 존재하는 경우</li>\n<li>민감한 데이터를 다루는 DAG이 존재하는 경우 (HR, 매출 데이터 등)</li>\n<li>팀에서 운영하는 DAG, Connection, Variable을 우리 팀만 보고 싶은 경우</li>\n</ul>\n<p>특히 Airflow Connections, Variable에는 DB 또는 클러스터 접속 정보, API키 등 민감한 정보가 많이 저장됩니다. 물론 마스킹 기능을 통해 UI에서 볼 수 없게 만들 수 있지만 id는 볼 수 있기 때문에 쉽게 값을 가져올 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> airflow<span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> Variable\n<span class=\"token keyword\">from</span> airflow<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">.</span>base_hook <span class=\"token keyword\">import</span> BaseHook\n\nvariable <span class=\"token operator\">=</span> Variable<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">\"myvar\"</span><span class=\"token punctuation\">)</span>\nconnection <span class=\"token operator\">=</span> BaseHook<span class=\"token punctuation\">.</span>get_connection<span class=\"token punctuation\">(</span><span class=\"token string\">\"myconn\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<p>이 문제를 해결하기 위한 방법으로 조직마다 Airflow 환경을 분리하는 방법이 있습니다.\n하지만 이 방법은 운영과 모니터링이 힘들 수 있어 프라이빗 클라우드를 운영해야하는 상황이 아니라면 추천하지 않습니다. 두 번째 방법은 <strong>Airflow의 RBAC 기능</strong>을 활용하는 방법 입니다.</p>\n<br>\n<h2 id=\"airflow-rbac\" style=\"position:relative;\"><a href=\"#airflow-rbac\" aria-label=\"airflow rbac permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow RBAC</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 26.629834254143645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAALCAQAAACnzwd+AAABWUlEQVQoz6WSPS9EQRiFn5n7tXvvtSshmk2oJH6AX6DSqHQ6JRKNRKFRCpWG/0BLR6uSkCiIRqIRWRv28+7e3Z15FXa5ifJONyfvnDl53gM5T2NfxIgVK0aMJA03l5sPMgPQQQjw8SKdw07jIw6g8XBxAO241Y0gHk84fF7P3kN1KVw0MtJ0+jR1iX2er6xY50fUiq+L87UWhoF64BEJRg7DphLJfto7KO7h2DO1mhFv1DLt1mZ8ktHqz0sL9xTp4h+V3kkB8DgeuIICGoR4QKdESCENC0AbYQIYFphk0JyM6dBFAWVc/TpNiAb6u7VsJFcBUB5doyYJaZAAjEm4PeqkpTpERON3dq5GQhH+JfzYCmLGvPi8BkztNLw19o8hCbxdVXayDO9e0ADt9WibX2yHzTyl0cR4rRMRkZ50xYqIkTw9tPRRFhBSLBofa/IVuw9UGS1PsAw63zeZkZEVjob2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"airflow-rbac\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/013LcVaNqjXcpl8koBPKo6/a98b75aadeef40c7b09bc083cc61f2ec/airflow-rbac.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/013LcVaNqjXcpl8koBPKo6/a98b75aadeef40c7b09bc083cc61f2ec/airflow-rbac.png?w=226 226w,\nhttps://images.ctfassets.net/tushy4jlcik7/013LcVaNqjXcpl8koBPKo6/a98b75aadeef40c7b09bc083cc61f2ec/airflow-rbac.png?w=453 453w,\nhttps://images.ctfassets.net/tushy4jlcik7/013LcVaNqjXcpl8koBPKo6/a98b75aadeef40c7b09bc083cc61f2ec/airflow-rbac.png?w=905 905w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>Airflow RBAC은 1.10 버전부터 추가되었고 2.0 버전부터 기본 설정으로 제공됩니다.\nAirflow의 Security Model은 위의 그림과 같은 구조를 따르고 있습니다.\n사용자는 User, Role로 구성되어 있습니다. 여기서 User는 하나 이상의 Role을 가질 수 있습니다.</p>\n<p>접근 권한은 <strong>Permission, ViewMenu</strong> 그리고 이를 조합한 <strong>PermissionView</strong>로 구성되어 있습니다.\nRole은 여러 개의 Permission을 가질 수 있습니다. PermissionView에 대한 예시는 아래와 같습니다.</p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 42.29950319375443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"permissionview\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/09unii6nTbCJk4DK7VK32/2f2b05f6317b7bf671437738d1f22b95/permissionview.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/09unii6nTbCJk4DK7VK32/2f2b05f6317b7bf671437738d1f22b95/permissionview.png?w=705 705w,\nhttps://images.ctfassets.net/tushy4jlcik7/09unii6nTbCJk4DK7VK32/2f2b05f6317b7bf671437738d1f22b95/permissionview.png?w=1409 1409w,\nhttps://images.ctfassets.net/tushy4jlcik7/09unii6nTbCJk4DK7VK32/2f2b05f6317b7bf671437738d1f22b95/permissionview.png?w=2818 2818w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>Connections <strong>ViewMenu</strong> 와 can_edit <strong>Permission</strong> 을 조합하면 <code class=\"language-text\">can edit on Connections</code>라는 <strong>PermissionView</strong> 가 생성됩니다. 이 권한을 가진 사용자만 Connections UI에서 편집을 할 수 있습니다. 이러한 방식을 Airflow에서는 <strong>Resource-Based permissions</strong>라고 정의하고 있습니다.</p>\n<p>Airflow에는 다양한 리소스에 대해 권한이 이미 정의되어 있고, 기본적으로 Admin을 포함한 5개의 Role을 제공합니다. 조직마다 다른 Role을 가지고 싶은 경우, BaseRole을 정의하고 Copy Role을 통해 새로 만들면 편하게 운영할 수 있습니다.</p>\n<p>리소스 기반의 권한 제어도 필요하지만 이 기능에서는 DAGs 라는 단일 리소스로 보고 있기 때문에 DAG 단위로 접근 제어를 할 수 없습니다. 이를 지원하기 위해 2.0+ 버전부터 <strong>DAG-level Permission</strong>이 추가되었습니다.</p>\n<br>\n<h2 id=\"dag-level-permissions\" style=\"position:relative;\"><a href=\"#dag-level-permissions\" aria-label=\"dag level permissions permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DAG-level Permissions</h2>\n<p>DAG-level Permission을 사용하면 다음과 같은 접근 제어를 할 수 있습니다.</p>\n<ul>\n<li>A 사용자는 A 사용자의 DAG만 볼 수 있음</li>\n<li>A 사용자는 B 사용자의 DAG을 볼 수 없음</li>\n<li>B 사용자가 A 사용자에게 권한을 부여하면 볼 수 있음</li>\n</ul>\n<p>DAG-level Permission은 앞서 얘기했던 리소스 기반 접근 제어에 <code class=\"language-text\">DAG:dag_id</code>라는 리소스를 추가하는 방식으로 구현되었습니다. 예를 들어 A 사용자와 B 사용자에게 example DAG에 대한 읽기 권한을 부여하고 싶은 경우, <code class=\"language-text\">DAG:example.can_read</code>라는 권한을 추가해주어야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">with</span> DAG<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"example_dag\"</span><span class=\"token punctuation\">,</span>\n    default_args<span class=\"token operator\">=</span>default_args<span class=\"token punctuation\">,</span>\n    description<span class=\"token operator\">=</span><span class=\"token string\">\"example dags\"</span><span class=\"token punctuation\">,</span>\n    schedule_interval<span class=\"token operator\">=</span><span class=\"token string\">\"@once\"</span><span class=\"token punctuation\">,</span>\n    access_control<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"myrole\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"can_dag_read\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    start_date<span class=\"token operator\">=</span>days_ago<span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> dag<span class=\"token punctuation\">:</span></code></pre></div>\n<p>위와 같이 DAG을 정의하는 단계에서도 <code class=\"language-text\">access_control</code> 파라메터를 통해 DAG의 접근 권한을 정의해주어야 합니다. 이후 BaseRole에 DAGs 리소스 접근 권한을 제거하면 사용자는 오직 허용된 DAG에 대해서만 접근할 수 있게 됩니다.</p>\n<p>DAG access_control이 변경될 때마다 Role에 권한을 추가하는 일은 보통 번거로운 일이 아닙니다. 이를 위해 Airflow에서는 <code class=\"language-text\">airflow sync-perm</code> 이라는 명령어를 제공합니다. 해당 명령어를 실행하면 모든 DAG에 정의된 권한이 연관된 Role에 반영됩니다. Permission Sync 사이드카 컨테이너를 webserver에 배포하면 이 과정을 자동화할 수 있습니다. 관련 내용은 <a href=\"https://swalloow.github.io/airflow-sidecar/#2-permission-sync-container\">사이드카 컨테이너로 Airflow 기능 확장하기</a> 글을 참고해주시면 됩니다.</p>\n<br>\n<h2 id=\"connection-variable-access-control\" style=\"position:relative;\"><a href=\"#connection-variable-access-control\" aria-label=\"connection variable access control permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Connection, Variable Access Control</h2>\n<p>앞서 DAG-level Permission을 보셨다면 느끼셨겠지만 Connection, Variable 또한 각 변수에 대해 접근 제어를 할 수 없고 관련 기능도 없습니다. 하지만 <strong>Alternative Secrets Backend</strong> 라는 기능을 통해 Custom Backend 클래스를 만들면 접근 제어를 구현할 수 있습니다.</p>\n<br>\n<h3 id=\"alternative-secrets-backend\" style=\"position:relative;\"><a href=\"#alternative-secrets-backend\" aria-label=\"alternative secrets backend permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Alternative Secrets Backend</h3>\n<p>원래 Connection, Variable은 Meta DB에 저장됩니다. 하지만 이 기능을 사용하면 AWS Parameter Store, Vault 등 외부 자원을 저장소로 사용할 수 있습니다. airflow에 구현된 코드는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@classmethod</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_connection_from_secrets</span><span class=\"token punctuation\">(</span>cls<span class=\"token punctuation\">,</span> conn_id<span class=\"token punctuation\">:</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token string\">'Connection'</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Get connection by conn_id.\n    :param conn_id: connection id\n    :return: connection\n    \"\"\"</span>\n    <span class=\"token keyword\">for</span> secrets_backend <span class=\"token keyword\">in</span> ensure_secrets_loaded<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        conn <span class=\"token operator\">=</span> secrets_backend<span class=\"token punctuation\">.</span>get_connection<span class=\"token punctuation\">(</span>conn_id<span class=\"token operator\">=</span>conn_id<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> conn<span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> conn\n    <span class=\"token keyword\">raise</span> AirflowNotFoundException<span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"The conn_id `</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>conn_id<span class=\"token punctuation\">}</span></span><span class=\"token string\">` not defined\"</span></span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<p><code class=\"language-text\">BaseHook</code>에서 호출하는 <code class=\"language-text\">get_connection_from_secrets</code> 메서드는 여러 backend로부터 conn_id에 대한 값을 받아오고 리턴합니다. 즉 기존 Meta DB를 사용하고 있더라도 유지하면서 새로운 backend와 호환 가능합니다.</p>\n<p>AWS Parameter Store는 Path 단위로 키를 다르게 값을 저장할 수 있습니다.\n이 점을 활용해서 id 상위 경로로 role을 지정한다면 role 단위로 접근 제어가 가능해집니다.\n접근 제어를 위한 AWS Parameter Store에 저장되는 규칙은 아래와 같습니다.\nAirflow 환경, 역할 별로 구분해서 저장합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">secrets</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">backend</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"airflow...SystemsManagerParameterStoreBackend\"</span>\n    <span class=\"token key atrule\">backend_kwargs</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token key atrule\">\"connections_prefix\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/airflow/prod/connections\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">\"variables_prefix\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/airflow/prod/variables\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token key atrule\">\"profile_name\"</span><span class=\"token punctuation\">:</span> <span class=\"token null important\">null</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>/airflow/prod/connections/myrole/connection_id</li>\n<li>/airflow/prod/variables/myrole/variable_id</li>\n</ul>\n<p>기본으로 제공하는 Connections, Variables UI는 세부 경로로 값을 가져오는게 아니기 때문에 secrets backend 설정과 함께 Custom UI Plugin이 필요합니다.</p>\n<br>\n<h2 id=\"access-control-ui-plugin\" style=\"position:relative;\"><a href=\"#access-control-ui-plugin\" aria-label=\"access control ui plugin permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Access Control UI Plugin</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 23.714585519412385%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"conn ui\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/337N55s9zxw4kLX05D86AE/ad82d3f0c515e3dddb1dfff42642412c/conn_ui.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/337N55s9zxw4kLX05D86AE/ad82d3f0c515e3dddb1dfff42642412c/conn_ui.png?w=953 953w,\nhttps://images.ctfassets.net/tushy4jlcik7/337N55s9zxw4kLX05D86AE/ad82d3f0c515e3dddb1dfff42642412c/conn_ui.png?w=1906 1906w,\nhttps://images.ctfassets.net/tushy4jlcik7/337N55s9zxw4kLX05D86AE/ad82d3f0c515e3dddb1dfff42642412c/conn_ui.png?w=3812 3812w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>플러그인의 역할은 다음과 같습니다. myrole이라는 Airflow Role을 가진 사용자가 Connections UI 페이지에 접근하면 Custom Backend를 통해 Paramter Store의 <code class=\"language-text\">/airflow/prod/connections/myrole</code> 경로 하위의 값들을 받아오도록 요청해야 합니다. list 뿐만 아니라 create, edit, delete에 대한 기능도 추가해주어야 합니다.</p>\n<p>이를 위해 UI 플러그인에서 현재 접속한 사용자의 Role 이름을 받아올 수 있어야 합니다. 이 때 flask의 global session을 활용하면 쉽게 받아올 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> g\n\nrole_name <span class=\"token operator\">=</span> g<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>roles<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>name</code></pre></div>\n<p>이제 UI에서 추가, 편집, 삭제 시 Secrets Backend를 통해 AWS Parameter Store에 반영됩니다. 오직 권한을 가진 사용자만이 DAG, Connection, Variable에 접근할 수 있습니다.</p>\n<br>\n<h2 id=\"cluster-policy\" style=\"position:relative;\"><a href=\"#cluster-policy\" aria-label=\"cluster policy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cluster Policy</h2>\n<p>DAG 작성에 대한 가이드가 있더라도 모두 만족하는지 체크하는건 상당히 번거로운 일 입니다.\nAirflow 2.0+에서는 Cluster Policy를 통해 클러스터 전체에서 DAG 또는 task에 대한 정책을 정의하고 강제하도록 설정할 수 있습니다. 예를 들면 다음과 같은 정책을 정의할 수 있습니다.</p>\n<ul>\n<li>모든 DAG에는 적어도 하나의 태그를 달아야 한다</li>\n<li>특정 task의 timeout은 48시간을 넘을 수 없다</li>\n</ul>\n<p><code class=\"language-text\">airflow_local_settings.py</code> 파일을 만들고 정의하면 적용할 수 있습니다.\n태그를 강제하는 정책 예시는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">dag_policy</span><span class=\"token punctuation\">(</span>dag<span class=\"token punctuation\">:</span> DAG<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"Ensure that DAG has at least one tag\"\"\"</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> dag<span class=\"token punctuation\">.</span>tags<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">raise</span> AirflowClusterPolicyViolation<span class=\"token punctuation\">(</span>\n            <span class=\"token string-interpolation\"><span class=\"token string\">f\"DAG </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dag<span class=\"token punctuation\">.</span>dag_id<span class=\"token punctuation\">}</span></span><span class=\"token string\"> has no tags. At least one tag required. File path: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>dag<span class=\"token punctuation\">.</span>filepath<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n        <span class=\"token punctuation\">)</span></code></pre></div>\n<p>위 정책이 적용된 클러스터에 태그가 없는 DAG을 배포하는 경우, <code class=\"language-text\">AirflowClusterPolicyViolation</code> 오류가 발생하기 때문에 DAG을 등록할 수 없습니다.\n자세한 내용은 <a href=\"https://airflow.apache.org/docs/apache-airflow/stable/concepts/cluster-policies.html\">공식문서</a>를 참고하시면 됩니다.</p>\n<br>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>최근 Airflow Summit에서 Multi-Tenent와 관련된 영상들이 많이 올라와서 함께 참고하면 도움이 될 것 같습니다.</p>\n<ul>\n<li><a href=\"https://airflow.apache.org/docs/apache-airflow/stable/security/access-control.html\">https://airflow.apache.org/docs/apache-airflow/stable/security/access-control.html</a></li>\n<li><a href=\"https://eng.lyft.com/securing-apache-airflow-ui-with-dag-level-access-a7bc649a2821\">https://eng.lyft.com/securing-apache-airflow-ui-with-dag-level-access-a7bc649a2821</a></li>\n<li><a href=\"https://airflow.apache.org/docs/apache-airflow/stable/security/secrets/secrets-backend/index.html\">https://airflow.apache.org/docs/apache-airflow/stable/security/secrets/secrets-backend/index.html</a></li>\n</ul>","excerpt":"…"}}}},{"node":{"title":"사이드카 컨테이너로 Airflow 기능 확장하기","id":"381770e9-3117-58b1-979e-b4b146f5a7b3","slug":"airflow-sidecar","publishDate":"August 01, 2021","heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiFBMeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgjileglOuFeTk6fC2ZH6BKV7ugEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":4,"html":"<p>Airflow 2.1 버전부터 공식 Helm Chart가 정식 릴리즈 되었습니다.\n오늘은 공식 차트에서 사용할 수 있는 기능 중 <code class=\"language-text\">extraContainers</code> 옵션을 활용하는 방법을 3가지 예시를 통해 소개해보려 합니다.</p>\n<ul>\n<li><a href=\"https://swalloow.github.io/airflow-sidecar/#1-s3-sync-container\">S3 Sync Container</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-sidecar/#2-permission-sync-container\">Permission Sync Container</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-sidecar/#3-kerberos-container\">Kerberos Container</a></li>\n</ul>\n<br>\n<h2 id=\"sidecar-container\" style=\"position:relative;\"><a href=\"#sidecar-container\" aria-label=\"sidecar container permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Sidecar Container</h2>\n<p>분산 컨테이너 환경에서 사이드카 패턴이란 Pod 안에서 두 개 이상의 컨테이너로 구성되어 있는 형태를 말합니다. 컨테이너들은 서로 네트워크 또는 볼륨을 공유할 수 있습니다. 사이드카 컨테이너를 활용하면 다음과 장점을 가져갈 수 있습니다.</p>\n<p><strong>기존 로직의 변경 없이 새로운 기능 추가</strong>:\n가끔 일부 기능 추가를 위해 Airflow 저장소 코드를 수정하는 경우가 생길 수 있습니다.\n하지만 이렇게 한번 수정하고 나면 이후에 버전 업데이트할 때마다 새로운 버전 브랜치와 병합해야 하는 번거로움이 생깁니다. 만약 원하는 기능이 사이드카 컨테이너를 활용할 수 있다면 기존 저장소의 변경 없이 새로운 기능을 추가할 수 있습니다.</p>\n<p><strong>컨테이너 재사용</strong>:\n사내에서 개발 환경에 따라 또는 접근 권한에 따라 Airflow 인스턴스를 여러 개 구성하고 운영하는 경우가 많습니다. 사이드카 컨테이너로 구성한 기능은 재사용이 가능하기 때문에 새로 배포한 Airflow 인스턴스에 쉽게 적용할 수 있습니다.</p>\n<br>\n<h2 id=\"airflow-extracontainers\" style=\"position:relative;\"><a href=\"#airflow-extracontainers\" aria-label=\"airflow extracontainers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow extraContainers</h2>\n<p>Airflow Helm Chart에서는 <code class=\"language-text\">extraContainers</code> 옵션을 통해 사이드카 컨테이너를 scheduler, webserver, worker에 정의할 수 있습니다. <del>제가 기여한 옵션입니다!</del> (<a href=\"https://github.com/apache/airflow/pull/13735\">https://github.com/apache/airflow/pull/13735</a>)</p>\n<p>이제 몇 가지 예시를 통해 어떻게 활용할 수 있는지 알아보겠습니다.</p>\n<br>\n<h2 id=\"1-s3-sync-container\" style=\"position:relative;\"><a href=\"#1-s3-sync-container\" aria-label=\"1 s3 sync container permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. S3 Sync Container</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 54.478707782672544%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAWCAMAAACFUC6CAAAAVFBMVEUAAADi4uLi4uL4+Pj5+fn////n5+fo6Ojp6enr6+vu7u7v7+/w8PDx8fHy8vLz8/P09PT19fX29vb39/f4+Pj5+fn6+vr7+/v8/Pz9/f3+/v7////gbFQYAAAABnRSTlMMf4Dp6fgVVt9rAAABCElEQVQoz43T23LCMAwEUEOAltwTaSXZ+///2QdIWjIlYR/tM+uxxk7pfPGdRES4X84pna58n+xm5kFeT+nCunnnJvGcc+hAVsl3CkcFzICh0HehMOqmMeIIzjn6rrUyH8EMxQxo8ACSpEQhP4HdrV8gFI9ovBpXALUAavTk1GWj6CtE+b2+Jyc4t2Pf98Et5NQN09AJ9Qmnum/r+j/YNmNbj0/4+dEiIoOIiJN0qKrCSfq6gXU8RZaWwXMp2QcsZY/avzBaI90MqjBzsrRCPhvWgU+i461XuQenrzsYd9Hpu1GZNpClkCyEhptHKFiW1Qestg/BAMDyZrna/wprrqeUzpUfpjqnH54ZUfVMZsDWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"s3-sidecar\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/72F13S5hekKyVz9z9rCAKq/fc48e2c5b5f1ed47ff26a21fff2fc8f4/s3-sidecar.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/72F13S5hekKyVz9z9rCAKq/fc48e2c5b5f1ed47ff26a21fff2fc8f4/s3-sidecar.png?w=341 341w,\nhttps://images.ctfassets.net/tushy4jlcik7/72F13S5hekKyVz9z9rCAKq/fc48e2c5b5f1ed47ff26a21fff2fc8f4/s3-sidecar.png?w=681 681w,\nhttps://images.ctfassets.net/tushy4jlcik7/72F13S5hekKyVz9z9rCAKq/fc48e2c5b5f1ed47ff26a21fff2fc8f4/s3-sidecar.png?w=1362 1362w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>AWS MWAA 처럼 <strong>S3를 DAG 저장소로 활용하고 싶은 경우</strong>에 S3 Sync 사이드카 컨테이너를 통해 구현할 수 있습니다. S3 Sync 사이드카 컨테이너는 S3 버킷에 올라간 파일을 DAG 경로에 주기적으로 동기화하는 컨테이너입니다. 만약 DAG Serialiaztion 옵션이 활성화되어 있다면 scheduler에만 정의하면 됩니다.</p>\n<p>예시는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">scheduler</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">extraContainers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> s3<span class=\"token punctuation\">-</span>sync\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> myrepository/s3<span class=\"token punctuation\">-</span>sync<span class=\"token punctuation\">:</span>latest\n      <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> Always\n      <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dags\n          <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /opt/airflow/dags\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> AWS_BUCKET\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>src\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> KEY_PATH\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> dags\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> DEST_PATH\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> /opt/airflow/dags\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> INTERVAL\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10\"</span></code></pre></div>\n<br>\n<p>위와 같이 인스턴스마다 서로 다른 설정이 필요한 값들은 환경변수로 구성할 수 있도록 이미지를 정의합니다. S3 접근 권한은 직접 credential을 사용하는 것보다 EKS의 IRSA를 활용해서 Role 기반으로 제어하는 편이 좋습니다. Dockerfile은 <a href=\"https://github.com/Swalloow/s3-sync\">s3sync</a> 저장소를 참고하시면 됩니다.</p>\n<br>\n<h2 id=\"2-permission-sync-container\" style=\"position:relative;\"><a href=\"#2-permission-sync-container\" aria-label=\"2 permission sync container permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Permission Sync Container</h2>\n<p>2.0 부터 추가된 <strong>DAG level Permission을 사용하는 경우</strong>, airflow sync-perm 명령어를 통해 DAG 권한을 갱신해주어야 Role에 권한제어가 정상적으로 반영됩니다. Permission Sync 컨테이너는 webserver에서 주기적으로 <code class=\"language-text\">sync-perm</code> 명령어를 수행하는 역할을 합니다.</p>\n<p>예시는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">webserver</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">extraContainers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> sync<span class=\"token punctuation\">-</span>perm\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> apache/airflow<span class=\"token punctuation\">:</span>2.1.2<span class=\"token punctuation\">-</span>python3.7\n      <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> Always\n      <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/sh\"</span><span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">args</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"-c\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"while true; do airflow sync-perm; sleep 60; done\"</span><span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> dags\n          <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/opt/airflow/dags\"</span>\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> AIRFLOW__CORE__SQL_ALCHEMY_CONN\n          <span class=\"token key atrule\">valueFrom</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">secretKeyRef</span><span class=\"token punctuation\">:</span>\n              <span class=\"token key atrule\">key</span><span class=\"token punctuation\">:</span> connection\n              <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>dev<span class=\"token punctuation\">-</span>airflow<span class=\"token punctuation\">-</span>metadata</code></pre></div>\n<br>\n<p>보시면 Airflow 이미지와 정의된 connection을 재활용 합니다. 컴포넌트 컨테이너와 분리되어 있으니 사이드카에서 발생하는 로그만 따로 확인할 수도 있습니다.</p>\n<br>\n<h2 id=\"3-kerberos-container\" style=\"position:relative;\"><a href=\"#3-kerberos-container\" aria-label=\"3 kerberos container permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Kerberos Container</h2>\n<p>클러스터에 접근하기 위해 Kerberos 인증이 필요한 경우, Kerberos 컨테이너를 활용하면 인증 토큰 갱신을 자동화할 수 있습니다. <a href=\"https://airflow.apache.org/docs/apache-airflow/stable/production-deployment.html#kerberos-authenticated-workers\">Airflow 공식 문서</a>의 production-deployment 부분을 보면 아래와 같은 내용이 있습니다.</p>\n<blockquote>\n<p>In the Kubernetes environment, this can be realized by the\nconcept of side‐car, where both Kerberos token refresher and\nworker are part of the same Pod. Only the Kerberos side‐car has\naccess to Keytab secret and both containers in the same Pod\nshare the volume, where temporary token is written by the side‐\ncare container and read by the worker container.</p>\n</blockquote>\n<p>대략 K8S 환경에서 사이드카 형태로 구성하는 방법에 대한 내용입니다.\n이를 그림으로 그려보면 아래와 같습니다.</p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 54.478707782672544%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAWCAMAAACFUC6CAAAAe1BMVEUAAADi4uLk5OTi4uLk5OT4+Pj5+fn6+vr6+vr////c3Nzg4ODi4uLj4+Pk5OTl5eXm5ubn5+fo6Ojp6enq6urr6+vt7e3u7u7v7+/w8PDx8fHy8vLz8/P09PT19fX29vb39/f4+Pj5+fn6+vr7+/v8/Pz9/f3+/v7///8r3cDbAAAACnRSTlMMf3+AgOnp6fj44tPYXAAAAV1JREFUKM+N0tty2zAMBFC6rtM6bZM49UWyKQpYgOD+/xf2IZKiesbT4k3QGZKLQUpfv1V/XLXW6v60TenL9y74qMLNzCu536QnSvto1rkWV8Qjomomd8mnZpNaIyKi6tzioIAZkBt9gWGsWUoxhs1QKOe+K8QdxI9fz895BcfAMFxKG+8gxzFnrmBA0Sm0cgWbzLP4fCNJ3izINWSYuQ7u9pfjeLzNEAoAgGkE1sYVQAGgRk9OnX80DWmXY7TpG+0zvicnaK+Hw+uZVIrerjpOIwfLNZd8LdQJlveXny9vMZ9dFzhcutyfbxNUspFsbBM0PLhaRGRQEXGSDvQ94CRdRCSLiGAZT5M5QPZoLTzP+aeVWcPaG+lmUIWZc+xzJ5xOWAZeRIfDTeVUWd5PYD3p5ffx0Gm5g2wfgaDVzWvV6eo5j6fd/VIbANj91u/SZs//qP0mpe3O/1m7bfoDFkB6lo8Gb7oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"kerberos\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/3Unp3SJDghgcGuQxCJNHNZ/e6347df7cf93baac02b581d8f6e42f1a/kerberos.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/3Unp3SJDghgcGuQxCJNHNZ/e6347df7cf93baac02b581d8f6e42f1a/kerberos.png?w=341 341w,\nhttps://images.ctfassets.net/tushy4jlcik7/3Unp3SJDghgcGuQxCJNHNZ/e6347df7cf93baac02b581d8f6e42f1a/kerberos.png?w=681 681w,\nhttps://images.ctfassets.net/tushy4jlcik7/3Unp3SJDghgcGuQxCJNHNZ/e6347df7cf93baac02b581d8f6e42f1a/kerberos.png?w=1362 1362w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>kerberos 컨테이너는 keytab이 존재하는 볼륨에 접근하고 kinit 명령어를 통해 ccache를 갱신합니다. airflow 인스턴스들의 worker는 해당 볼륨의 갱신된 토큰을 통해 인증을 달성할 수 있습니다. prod, dev와 같이 여러 airflow를 사용하더라도 kerberos의 컨테이너에서 한번만 캐시 업데이트를 수행하면 됩니다.</p>\n<p>예시는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">worker</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">extraContainers</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> worker<span class=\"token punctuation\">-</span>kerberos\n      <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> myrepository/kerberos<span class=\"token punctuation\">:</span>latest\n      <span class=\"token key atrule\">imagePullPolicy</span><span class=\"token punctuation\">:</span> Always\n      <span class=\"token key atrule\">volumeMounts</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> keytab\n          <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /etc/keytab\n      <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> INTERVAL\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3600\"</span>\n        <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> KRB5_CONFIG\n          <span class=\"token key atrule\">value</span><span class=\"token punctuation\">:</span> /etc/keytab/krb5.conf\n\n<span class=\"token punctuation\">...</span>\n\n<span class=\"token key atrule\">extraVolumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> keytab\n    <span class=\"token key atrule\">persistentVolumeClaim</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">claimName</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>keytab\n<span class=\"token key atrule\">extraVolumeMounts</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> keytab\n    <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/etc/keytab\"</span></code></pre></div>\n<br>\n<p>위와 같이 keytab이 존재하는 볼륨을 마운트해주어야 합니다.</p>\n<br>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>이외에도 사이드카 컨테이너를 잘 활용한다면 다양한 기능으로 확장할 수 있습니다.\n<code class=\"language-text\">extraInitContainers</code> 옵션도 있으니 함께 활용해보면 좋을 것 같습니다.</p>\n<ul>\n<li><a href=\"https://airflow.apache.org/docs/helm-chart/stable/using-additional-containers.html\">https://airflow.apache.org/docs/helm-chart/stable/using-additional-containers.html</a></li>\n</ul>","excerpt":"Airflow 2.1 버전부터 공식 Helm Chart…"}}}},{"node":{"title":"Airflow on Kubernetes (3)","id":"e7b082d0-f9d8-5371-aeac-66452691f800","slug":"airflow-on-kubernetes-3","publishDate":"February 05, 2021","heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiFBMeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgjileglOuFeTk6fC2ZH6BKV7ugEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":2,"html":"<p>최근 Airflow에는 Kubernetes 지원을 위해 다양한 컴포넌트들이 추가되고 있습니다. 이러한 변화의 흐름에 따라 Airflow를 Kubernetes 위에 배포하고 운영하는 방법에 대해 글을 작성해보고자 합니다. 이 글은 시리즈로 연재됩니다.</p>\n<ul>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-1\">Airflow on Kubernetes (1): CeleryExecutor</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-2\">Airflow on Kubernetes (2): KubernetesExecutor</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-3\">Airflow on Kubernetes (3): Airflow Logging, Monitoring</a></li>\n</ul>\n<br>\n<h2 id=\"airflow-logging\" style=\"position:relative;\"><a href=\"#airflow-logging\" aria-label=\"airflow logging permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow Logging</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 58.93271461716937%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAYCAMAAAC/Wk/yAAACHFBMVEX////+/v7v8fzEzfTx8/z6+vr4+Pj5+fn6+vn6+fn39/f9/f2wvPEASeO2wfH///7///37+/z9/f77+/v8/Pza3/iPpOze4/ns7/vr7vv+/v/m6frw8vz+/v2jsu+cre/w8vr9/fz6+vv7/Pzk6PqbrO6mtfD3+Pv09v2isvCXqevj5u7r7e/p6+7q7O7o6+709feXqu6jsuvo6u7r7O73+Pn6+/v8/f33+P3m6e/r7e7b3+6ruO3Aye3o6u309fbz9fvn6e/b4O7q4uH37u3s7u/t7u/Fze2fsPGeru3m6e7z9PWfr/H39/j09vbjxMPBZV2/eXTv4N/e4eqtuOXHzujf4uutuebGzef29/j+///an5y/AACfAADjxsXq7O/i5Obe4ODg4uPo6uzn6e3z9Pb6+/zk5eff4OHn6u3rzczLcGjGgHrw8fLy8/Tx8vPy8/X19vf9/v719vjo4N/06+rm5eXp6eno6Ofo6Ojl5eXv7+/09fX3+Pj//v75+frz9PT19vby8vP4+fnq7PG3wuy5w+zs7vL8/PvX3O2tuuzN0+z4+fjCyuyxvezh5e/c4PCaq+6Zq+7g4/L+/vu1wOyjs/Gks+zu8PWaq+2fsPDK0e7+/vzr7fGwvOmyvent7/LY3e2hsOfM0+u+x+qmtOjj5u/x8/Tl5ufk5ubt7/Dh4uPq7O329vfo6uvi4+Tv8PL29vb19fXm5uZzIwCVAAAB+klEQVQYGZXBzUsUcQDH4c93nJl9mdkd153DutAtTKJXxJROQREdis519yodOxUFgofoFHUMOggR9B9Ux4oOdQkLBINMQ3RxXWdWnV1/zW4q2ZLQ84h94p8MCEtqkXJkLDoE2uEPO44ibPJKJWAy2qIjLtKy2BMBRUXY5JRaA6dp6KpKC+wZiA1dgiNLVUmNuLIe1FSDo5JWgYDamhEGypsRgv6KUshYxtInGKxI2pSxDNkPwsA5vceG5Mu4EldSnUDA0jE13OK26pSadBUEfeAmP4br5UwmEzTaA3OeW5n12gN9nhM0mtVvmSvzV4czmeOzFpygtMSi7/sLeBsmir6fNWYx8IJlrGKi14nfgUVqa8QdKRQKo2ZoiNQZt6RSvv+0zs8Rx8wEQbCBRer6tl8sLvv+xcIrUv6F0cvr/fX4Unaejse53EtsUjOUx3RS0hQdD0mFK+zLio4xUmEYemWPLi8kIHsHvBAJyDtg89sKENF1V0ytuxMPvOykNB0DOSXY9HCk+5Lu6Y0v5SJSuQiLHv6u5jXf96fZZdOjIOnnoHRrfEKaZJdNj7z07N0T6fYpSciwJ7zJAXKcKnI9CDPyBJRD6IPsZ/eAxJZlOc+/rhVot/wm0MrG2FDjL7aJQB/VMi/ourEK4jDh07dA+1EE4lAOqeIq/+EXob2RwJWg0D8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"airflow-log\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/4XkuIbWLKoTk3S0k2k7vl5/41a71e9051c7fc2e6e0bffb9e9540dda/airflow-log.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/4XkuIbWLKoTk3S0k2k7vl5/41a71e9051c7fc2e6e0bffb9e9540dda/airflow-log.png?w=323 323w,\nhttps://images.ctfassets.net/tushy4jlcik7/4XkuIbWLKoTk3S0k2k7vl5/41a71e9051c7fc2e6e0bffb9e9540dda/airflow-log.png?w=647 647w,\nhttps://images.ctfassets.net/tushy4jlcik7/4XkuIbWLKoTk3S0k2k7vl5/41a71e9051c7fc2e6e0bffb9e9540dda/airflow-log.png?w=1293 1293w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>Airflow의 Task 로그는 PV를 통해 영구 볼륨에 저장하거나 <strong>Remote Logging</strong> 설정을 통해 외부 저장소로 수집할 수 있습니다. S3, ES, GCS 등 다양한 저장소를 지원합니다.\n예를 들어 S3로 설정하면 Task 로그의 수명주기를 S3 Lifecycle에 의해 관리할 수 있게 됩니다.\n참고로 2.0 버전부터 로그 관련 설정은 <code class=\"language-text\">core</code>에서 <code class=\"language-text\">logging</code> 섹션으로 이동했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">logging:\n  remote_logging: \"True\"\n  remote_base_log_folder: \"s3://mybucketname/airflow\"\n  remote_log_conn_id: \"aws_default\"\n  logging_level: INFO</code></pre></div>\n<br>\n<h2 id=\"airflow-metrics\" style=\"position:relative;\"><a href=\"#airflow-metrics\" aria-label=\"airflow metrics permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow Metrics</h2>\n<p>Airflow는 <a href=\"https://airflow.apache.org/docs/apache-airflow/stable/logging-monitoring/metrics.html\">StatsD를 통한 메트릭 전송 방법</a>을 공식 지원합니다.\nK8S 환경에서 많이 사용하는 Prometheus을 통해 메트릭을 수집하는 방법은 아래와 같이 2가지가 있습니다.\nOfficial Helm Chart의 경우 statsd-export를 통해 전송하는 방법을 지원하고 있습니다.\n<code class=\"language-text\">Values.statsd.enabled</code> 옵션을 통해 쉽게 설정하실 수 있습니다.</p>\n<br>\n<p><strong>1. airflow-prometheus-exporter</strong>:\nairflow model 객체를 활용하여 prometheus metrics collector를 구현한 모듈입니다.\nstable/airflow chart에서 옵션을 통해 설정할 수 있으며 airflow plugin 형태로 구현되어 있어 UI의 /metrics 경로에서 로그를 확인할 수 있습니다.</p>\n<p><strong>2. airflow-statsd-exporter</strong>:\nstatsd는 UDP, TCP를 통해 메트릭을 수집에서 전송하는 프록시입니다.\nairflow에서는 공식적으로 statsd를 통해 메트릭을 지원하고 있습니다.\nofficial helm chart에서는 statsd를 통해 메트릭을 수집하고 exporter를 통해 prometheus에 저장할 수 있습니다.</p>\n<br>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 56.55172413793104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAXCAMAAABODP0nAAACnVBMVEX////N1Papt/D3+P2brO5Edebo6/r+/v7///79/f79/f37/P38/P3v8vzi5vjh5fm5xPPq7fvv8fzd4fnM0/aAmOvK0e/y8/Pw8fLw8vLv8PLu8PLx8vT+///g5PmEnOy0wO3v8fLv8PP8/f35+v/b4PPl6O3r7e7h5O28xu3T2O3q7O7o6u3s7fD+/v/g5Pbh5e7o6+7Hz+3EzO3n6e7p6+77/Pz19vbs7u7L0u2arPCvu+3r7O/8/Pz6+vr4+Pj9/fz09fTr7O7i5u+gsO+dru/f4+7q7O/5+v7O1fbZ3/jz9Pbf4uuzveTP1efs7vD19fX39/jj5ejAyOW9xeXj5enu8PyuvPG0wPDt7/Px8vPw8fPv8fPn6evi5OXk5ufs7vH4+Pnk5ejj5OXk5ujg5fba3u3j5u7L0u7Y3e7q6+7u7/L///35+fr5+vr6+vv6+/v6+/z29vf3+Pj09PTs7e7R1+6ywPS6xPDy9Pzj5/n5+fn19ve4wujO0+mdre5Fdefq7fr9/v74+frl5+nh4+Xi5Obo6+3J0fWltO/s7/vm6fr7+/78/P67xvKxvvH4+f39/v37+/vs7Ozu7u7s7O3v8PH7+/z5+vuQpO3T2vX8/Pv6+/r6+/6puPCIn+vj5vHt7/Hw8PDx8fHi5vqmte7W2+3d4e3m6O7o6u7q7fjZ3u2/yO3Gzu309fa7xe34+fnc4O6bre+jsu7l6O7U2u2Yquzr7e/z8/P29/jByOTJz+Xr7O3y9PXn6u3m6OrR1N7e4eXr7fDQ1erR1eXV2ebQ1uv3+Pny8/Ty8/Lv8fqisu+mtfCIn+xsi+nr7vn+/v39/v/g5fn19/78/P+/yfTI0PXFzvWwvfH6+v/h5fjEzfTz9f2+yPPh5vkx7aYEAAACBklEQVQYGa3BPUiUcQDH8e/vuefu/7+n614sdIkIF2lQiigbCmt1EIMWwaUlSBrEslApybo4qAZLMEiXhgZpcKlcWhovhF6huwJ7sUIhHKzLx5d7euTSc2zo8+HfyYnwD4SrUOCwTrDmruIACuSs+GxyiSu0wIaasv1BhWELgU1oXeBI+sJuyQ+EXTZanvfZ5AJpbShCWlqJKYTyhiqB8ZvLEYX8pbRC83UKrUYX8vaY9JgKFyLs/FTrSYVk/Uw6M3ni51yDpI81sJSUOgTSwiMHAohGM5mMS4Znk6QhnU6lCNmJZHJuezKVerEHwdmRQ82SggDdBaKnFJHWyowBXU9aJT3l21eXPpl8noqmAr5/B1qOZIGmgm+9aW+/Sh44xGL9WBMaMubkADaRsObgWxMqgGHxsLWdv9sROYXOs+GWpO7hC7Xz+LcVKtJQLO8Nzgjs8XbpddP9fYEzDOOS+i6Rvd5vZ++hd1kqBHZMupLs0dXLD6Z8mNDoaVc5UN4rscmBoDOebfv12dTdxAFiowfisdhgqcYezVHlQIRxjxuN9IIGprz44vRDay2zHfleqlwI6NHFVm3r0rmZrFfKl4YSknZ1D/qGKheEN/I9rrZoy8orSlyL7FAop7xhC4FXAl5Kjfz1RusaMPhslfA8zxafvzdDXoUZttZYz0sYqkTFB6me/+IPG1GRLJiaR00AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"airflow-mon\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/1zXAgK4SzbiJPqbJkfKlaS/53bd066e8011479c197296bc0cefa14e/airflow-mon.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/1zXAgK4SzbiJPqbJkfKlaS/53bd066e8011479c197296bc0cefa14e/airflow-mon.png?w=363 363w,\nhttps://images.ctfassets.net/tushy4jlcik7/1zXAgK4SzbiJPqbJkfKlaS/53bd066e8011479c197296bc0cefa14e/airflow-mon.png?w=725 725w,\nhttps://images.ctfassets.net/tushy4jlcik7/1zXAgK4SzbiJPqbJkfKlaS/53bd066e8011479c197296bc0cefa14e/airflow-mon.png?w=1450 1450w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>수집하는 과정은 위의 그림과 같습니다. statsd-exporter는 Deployment 형태로 배포되며 수집 어노테이션이 정의되어 있습니다.</p>\n<br>\n<h2 id=\"monitoring\" style=\"position:relative;\"><a href=\"#monitoring\" aria-label=\"monitoring permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Monitoring</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 47.854588796185936%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"airflow-grafana\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/jcdEsS57RUBfhTQyNx67X/fd363a47e8bedf709df7f117b3f74b4a/airflow-grafana.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/jcdEsS57RUBfhTQyNx67X/fd363a47e8bedf709df7f117b3f74b4a/airflow-grafana.png?w=839 839w,\nhttps://images.ctfassets.net/tushy4jlcik7/jcdEsS57RUBfhTQyNx67X/fd363a47e8bedf709df7f117b3f74b4a/airflow-grafana.png?w=1678 1678w,\nhttps://images.ctfassets.net/tushy4jlcik7/jcdEsS57RUBfhTQyNx67X/fd363a47e8bedf709df7f117b3f74b4a/airflow-grafana.png?w=3356 3356w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>Prometheus에 저장된 메트릭은 Grafana를 통해 데이터 소스로 지정하고 원하는 지표를 시각화할 수 있습니다. 위의 대시보드에 활용한 지표는 다음과 같습니다.</p>\n<ul>\n<li>Airflow Scheduler Health</li>\n<li>Number of Queued Tasks</li>\n<li>Number of Running Tasks</li>\n<li>Scheduling Delay by DAG</li>\n<li>DAG Import Time</li>\n<li>DAG Running Duration</li>\n</ul>\n<br>\n<p>사용자가 작성한 DAG은 Parser를 통해 객체로 변환되고 메타데이터 DB에 저장되는데 <code class=\"language-text\">DAG Import Time</code>은 이 과정을 수행하는데 있어 걸리는 시간을 의미합니다. 위에 언급된 지표 외에도 다양한 지표를 지원합니다. 자세한 리스트는 <a href=\"https://airflow.apache.org/docs/apache-airflow/stable/logging-monitoring/metrics.html#counters\">Airflow Metrics 공식 문서</a>를 통해 확인하실 수 있습니다.</p>\n<br>","excerpt":"최근 Airflow에는 Kubernetes 지원을 위해 다양한 컴포넌트들이 추가되고 있습니다. 이러한 변화의 흐름에 따라 Airflow…"}}}},{"node":{"title":"Airflow on Kubernetes (2)","id":"a73decb2-8523-53c8-9b48-c654959c3da1","slug":"airflow-on-kubernetes-2","publishDate":"July 12, 2020","heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiFBMeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgjileglOuFeTk6fC2ZH6BKV7ugEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":5,"html":"<p>최근 Airflow에는 Kubernetes 지원을 위해 다양한 컴포넌트들이 추가되고 있습니다. 이러한 변화의 흐름에 따라 Airflow를 Kubernetes 위에 배포하고 운영하는 방법에 대해 글을 작성해보고자 합니다. 이 글은 시리즈로 연재됩니다.</p>\n<ul>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-1\">Airflow on Kubernetes (1): CeleryExecutor</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-2\">Airflow on Kubernetes (2): KubernetesExecutor</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-3\">Airflow on Kubernetes (3): Airflow Logging, Monitoring</a></li>\n</ul>\n<br>\n<h2 id=\"airflow-on-kubernetes\" style=\"position:relative;\"><a href=\"#airflow-on-kubernetes\" aria-label=\"airflow on kubernetes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow on Kubernetes</h2>\n<p>지난 글에서는 <a href=\"https://github.com/helm/charts/tree/master/stable/airflow\">stable/airflow</a> helm chart를 이용하여 CeleryExecutor의 각 모듈을 Kubernetes 위에 올리는 방식에 대해 설명하였습니다. 이번 글에서는 많이 사용하는 Airflow Helm Chart에 대해 알아보고 최근에 추가된 <strong>Official Airflow Helm Chart</strong>를 이용하여 KubernetesExecutor를 배포했을 때 어떤 아키텍쳐를 가지는지에 대해 설명드리려 합니다. 먼저 많이 사용하는 차트는 아래와 같이 3가지가 있습니다.</p>\n<br>\n<p><strong>1. stable/airflow</strong>:\n다양한 옵션을 지원하고 많이 사용하지만 커뮤니티 버전입니다.\n공식 릴리즈 이후에 개발이 중단될 예정입니다.</p>\n<p><strong>2. astronomer/airflow-chart</strong>:\nAirflow as a Service를 개발하는 astronomer에서 공개한 차트입니다.\nairflow 2.0의 공식 차트로 활용될 예정입니다. (merge된 상태)</p>\n<p><strong>3. apache/airflow-on-k8s-operator</strong>:\nKubernetes Operator를 활용한 방식으로 위와 다른 구성을 가지고 있습니다.\n구글에서 apache에 기증했으며 GCP의 Composer에서 활용되고 있다고 알려져 있습니다.</p>\n<br>\n<p>이외에도 최근에 공식 차트가 <a href=\"https://github.com/apache/airflow/pull/8777\">PR-8777</a>을 통해 merge 되었습니다.\n아직 정식 릴리즈는 아니지만 큰 이슈는 없는 것으로 보여 공식 차트 기준으로 설명하겠습니다.</p>\n<br>\n<h2 id=\"airflow-executor-on-kubernetes\" style=\"position:relative;\"><a href=\"#airflow-executor-on-kubernetes\" aria-label=\"airflow executor on kubernetes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow Executor on Kubernetes</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 47.56972111553785%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAATCAMAAADVnb8xAAAAulBMVEX////8/Pz4+Pj+/v7u8Pm3weq0vurJz+7///7//v7+/f36+Pb5+Pb49vX7+ff//v339/f7+/vr7fertuens+bAyOz9/f359/b39fT+/fz5+fn7/P3Bye2tueiwuun09fz6+vr5+fj7+/y/yOyqtuetuOjz9fz19fX///36+vnZ3fKfreWWpePR1vH+/v3j5vW5w+uzvend4fX09PT8+/r29vX29vb5+v7u8Pf6+fj29vf9/v/6+v39/PxYrYZrAAAA6ElEQVQYGZ3B11LDMBQE0L13KSJALFEWME1U0zum//9vkcngBEZ5AM7B75kbMTU9M0uQDCHMcag3v7DYrzBmMTEsLa+sCiQGAod6/bX1foVCtVHXDJtb2zu7+BKEkvKeO7l/cHh0jA5RMsuNYyCcnDoZzs4vLkGUTFbnRABXOZO4vrm9A1GS6vumIcbCw2NCSShYNpSECSy3GcQPwgQyNxKWjOgIE1huCJm3TnSECWSeSQLEiIiScusUQWKE4ndiRySFP3l6bh2KraqX1+hR8BiJOnqMhu/e3k2ADOEjJUtESgmwNED8wyfnMQ+PHxS+iAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"task lifecycle\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/3elcSIiD8oPaLurWJrAgdG/eafa8785a7d101ad8e9d8690383f21f3/task_lifecycle.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/3elcSIiD8oPaLurWJrAgdG/eafa8785a7d101ad8e9d8690383f21f3/task_lifecycle.png?w=628 628w,\nhttps://images.ctfassets.net/tushy4jlcik7/3elcSIiD8oPaLurWJrAgdG/eafa8785a7d101ad8e9d8690383f21f3/task_lifecycle.png?w=1255 1255w,\nhttps://images.ctfassets.net/tushy4jlcik7/3elcSIiD8oPaLurWJrAgdG/eafa8785a7d101ad8e9d8690383f21f3/task_lifecycle.png?w=2510 2510w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>먼저 공식 차트 기준으로 executor마다 컴포넌트가 어떤 형태로 올라가는지 알아보겠습니다.\n컴포넌트는 크게 아래와 같이 구분하고 있으며 위의 그림과 같은 라이프사이클에 따라 동작합니다.</p>\n<ul>\n<li><strong>webserver</strong>: Airflow UI, RBAC, DAG monitoring</li>\n<li><strong>scheduler</strong>: task monitoring, trigger, DAG sync, DAG processing</li>\n<li><strong>executor</strong>: how task instance running (pluggable)</li>\n<li><strong>worker</strong>: task instance processing</li>\n</ul>\n<br>\n<h2 id=\"localexecutor\" style=\"position:relative;\"><a href=\"#localexecutor\" aria-label=\"localexecutor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>LocalExecutor</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAUCAMAAADImI+JAAABwlBMVEX////k6PrEzfTv8fz4+Pyot++4xPK3w/H+/v39/f38/f38/P36+/y8xvOjs+/O1fb+/v78/f/9/f/M1PXAyfP3+P75+v7FzvTCy/T6+/////3r7vuVqO6Em+zT2fL39/f09fb19fb19vbz9fbz9Pb5+fqSpu3b4PP29/f6+vv8/P+/yfOntezh5O7q7O7j5u3e4u3p6+7o6u3n6e3z9PW5xPKruezk5+7h5e3f4+309ffl6O21w9ra4/D7+/vr7O7r7e7k5u6ntu2ise7T2e3s7e75+vrg4+6ltO2isu7Z3e719veMmbEARqdllcz4+fvr7e/e4u6Up+6arPDFze3t7u/o6u7y8/T+/f329/js7e/Y3e6Xqu/N1O3s7u/6+vr4+PeVoLYAVat6odH5+vzq7O/n6evCyeS2wOXi5Orr7O/4+Pno6+7n6ey/x+W5wuXl5+vx8vTQ2OXp7fT5+vvk5ujd3t/e4ODi5Ob3+Pnn6u3m6Orf4OHd39/09PL29fT7/Pzx8vPy8/X///7z8/Pu7u7x8fHw7+/w8PDz8/Ly8/f8/Pz7/P6yvvHv8fultPCisvDW3PbP1fK/yO/19PLy8vAbbKKAAAABU0lEQVQoz2NgIB4wMjETpY6FlY2dg5MLBLi5uNBpboRCHl4+ftzGcAnAmRyC+GzmRFIoJCwiiiQlJi4hiVWhlLSMrJy8gqKSgoKyiirQb2qy6hoKSmCuJoqJWto6unp6+gZ6hkbGJkATTc3M9fQsLEFcK7BCaxtbsOEMdvYODo5Ozi6uhkYqQAE3PQcHdw9PLwdDI2+wQh9fP3+Qvxg0DQ0DAoOCQ0L1wsI5OSMiDfWiooNiYuMMw1Q44u04EhKTklNgClPT0jMysyAmZucYpubm5RdkwUwsLCoGhxRDiZGRYWlZeQXEjQyVVUaG1TW1pYZhUDcm1NWDFHIzcCkoWHl7K3hbKYB8zdCgbFXYaNJUWKiA6mtYJDUjhWVLa1t7RydaOHJBqJIuQjHTDSZ7tHuxxiQ3QiE44XD09U+Y2MzJhQG4MbROmixGXPKdMpWDgSoAAB6tQoLweWe+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"local\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/45idFgE5WjfADlRxw6HqW2/f7b3eaaf9173a8e53d8496fa6797c0a6/local.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/45idFgE5WjfADlRxw6HqW2/f7b3eaaf9173a8e53d8496fa6797c0a6/local.png?w=295 295w,\nhttps://images.ctfassets.net/tushy4jlcik7/45idFgE5WjfADlRxw6HqW2/f7b3eaaf9173a8e53d8496fa6797c0a6/local.png?w=590 590w,\nhttps://images.ctfassets.net/tushy4jlcik7/45idFgE5WjfADlRxw6HqW2/f7b3eaaf9173a8e53d8496fa6797c0a6/local.png?w=1180 1180w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>LocalExecutor는 Scheduler에서 각 task가 subprocess 형태로 돌아가는 구조입니다. Scale-Out이 어렵기 때문에 간단한 테스트 용도로 사용하는 경우가 많습니다.</p>\n<br>\n<h2 id=\"celeryexecutor--dag-pv\" style=\"position:relative;\"><a href=\"#celeryexecutor--dag-pv\" aria-label=\"celeryexecutor  dag pv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CeleryExecutor + DAG PV</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 68.25396825396825%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAbCAMAAAA5zj1cAAAC3FBMVEX////m0dD++vns4N/JhH/szcz+///9/f7dxcTBX1bkrqr//v79/f3+/v/7/P/39/fm29r18fH+/v78/P7AyvOwvfHs7vv8/f36/Pz8+/n///3v8fqntvCtu/HU2vb///79/v719vy3we3V2vT+/v38/Pza3/jM1PX7+//7+/vV2vY2cOaBmev4+fz6+vrj5/rs7/z29vbx8/yltPDH0PX5+v7c4fjy9P35+fnh5fmYqu6er+/z9fr6+/v4+Pj7+/z6+vv5+vv8/P3N1PaTpu2xvvH4+Pnt8Pydru6ntevn6u7q7O7e4Obp6+3p6+7o6u3x8/Td4vmRpey5xOzr7e7f4ef29/ja3+rm7PTx8vfs7e7N1O2ks+3EzO3x8/Xr7fPr7O6/yO2ls+3S2O329/nKztYAS6FWjsnx8/j29vfs7u+zvu2fsPKmte3r7O/o6+7w8vTw8fPp6++hsO2er/G6xO3t7u/q6+7o6u719vf//v3Cxs8ATqJXj8nx9PjX2+awu+PS1+fP1OexvOTc3+nr7e/4+fnS2OTg5u/09ffn6u3h4uTg4uLh4+Tx8vTv8fPi4+Xg4eHj5ef29vT39vX8/fz3+Pn4+fr5+fr39/j9/f/x8/2uu/HM1Pbi5vnS2PeRpe6suu/s7vLx8vPy8/Pw8vPv8fLu8PLz9PbJ0fWAmeyksuzw8fLv8PDv8PPv8PLR2PPW2+3d4e3Byuzi5e7k5+7Cyuzc4O3FzezU2u33+P7J0fDb3+3a3u3EzOzj5u74+Pevu+2Cm+61wOzCy+2Gnu6js+zO1O6Koe6PpOyltO2ntvK8xuz39/nHz+6Tp+3J0O7V2+/d4e+fsO6ptuzo6u+2weySpezO1O3g4uXU19/d3+He3+HW2ODa297e3+Da3eTb3uLq6+3i5OfT1t3o6evt7vHs7e/t7vDu7/Lt7/Hy8/Xt7/Lu7/Ht7/Dw8PDy8vLv7+/t7u7x8fG3r+1XAAACW0lEQVQYGZ3BP2iUdwDH4c/3/XPv29zv3vfNm0v0ktbToraIQ4uDQ1ALQulQqkOHTJ1E1OLgIKWODoIgETqmRIcOTboExyyCIAFFuzgETEMbHGKJ9x7aV5O7M3n7vpcIZ0kHfR7ekyz+h+hlK9diOw69XOVabMeCSsAbnue9LLEtiwHPG2KL75fwhtmOGFGuAR0XOrXMkvSUQgcXqDUSCjZZXCotttv11ocvsF/19bmuu2HcFuweetJut2GVgsXAY98HnI+fpLkl3/cfjez4KE3TcIkeoj4sqVGVNmzpNoXj0hp2qSU0Vyah4EAgKUTasCW6AilcdUpZG534LebYTk1h0ZjtV18YRdEHENA1U+mYwbgSGgiA/WF4BgeIXq4OSepf3CtDjWV2xs2VT7Rp3/CoclhAJPtVtVp9wV9Jmi4spOkfHCAJc/MsLjy6Ui6XL2MB0eiepjGmaY9+xqZdsd0MguDegZjcTWPAAYzmMcpWT/IrmybOr+FZG1/BnRgWzlMwTPBfAbmYQhzTZTHwszXJ226M34T6QXqJenRBBbLs90OZLY0xLc0xqrtHtPb8EgkFB/f7SNNjKnhV/eSMQb/UXPla31zbO/IgiemyeHo6mmmHXSei6Nynflz/8u/rK3alUqn/mfzAFguYTT6v5C7OlMvl3fNr/BOv2Bw2xtDDASLNfSvpF3X5CSB77jtpyZ6/yhZh0oe1O1/8COn42cnJU9IgTB0trTvKXuv1rbNxQkGYFPbdl7TurGdOPeFtMQkFh9oyneVjnerzeP1ZlbbnsqXjkhto8G7+BVryrBrc49g2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"celery3\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/5p5hiUjVWUHOBKRYwHovZV/4d4786a674ddec022cb25333b9e715b1/celery3.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/5p5hiUjVWUHOBKRYwHovZV/4d4786a674ddec022cb25333b9e715b1/celery3.png?w=315 315w,\nhttps://images.ctfassets.net/tushy4jlcik7/5p5hiUjVWUHOBKRYwHovZV/4d4786a674ddec022cb25333b9e715b1/celery3.png?w=630 630w,\nhttps://images.ctfassets.net/tushy4jlcik7/5p5hiUjVWUHOBKRYwHovZV/4d4786a674ddec022cb25333b9e715b1/celery3.png?w=1260 1260w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>CeleryExecutor는 Scheduler가 task queue에 작업을 전달하고 worker에서 작업이 수행되는 구조입니다. 지난 번 글에서 언급했듯이 여러 노드에 걸쳐 있는 DAG 파일을 동기화하기 위해 <strong>PV, git-sync</strong> 2가지 옵션을 지원합니다. 이 옵션은 KubernetesExecutor에서도 지원합니다.</p>\n<br>\n<p>위의 그림에서는 AWS EFS를 기준으로 표현했지만 다른 스토리지에서도 활용 가능합니다. 이 방식은 스토리지를 별도로 두기 때문에 git과 다르게 배포 주기를 가져갈 수 있습니다.\n그리고 worker pod이 <strong>statefulset</strong> 형태로 변경되었습니다. 이를 통해 각 worker에 PV를 연결하고 airflow UI에서 각 task의 로그를 볼 수 있습니다.</p>\n<br>\n<h2 id=\"celeryexecutor--dag-git-sync\" style=\"position:relative;\"><a href=\"#celeryexecutor--dag-git-sync\" aria-label=\"celeryexecutor  dag git sync permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CeleryExecutor + DAG git-sync</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 67.06349206349206%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAbCAIAAACBclo5AAAEl0lEQVRIx8VW21IbRxDVH/k78if5hLwlD67kwamkYldMxVUJxgYDdhzAOIbCgB0gkQMoIIS5CHSXdrW7c9v7fZWeXSQtWAhIueKuqVHvqHvOTPf0mcl0PpFkrm96VDPKLev/BhaR8/lI+f6LFtPdjwkchh3Xi4bYhVFnfRfnT7TYOOx0oo8A7PnR8l/6r0uqhDz4jD6QGCxQVaZpahSFuq5TSh3XHWg80H0wMFW9yVfs+Wt1vwgpjMJwQEtJEPgu/MBYyiAc6AUtCIKB2Jl41WGx6mzumcOjnYggOUcl4/ohvWzTZ8ADHcKuBLHAmGkFEy/pLzO01nLiNEdJvnu2H2IMA45nDNe2jN3DfrW4rtvz1HUt+YTT8HSRjUxjhfjwKSNv6U+tVHN6lp7n3gy4VHe/HcPfP0aImJZlGaZJKNPhh+uWZpiOczaj64WGFSR6dsf85mc0Po/BBizBnlD1TDdNTTc93x8e6shxo5Wsur6NFESKFXxSwQomkkIOTnCljiUFq3o6r2cTETWYf0N3D7CMuGW1wb0EiRSOUFPgXpbtJPNzY6pNLeTXdoUw/sx067JjOzYm5LRKHs/T8XlSbZL8IR6doRMvcUvEWhc4yWdvCTCOKcnt4/F5Nr3AV7D6Dj+cZS9WEegA3Nvxm41c5taDW19tYNU+B2xaNpgC8I9TZGSa1Jo0f0juTpDRGdxqE1Uzou5B832/e5RCpuoIk+0CvvuEPpoDYLqSxT+Mk9llvgiYMzmYYJnfL372xdztyYLl+BeBIbZNQdzcKef2qqIki5KSzVUPjlsygh2bfRZL7RiAwaveFLPblcJBTUG41mxvbFZLVRGAbcfthRq82jI/Of0cp4HbMhJESWhLksyTBArAw/ilwJpx5tWWwBHAEh16GL8A7LqO1y2WTGoiHssgiScPKe/9IPCgRFwvCW/CV+eJOuUVhJ7nBz33mLOGneoEWDdD3x9AIxdGDDMgLOh9qnp6/50bEwgQwsNZ+semAbtKW9u27Qd9GMcNny2y0VnaVvgaj8rO2BzdyBm9FAAHRKmb42pgQfbvTZLfXhMZMcp4g2MQN5oofFBlgsQePEP3nkCx8nts58D68ic09QphyjDhZphQ0BFhCDMFM8hxNCgM57i60jDLdYwIp4LZZaVUI9UGmVtR9ou8nH5/q2zmOT/k3zf+KQideK4g7ByXtXqLAO3AX3tHeGENleuwehKfuHMEcmmOgUDk2P/5Ev56FCDR27/xnUd0dAZt7ZHvxumdMeAjIrTbCkLd+yDSdB28+GFWyNgcnlrQFtehsGkMTGzbvRo4KScF01yBQDx33pNiGS4ivLYFpcn5C8hIQhQwqKqn6xgg4xXT1Sy6PyXvH2MI/Q2ADdMWZU43tXrz8Lh0Wq5AOz6BdnpaKpeqjdNyFSobAkiY1vOHRYi84jl2oyWCY1vmdQ+rEa8dahdmhB3AjvhhiXuuE8YVpoEOMJQBPVup6rLgLz6u6izVA0PBOBAAgF4B3CsJxpiqqvCqwhhDr8bCYrnsAfUfXyBAMf3HBrAVCL8J+GUQ9/0W3lyGvbk+ifwLeSgZA665A00AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"celery4\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/3ZgJBdBXHTXvfqzRkRlroV/029606fb3f630f35939c4be45de6ab8f/celery4.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/3ZgJBdBXHTXvfqzRkRlroV/029606fb3f630f35939c4be45de6ab8f/celery4.png?w=315 315w,\nhttps://images.ctfassets.net/tushy4jlcik7/3ZgJBdBXHTXvfqzRkRlroV/029606fb3f630f35939c4be45de6ab8f/celery4.png?w=630 630w,\nhttps://images.ctfassets.net/tushy4jlcik7/3ZgJBdBXHTXvfqzRkRlroV/029606fb3f630f35939c4be45de6ab8f/celery4.png?w=1260 1260w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>git-sync 옵션을 사용한다면 위와 같은 그림으로 구성됩니다.\nairflow의 각 컴포넌트에 git-sync 컨테이너가 sidecar 형태로 추가됩니다.\n이 방식은 <strong>DAG 전용 git repository가 있다면 자동으로 배포를 구성할 수 있다</strong>는 장점이 있습니다. 처음 차트를 배포할때 init container 단계에서 git clone을 수행하고 이후부터는 git-sync 사이드카 컨테이너를 통해 주기적으로 pull을 수행하게 됩니다.</p>\n<br>\n<h2 id=\"celeryexecutor--keda-autoscaler\" style=\"position:relative;\"><a href=\"#celeryexecutor--keda-autoscaler\" aria-label=\"celeryexecutor  keda autoscaler permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CeleryExecutor + KEDA AutoScaler</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 583px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 85.76329331046313%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"keda1\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/w8juWviWwsFWzYn3oA0hQ/5f47b74cd9e3b94ebcfb10aa7254d0d9/keda1.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/w8juWviWwsFWzYn3oA0hQ/5f47b74cd9e3b94ebcfb10aa7254d0d9/keda1.png?w=146 146w,\nhttps://images.ctfassets.net/tushy4jlcik7/w8juWviWwsFWzYn3oA0hQ/5f47b74cd9e3b94ebcfb10aa7254d0d9/keda1.png?w=292 292w,\nhttps://images.ctfassets.net/tushy4jlcik7/w8juWviWwsFWzYn3oA0hQ/5f47b74cd9e3b94ebcfb10aa7254d0d9/keda1.png?w=583 583w\"\n        sizes=\"(max-width: 583px) 100vw, 583px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p><strong>KEDA AutoScaler</strong>는 공식 차트에만 추가된 옵션입니다.\n기존의 Horizontal Pod Autoscaler는 리소스(CPU, Memory) 메트릭을 기반으로 스케일 여부를 결정하게 됩니다. 반면에 KEDA는 <strong>특정 이벤트를 기반으로 스케일 여부를 결정</strong>할 수 있습니다. 예를 들어 airflow는 metadb를 통해 현재 실행 중이거나 대기 중인 task가 얼마나 존재하는지 알 수 있습니다. 이러한 이벤트를 활용하여 worker의 scale을 결정한다면 queue에 task가 많이 추가되는 시점에 더 빠르게 확장할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> ceil<span class=\"token punctuation\">(</span><span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>::<span class=\"token keyword\">decimal</span> <span class=\"token operator\">/</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> task_instance\n<span class=\"token keyword\">WHERE</span> state<span class=\"token operator\">=</span><span class=\"token string\">'running'</span> <span class=\"token operator\">OR</span> state<span class=\"token operator\">=</span><span class=\"token string\">'queued'</span></code></pre></div>\n<p>이를 위해 airflow에서는 KEDA의 <strong>PostgreSQL trigger</strong>를 활용하였고 실제 위와 같은 쿼리가 등록되어 있습니다. KEDA는 CRD와 custom controller로 구성되어 있기 때문에 기존 HPA와 함께 사용 가능하며 모든 K8S 클러스터에 추가할 수 있습니다.</p>\n<br>\n<h2 id=\"celeryexecutor-vs-kubernetesexecutor\" style=\"position:relative;\"><a href=\"#celeryexecutor-vs-kubernetesexecutor\" aria-label=\"celeryexecutor vs kubernetesexecutor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CeleryExecutor vs KubernetesExecutor</h2>\n<p>여기까지 CeleryExecutor에 대해 알아보았습니다. CeleryExecutor 또한 Kubernetes 위에 배포하면 Helm 차트를 통한 선언형 리소스 관리, 쉬운 버전 업데이트, DAG 배포 자동화, 쉬운 리소스 확장 등의 장점을 가질 수 있습니다. 하지만 Celery에 대한 의존성이 남아있기 때문에 Redis, Celery Worker에 대한 리소스를 계속 점유하고 있어야 합니다. 다시 말해서, <strong>Scale to Zero</strong>가 어렵다는 단점이 있습니다. KubernetesExecutor는 task가 존재할때만 pod이 생성되고 task가 완료되면 종료되기 때문에 더 리소스를 효율적으로 사용한다고 볼 수 있습니다.</p>\n<br>\n<h2 id=\"kubernetesexecutor-kubernetespodoperator\" style=\"position:relative;\"><a href=\"#kubernetesexecutor-kubernetespodoperator\" aria-label=\"kubernetesexecutor kubernetespodoperator permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>KubernetesExecutor, KubernetesPodOperator</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 407px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 51.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAVCAMAAAADxFwsAAABmFBMVEX////9/f/e4/ns7/vi5vnk6PrY3fiJn+wAX+RkhejAyvPv8fzh5fmYqu4PZOWKoOy+yfPm6vrY3vgAYeQAUuOSpe2zv/GCmuv8/f/p7PtQeucUZOUrauWntvCDm+tWfefz9f2yvvG5w/KxvfG5xPKzvvE9cebu8fzM0/WKn+zCzPTHz/XL0/amtfAAXeTd4viHnexdgejI0PXByvO+yPOyvfEAWuTX3feFm+vS2ff3+f7y9f1qiem7xvP9/v+DmutcgOjJ0PW/yfMAWeSks+9siumcre7q7ftgg+i2wvLg5PlEdOYjZ+VXf+hUfOcAW+SbrO7u8PxniOkTZuVihemzwPKUqe59luv09v3Gz/VHdudzkupjh+l3kure5Plzk+tykepykuuDnezn6/vr7/3o6/zm6vv19//u8P7n6vzn6/zw8v719fXt7e3v7u7v7+z7+vf19fPu7u7s7Ov7+/v+/v3r6+rr6+ny8u/19PLw8O/+/v7m5ubY2NjQ0NDLy8vPz87X19fPz8/R0dH5+fnMzMvU1NP9/f3BXEGgAAAAtklEQVQoz2NgGJ6AkYkZVYCFFVkWzmJjBIGvcD4PmP8eQ6EQIyMDSOYFlC/JCAEPYMbDFPL/5GBEVsgPVciAoRBN4qv0G1FkPhOUtuPn52fge8gL4zOo8ypx3uPh4cFwoxfEwI3/ofxAqA0rMHwdCRI+/ADOjwOrm4tuNQPDci4gQKhjWMQJBHMxwjGHERo8jD0QgVKoQCuarwVAav6wIrzJ/5eFgfEPwycsUVgNRiigvWRIJUIAbBgcR71IxjgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"kubeexec2\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/7aImqhPOqW08NxOj0rGEjK/aa9cf6a2be5efeea4fcf8496d9c4526b/kubeexec2.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/7aImqhPOqW08NxOj0rGEjK/aa9cf6a2be5efeea4fcf8496d9c4526b/kubeexec2.png?w=102 102w,\nhttps://images.ctfassets.net/tushy4jlcik7/7aImqhPOqW08NxOj0rGEjK/aa9cf6a2be5efeea4fcf8496d9c4526b/kubeexec2.png?w=204 204w,\nhttps://images.ctfassets.net/tushy4jlcik7/7aImqhPOqW08NxOj0rGEjK/aa9cf6a2be5efeea4fcf8496d9c4526b/kubeexec2.png?w=407 407w\"\n        sizes=\"(max-width: 407px) 100vw, 407px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p>위의 그림처럼 KubernetesExecutor는 Broker와 같은 리소스를 점유하고 있을 필요가 없습니다. 리소스를 할당하고 스케줄링 하는 역할은 Kubernetes Scheduler가 수행하게 됩니다. Airflow Scheduler는 API Server에게 task 수행을 위한 Pod 생성을 요청합니다. worker는 <code class=\"language-text\">images.airflow</code>에 설정한 이미지로 Pod이 생성되기 때문에 추가로 필요한 파이썬 패키지가 존재한다면 별도의 이미지를 만들어주어야 합니다. 만일 task pod 마다 다른 이미지와 리소스 설정을 가지도록 하고 싶다면 <strong>KubernetesPodOperator</strong>를 사용하시면 됩니다. KubernetesPodOperator는 worker를 통해 pod이 생성되는 구조이므로 파라메터를 통해 사용자가 원하는 설정으로 변경할 수 있습니다.</p>\n<br>\n<h2 id=\"kubernetesexecutor-process\" style=\"position:relative;\"><a href=\"#kubernetesexecutor-process\" aria-label=\"kubernetesexecutor process permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>KubernetesExecutor Process</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 19.869174161896975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAICAMAAAC8jE1pAAABJlBMVEXu58vp5Lvq5b3p48r+/v7////07tzo47nq5NH+/v/+/fvs5cXo47rm4MP7+vn38ujn4c/39fH08uzw7efr6OLu6+f49/j4+Pj5+Pj49/f8+/z//v/59vTx7efz8Or39fL29O/z8ev08u78+/n29PL+/f76+fr7+vv6+fn8+/v+/f39+/z59/j29vb39vb39/f//v7//f78+vv7+/v7+vr9/f38+vr29PX29fX49vb59/f29fb7+fn+/P38+vz29Pb08/T19PT08/P8+fv9/P38/Pz9/f79/P738uP18tv07tjy7tbx7d/9/Pz18dr18uf//v328uD079/7+PL08Obv69rp5c3q5s7q5tf18ebp5czs6Nz+///t6NXo49L49e/p5Mzq5txrQcUEAAAA2ElEQVQYGV3BvUrDUACG4fdLzjltkkoiShcX9+rkJLg5uTgJXqM34TU4WIeKIBZc4uBZmrb5OabEgvg8QgqRxEBCahhYCamCtMWYQw0CUYi088mv+kSt+RAcd62T5VTSd0FP8oXKqSiZdl/FaH72zJ4sszl/nEuEFalCVONUhWyFUv8a8c+4NputcXZrXRaW3o4atzHxEbJcqrHrpEoDsGWsl9zn9PxMemTPXKv3NpnESeVzv7iKVZaU7GRa35jlE9zWOHMghei9YXAndP/AYHGRYDpgUjv9AEykRBreSQzjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"k8s-happy-path\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/2usGvGAxaTlKGcNVJZcawO/37094fe04db84de87652672da1f50543/k8s-happy-path.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/2usGvGAxaTlKGcNVJZcawO/37094fe04db84de87652672da1f50543/k8s-happy-path.png?w=306 306w,\nhttps://images.ctfassets.net/tushy4jlcik7/2usGvGAxaTlKGcNVJZcawO/37094fe04db84de87652672da1f50543/k8s-happy-path.png?w=612 612w,\nhttps://images.ctfassets.net/tushy4jlcik7/2usGvGAxaTlKGcNVJZcawO/37094fe04db84de87652672da1f50543/k8s-happy-path.png?w=1223 1223w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p>KubernetesExecutor는 위와 같은 프로세스를 통해 동작합니다. 일반적으로 Pod이 생성되는 과정과 동일하며 airflow에서는 내부적으로 python kubernetes client library를 통해 k8s_model 이라는 객체로 K8S API를 추상화하여 사용하고 있습니다.</p>\n<br>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 25.021949078138718%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAKCAMAAADxROxiAAABfVBMVEXv58vq5Lrs5r3r5rzp4bz28/D////y69Xq5Lno4cf8+/z79/Hq47zq5Lvn4MH59/f1797p47jr5brk3Mf18+3w7uXv7OPq597q59/19PT7+/v6+vr7+vr6+fn+/v739O/x7+r9/Pvx7+bv7OTw7eXw7uf8/Pz59/Tw7eTw7ur+/f729fb49vj49vf29PT29fX39vb39fX8+fr7+fv7+/z5+fn//v///v729PX8+vr+/P369vf8+/v7+vv+/f38+vvz7+/18/P39/f4+Pj49PX08/Pz8vL08vLz8fH08vP+/Pz9+/v09PT08/T19PX9/f38+vzx7vDz8fLx7+/x7/Dy8PDy8PHy8PL6+Pr+/P79+vv48+b28t728d3079vy7dv49vT38ub08Nv079rz7uL9+/z8+fb079zz7t/7+fr59ezy7Nf18dzz7+Xr5NHh3L3j3sDi3r/h27/08/Dv6trh3b3i3b3i3Mn6+PPj3sHh3b7i3b7h28T5+Pjf2cpUxWsqAAAA/klEQVQYGXXBQUvCAACG4febc5ktoZIaFaFk1KkUJOrasWvHfmN07NIPqKAU6WgxCHOZsIOrIahrcwpeeh6hKVLSMKcRqawUrCqEvGJFpSJJY1Mh+U9mdpRwoeyvSxYVpRgb/UJO6gKK2O6YXrXJnCxqDRYcGiyHRgRfRVvSO3Zgs/WILM4e+M+5YtGgEP00TBiyoFqQiIzWyXBJo1d/954ZE4pHe8+wudnr1aMP57tjE5D9dUsu2fIdc7K4VIKJwSQj6abWtUkETvPqDa9E3660m7pW4unAhzWffcVaA2KBU1VIXi9dpy7J3FCi3WbqVNKty5R3oUQD73jFzvwBa75NSwLDLFEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"k8s-failed-pod\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/5DNugNWbyej6H0ls4cPuix/426601ff509e37357de86d7521439406/k8s-failed-pod.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/5DNugNWbyej6H0ls4cPuix/426601ff509e37357de86d7521439406/k8s-failed-pod.png?w=285 285w,\nhttps://images.ctfassets.net/tushy4jlcik7/5DNugNWbyej6H0ls4cPuix/426601ff509e37357de86d7521439406/k8s-failed-pod.png?w=570 570w,\nhttps://images.ctfassets.net/tushy4jlcik7/5DNugNWbyej6H0ls4cPuix/426601ff509e37357de86d7521439406/k8s-failed-pod.png?w=1139 1139w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p>task가 완료되기 전에 Airflow DB 상태 업데이트 단계에서 OOM 등의 이유로 Pod Crash가 언제나 발생할 수 있기 때문에 이에 대한 장애 시나리오도 준비되어 있습니다. DB 업데이트에 실패하더라도 airflow scheduler는 Kubernetes Watch API를 통해 pod의 상태를 전달받아 다시 DB 상태를 업데이트 할 수 있습니다. CeleryExecutor의 경우, task 상태에 대한 처리를 celery에 주기적으로 확인하는 방식이라면 <strong>KubernetesExecutor는 이벤트 스트림으로 전달받기 때문에 스케줄러에 대한 부하가 더 낮다</strong>고 볼 수 있습니다.</p>\n<br>\n<h2 id=\"kubernetesexecutor-batch-cronjob\" style=\"position:relative;\"><a href=\"#kubernetesexecutor-batch-cronjob\" aria-label=\"kubernetesexecutor batch cronjob permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>KubernetesExecutor Batch, CronJob</h2>\n<p>공식 차트에서는 사용자의 편의를 위해 RBAC 초기 사용자를 생성해주는 <strong>create-user BatchJob</strong>이 추가되었습니다. <strong>Helm Hooks (post-install)</strong> 를 통해 차트 리소스가 모두 생성된 이후에 수행됩니다. 더 이상 exec 명령어로 bash에 들어가 create-user 명령어를 수행할 필요가 없습니다!</p>\n<p>추가로 <strong>cleanup CronJob</strong>이 있습니다. <code class=\"language-text\">AIRFLOW__KUBERNETES__DELETE_WORKER_PODS</code> 옵션을 통해 task가 끝나더라도 pod이 종료되지 않도록 설정할 수 있는데 이때 내가 원하는 주기마다 오래된 pod을 삭제할 수 있는 CronJob 입니다.</p>\n<br>\n<h2 id=\"official-helm-chart-issue\" style=\"position:relative;\"><a href=\"#official-helm-chart-issue\" aria-label=\"official helm chart issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Official Helm Chart Issue</h2>\n<p>공식 버전 차트는 아래와 같은 이슈가 남아있지만 2.0 정식 버전 출시와 함께 해결될 예정입니다.\n글을 작성하는 과정에서 DAG 동기화 관련 버그를 발견하였지만 리뷰를 통해 곧바로 수정되었습니다. (<a href=\"https://github.com/apache/airflow/pull/9371\">PR-9371</a>). stable/airflow 차트와 비교했을때 아쉬운 점은 아래와 같습니다.</p>\n<ul>\n<li>현재 버전에서는 backend로 postgresql만 지원 <a href=\"https://github.com/apache/airflow/issues/9627\">(ISSUE-9627)</a></li>\n<li>pip 등 작업 실행에 필요한 패키지 설치하는 옵션이 없음</li>\n<li>initContainer를 수정해서 설치하거나 이미지 별도로 생성해야함</li>\n<li>차트에 Ingress 설정에 대한 옵션이 부족</li>\n<li>KubernetesExecutor의 경우 remote logging 설정을 해야 UI에서 로그 확인 가능</li>\n</ul>\n<br>\n<h2 id=\"deploy\" style=\"position:relative;\"><a href=\"#deploy\" aria-label=\"deploy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy</h2>\n<p>사실 배포와 옵션에 대한 내용은 지난 글에서 말한 내용과 크게 다름이 없습니다. 아직 정식 릴리즈까지 변경될 여지가 많다보니 아래 공식 문서 따라하시는 방법을 추천드립니다 <a href=\"https://github.com/apache/airflow/tree/master/chart\">(apache/airflow/chart)</a>. 다음 글에서는 KubernetesExecutor의 로깅과 모니터링에 대해 다루어보겠습니다!</p>","excerpt":"최근 Airflow에는 Kubernetes 지원을 위해 다양한 컴포넌트들이 추가되고 있습니다. 이러한 변화의 흐름에 따라 Airflow…"}}}},{"node":{"title":"K8S 클러스터 초기 설정을 위한 Helm Chart 만들기","id":"d5872346-83a6-5ccf-a333-059ff856bd08","slug":"umbrella-helm-chart","publishDate":"June 20, 2020","heroImage":{"title":"cover-devops","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=270&h=180&q=50&fm=webp 270w,\nhttps://images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=540&h=360&q=50&fm=webp 540w,\nhttps://images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1080&h=720&q=50&fm=webp 1080w","sizes":"(min-width: 1080px) 1080px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1080&h=720&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=270&h=180&fl=progressive&q=50&fm=jpg 270w,\nhttps://images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=540&h=360&fl=progressive&q=50&fm=jpg 540w,\nhttps://images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1080&h=720&fl=progressive&q=50&fm=jpg 1080w","sizes":"(min-width: 1080px) 1080px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,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"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":4,"html":"<p>K8S 클러스터를 설정하고 운영하다보면 <strong>버전 업데이트, 컴포넌트 추가 설치 등 다양한 변경</strong>에 대응할 수 있어야 합니다. 또한 Develop, Production, Staging 등 <strong>목적에 따라 다양한 클러스터를 추가로 설정하고 배포</strong>해야 하는 경우도 생깁니다. 오늘은 이러한 어려움을 해결할 수 있는 <strong>Umbrella Helm Chart</strong>에 대해 정리해보려고 합니다. Helm을 처음 접하신다면 <a href=\"https://helm.sh/docs/\">공식문서</a>를 먼저 보는 방법을 추천드립니다.</p>\n<br>\n<h2 id=\"umbrella-helm-chart\" style=\"position:relative;\"><a href=\"#umbrella-helm-chart\" aria-label=\"umbrella helm chart permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Umbrella Helm Chart</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 626px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 51.91693290734825%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAVCAAAAAARcfPCAAABCUlEQVQoz4WS226DMBBE/f//2IeSqGoD9vq+vjs2IU1FapgHpNk5aFYrk7pTAME5B7Ofk/0AsX+jPAZjjDO7zQs1EEMoQ9Chw6tNtysm6hDtGOzVvpZcc6/2Q7AnHmQT16fgyBKrVkm3JVHq7l92SwnE3FTCcym0pfy1psdBVCLUski2SJ5iVDFlAMoANM8p6ZAS9Z4xU1QDg6cXcH7WWs3G2k/jvy86LNZaKrT6wPIz2SIr4X2RWts/W1c7T3pZ97ANFFyu9/hN2P+W1PLQ6DzP9O2O2awKhwfHXKrQqcmJQzCicxP0pY1ofXj8Ho35mqSfW70/BG2ouS2ozl84KKWVkKdgzavexnf+Bzi/AOCP7gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"umbrella-chart\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/1FRpO4B9PfO0EQO0Be0xTm/73785b39e2363f28430a213c4deb3c04/umbrella-chart.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/1FRpO4B9PfO0EQO0Be0xTm/73785b39e2363f28430a213c4deb3c04/umbrella-chart.png?w=157 157w,\nhttps://images.ctfassets.net/tushy4jlcik7/1FRpO4B9PfO0EQO0Be0xTm/73785b39e2363f28430a213c4deb3c04/umbrella-chart.png?w=313 313w,\nhttps://images.ctfassets.net/tushy4jlcik7/1FRpO4B9PfO0EQO0Be0xTm/73785b39e2363f28430a213c4deb3c04/umbrella-chart.png?w=626 626w\"\n        sizes=\"(max-width: 626px) 100vw, 626px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>Umbrella Helm Chart란 여러 개의 Helm Chart들이 모여있는 집합을 의미합니다. 어디에서부터 시작된 용어인지 모르겠으나 저는 <a href=\"https://kccncna19.sched.com/event/Uacr\">2019 Kubecon - Scaling to Thousands of Nodes (Airbnb)</a> 발표에서 처음 접하게 되었습니다. 사내에 K8S에 대한 요구사항이 빠르게 늘어나던 Airbnb는 멀티 클러스터 배포 전략을 통해 <a href=\"(https://kubernetes.io/docs/setup/best-practices/cluster-large/)\">Node Hard Limit</a> 이슈를 해결하게 되었고 클러스터마다 배포를 위해 Umbrella Chart를 만들어 활용했다고 합니다.</p>\n<br>\n<h2 id=\"helm-chart-만들기\" style=\"position:relative;\"><a href=\"#helm-chart-%EB%A7%8C%EB%93%A4%EA%B8%B0\" aria-label=\"helm chart 만들기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Helm Chart 만들기</h2>\n<p>말로하면 이해가 어려우니 클러스터를 새로 설정한다고 가정하고 예시를 통해 Helm Chart를 만들어보겠습니다. 예시의 클러스터에는 아래와 같은 의존성이 존재합니다. 예시는 Helm 2.16.7 버전을 사용했습니다.</p>\n<ul>\n<li><strong>cluster-autoscaler</strong>: EKS AutoScaling 설정</li>\n<li><strong>grafana</strong>: 모니터링 대시보드</li>\n<li><strong>prometheus</strong>: 시스템 지표 수집 및 저장</li>\n<li><strong>fluentbit</strong>: 어플리케이션 로그 수집</li>\n</ul>\n<br>\n<p>먼저 Helm Chart 생성을 위한 폴더 구조를 생성해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ helm create umbrella\n$ <span class=\"token builtin class-name\">cd</span> umbrella\n$ tree\n<span class=\"token builtin class-name\">.</span>\n├── Chart.yaml\n├── charts\n├── templates\n│   ├── NOTES.txt\n│   ├── _helpers.tpl\n│   ├── deployment.yaml\n│   ├── ingress.yaml\n│   ├── service.yaml\n│   └── tests\n│       └── test-connection.yaml\n├── requirements.yaml\n└── values.yaml</code></pre></div>\n<br>\n<p>기본 생성되는 폴더 구조에서 <code class=\"language-text\">requirements.yaml</code> 파일은 추가로 생성해주셔야 합니다.\n폴더 구조에서 알아두어야 할 경로는 아래와 같습니다.</p>\n<ul>\n<li><code class=\"language-text\">Chart.yaml</code>: 차트에 대한 메타 정보가 들어갑니다.</li>\n<li><code class=\"language-text\">charts/</code>: 의존성이 있는 차트 패키지들이 설치됩니다.</li>\n<li><code class=\"language-text\">templates/</code>: 차트에 필요한 template 파일들이 들어갑니다.</li>\n<li><code class=\"language-text\">templates/NOTES.txt</code>: 차트 생성 시 나타나는 설명이 들어갑니다.</li>\n<li><code class=\"language-text\">requirements.yaml</code>: 의존성 차트들이 들어갑니다.</li>\n<li><code class=\"language-text\">values.yaml</code>: 차트 설정에 필요한 default 값들이 들어갑니다.</li>\n</ul>\n<br>\n<h3 id=\"chart-metadata\" style=\"position:relative;\"><a href=\"#chart-metadata\" aria-label=\"chart metadata permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chart Metadata</h3>\n<p>먼저 <code class=\"language-text\">Chart.yaml</code> 파일을 간단히 수정해줍니다.\n이름과 버전, 설명 등의 정보를 본인에 맞게 작성해주시면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">appVersion</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.0\"</span>\n<span class=\"token key atrule\">description</span><span class=\"token punctuation\">:</span> A Helm chart for Cluster Setup\n<span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> umbrella\n<span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> 0.1.0</code></pre></div>\n<br>\n<h3 id=\"chart-dependencies\" style=\"position:relative;\"><a href=\"#chart-dependencies\" aria-label=\"chart dependencies permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Chart Dependencies</h3>\n<p>이제 앞서 언급한 의존성 중에 Helm Chart 형태로 배포할 컴포넌트를 <code class=\"language-text\">requirements.yaml</code> 파일에 정의하겠습니다. 각 차트는 이름, 저장소, 버전, 컨디션 값을 지정할 수 있습니다. <code class=\"language-text\">condition: prometheus.enabled</code>의 의미는 <code class=\"language-text\">values.yaml</code>에 <code class=\"language-text\">prometheus.enabled</code> 값이 true 일 경우에만 해당 차트를 설정하겠다는 뜻 입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">dependencies</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> prometheus\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//kubernetes<span class=\"token punctuation\">-</span>charts.storage.googleapis.com\n    <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> 9.7.3\n    <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> prometheus.enabled\n\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> grafana\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//kubernetes<span class=\"token punctuation\">-</span>charts.storage.googleapis.com\n    <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> 4.2.2\n    <span class=\"token key atrule\">condition</span><span class=\"token punctuation\">:</span> grafana.enabled\n\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> cluster<span class=\"token punctuation\">-</span>autoscaler\n    <span class=\"token key atrule\">repository</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//kubernetes<span class=\"token punctuation\">-</span>charts.storage.googleapis.com\n    <span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> 6.3.0</code></pre></div>\n<br>\n<p>이제 <code class=\"language-text\">helm dep up</code> 명령어를 통해 의존성 차트를 갱신할 수 있습니다.\n이를 통해 <code class=\"language-text\">charts/</code> 하위에 차트 파일들이 설치됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ helm dep up\nHang tight while we grab the latest from your chart repositories...\nUpdate Complete.\nSaving 3 charts\nDownloading prometheus from repo https://kubernetes-charts.storage.googleapis.com\nDownloading grafana from repo https://kubernetes-charts.storage.googleapis.com\nDownloading cluster-autoscaler from repo https://kubernetes-charts.storage.googleapis.com\nDeleting outdated charts</code></pre></div>\n<br>\n<p>의존성 차트에 적용할 설정 값들은 <code class=\"language-text\">values.yaml</code>에 정의할 수 있습니다.\ngrafana를 예시로 들면 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># values.yaml</span>\n<span class=\"token key atrule\">grafana</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">adminPassword</span><span class=\"token punctuation\">:</span> mypassword\n  <span class=\"token key atrule\">persistence</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">storageClass</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"gp2\"</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> pvc\n    <span class=\"token key atrule\">size</span><span class=\"token punctuation\">:</span> 5Gi\n  <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP</code></pre></div>\n<br>\n<h3 id=\"templates\" style=\"position:relative;\"><a href=\"#templates\" aria-label=\"templates permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Templates</h3>\n<p>의존성 패키지가 공식 Helm Chart를 지원한다면 <code class=\"language-text\">dependencies</code> 부분에 정의할 수 있겠지만 yaml 파일만 제공하는 패키지도 많이 존재합니다. 이 경우, <code class=\"language-text\">templates/</code> 하위에 yaml 파일을 추가해주시면 됩니다. 외부 설정으로 내보내고 싶은 항목들은 <strong>template function</strong>을 활용해서 수정할 수 있습니다. 여기에서는 <code class=\"language-text\">fluentbit</code>만 예시로 추가하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token builtin class-name\">cd</span> templates\n$ <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-O</span> https://raw.githubusercontent.com/fluent/fluent-bit-kubernetes-logging/master/fluent-bit-service-account.yaml\n$ <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-O</span> https://raw.githubusercontent.com/fluent/fluent-bit-kubernetes-logging/master/fluent-bit-role.yaml\n$ <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-O</span> https://raw.githubusercontent.com/fluent/fluent-bit-kubernetes-logging/master/fluent-bit-role-binding.yaml\n$ <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-O</span> https://raw.githubusercontent.com/fluent/fluent-bit-kubernetes-logging/master/output/elasticsearch/fluent-bit-configmap.yaml</code></pre></div>\n<br>\n<h3 id=\"deploy\" style=\"position:relative;\"><a href=\"#deploy\" aria-label=\"deploy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy</h3>\n<p>이제 예시 차트를 클러스터에 배포할 차례입니다. 배포 후 차트 내 컴포넌트 버전 업데이트가 발생하더라도 <code class=\"language-text\">helm upgrade</code> 명령어를 통해 쉽게 관리할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># install</span>\n$ helm <span class=\"token function\">install</span> <span class=\"token builtin class-name\">.</span> <span class=\"token parameter variable\">--name</span> umbrella <span class=\"token parameter variable\">--namespace</span> umbrella\n\n<span class=\"token comment\"># check status</span>\n$ helm status umbrella\n$ helm get umbrella\n\n<span class=\"token comment\"># upgrade</span>\n$ helm upgrade <span class=\"token parameter variable\">-f</span> values.yaml umbrella <span class=\"token builtin class-name\">.</span>\n\n<span class=\"token comment\"># delete</span>\nhelm del umbrella <span class=\"token parameter variable\">--purge</span></code></pre></div>\n<br>\n<p>만일 어플리케이션들이 모두 별도의 Helm Chart로 관리되고 있다면 Umbrella Chart에서 어플리케이션 차트까지 의존성으로 추가하는 방식으로 운영하는 방법도 있습니다. 요즘에는 Helm 이외에도 kustomize 등 다양한 도구들이 있으니 비교해보고 적절한 방식을 선택하시면 좋습니다.</p>\n<br>","excerpt":"K8S 클러스터를 설정하고 운영하다보면 버전 업데이트, 컴포넌트 추가 설치 등 다양한 변경에 대응할 수 있어야 합니다. 또한 Develop…"}}}},{"node":{"title":"Airflow on Kubernetes (1)","id":"6458380e-9bc8-5184-a818-51a7dd2dbaa6","slug":"airflow-on-kubernetes-1","publishDate":"June 05, 2020","heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiFBMeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgjileglOuFeTk6fC2ZH6BKV7ugEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":5,"html":"<p>최근 Airflow에는 Kubernetes 지원을 위해 다양한 컴포넌트들이 추가되고 있습니다. 이러한 변화의 흐름에 따라 Airflow를 Kubernetes 위에 배포하고 운영하는 방법에 대해 글을 작성해보고자 합니다. 이 글은 시리즈로 연재됩니다.</p>\n<ul>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-1\">Airflow on Kubernetes (1): CeleryExecutor</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-2\">Airflow on Kubernetes (2): KubernetesExecutor</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-3\">Airflow on Kubernetes (3): Airflow Logging, Monitoring</a></li>\n</ul>\n<br>\n<h2 id=\"airflow-on-kubernetes\" style=\"position:relative;\"><a href=\"#airflow-on-kubernetes\" aria-label=\"airflow on kubernetes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow on Kubernetes</h2>\n<p>Airflow를 Kubernetes 인프라 위에서 운영하는 방법은 크게 두 가지로 나눌 수 있습니다.\n이 글에서 소개할 방법은 <strong>CeleryExecutor의 각 모듈을 Kubernetes 위에 올리는 방식</strong>입니다. 기존에 운영하던 형태와 유사하기 때문에 쉽게 적용할 수 있으나 Celery에 대한 의존성이 강하다보니 완전히 Cloud Native한 형태는 아닙니다. 아키텍쳐는 가장 많이 사용하는 <a href=\"https://github.com/helm/charts/blob/master/stable/airflow\">stable/airflow</a> Helm Chart를 참고하였습니다. 이제 몇 가지 컴포넌트 설정과 함께 자세히 알아보겠습니다.</p>\n<br>\n<h2 id=\"config\" style=\"position:relative;\"><a href=\"#config\" aria-label=\"config permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Config</h2>\n<p>Airflow는 <code class=\"language-text\">airflow.cfg</code> 파일 또는 <code class=\"language-text\">AIRFLOW__[SECTOR]__[VARIABLES]</code> 환경 변수를 통해 각 컴포넌트의 설정을 관리할 수 있었습니다. Helm Chart에서는 <code class=\"language-text\">values.yaml</code>의 config 필드를 통해 설정을 관리할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n  <span class=\"token comment\"># CORE</span>\n  <span class=\"token key atrule\">AIRFLOW__CORE__DEFAULT_TIMEZONE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Asia/Seoul\"</span>\n  <span class=\"token key atrule\">AIRFLOW__CORE__PARALLELISM</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"32\"</span>\n  <span class=\"token key atrule\">AIRFLOW__CORE__DAG_CONCURRENCY</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"16\"</span>\n  <span class=\"token key atrule\">AIRFLOW__CORE__MAX_ACTIVE_RUNS_PER_DAG</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"16\"</span>\n\n  <span class=\"token comment\"># WEBSERVER</span>\n  <span class=\"token key atrule\">AIRFLOW__WEBSERVER__DEFAULT_UI_TIMEZONE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Asia/Seoul\"</span>\n  <span class=\"token key atrule\">AIRFLOW__WEBSERVER__WORKER_REFRESH_INTERVAL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"60\"</span>\n\n  <span class=\"token comment\"># CELERY</span>\n  <span class=\"token key atrule\">AIRFLOW__CELERY__WORKER_CONCURRENCY</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"16\"</span>\n\n  <span class=\"token comment\"># SCHEDULER</span>\n  <span class=\"token key atrule\">AIRFLOW__SCHEDULER__SCHEDULER_HEARTBEAT_SEC</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"30\"</span>\n  <span class=\"token key atrule\">AIRFLOW__SCHEDULER__SCHEDULER_HEALTH_CHECK_THRESHOLD</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"120\"</span>\n  <span class=\"token key atrule\">AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"30\"</span>\n  <span class=\"token key atrule\">AIRFLOW__SCHEDULER__RUN_DURATION</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10800\"</span>\n  <span class=\"token key atrule\">AIRFLOW__SCHEDULER__MAX_THREADS</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2\"</span></code></pre></div>\n<br>\n<p>위에 정의한 설정 변수들은 Airflow의 성능과 관련되어 있기 때문에 각자 할당된 리소스에 맞게 설정해주셔야 합니다. 자세한 내용은 <a href=\"https://airflow.apache.org/docs/stable/faq.html#how-can-my-airflow-dag-run-faster\">공식문서 링크</a>를 참고하시기 바랍니다. 위와 같은 방식으로 DAG에서 활용하는 connection, variables도 정의할 수 있습니다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># config.yaml</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> ConfigMap\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>webserver<span class=\"token punctuation\">-</span>config\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> airflow\n<span class=\"token key atrule\">data</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">webserver_config.py</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n    APP_THEME = \"flatly.css\"</span>\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token comment\"># values.yaml</span>\n<span class=\"token key atrule\">extraConfigmapMounts</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>webserver<span class=\"token punctuation\">-</span>config\n    <span class=\"token key atrule\">mountPath</span><span class=\"token punctuation\">:</span> /opt/airflow/webserver_config.py\n    <span class=\"token key atrule\">configMap</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>webserver<span class=\"token punctuation\">-</span>config\n    <span class=\"token key atrule\">readOnly</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">subPath</span><span class=\"token punctuation\">:</span> webserver_config.py</code></pre></div>\n<br>\n<p>위와 같이 <code class=\"language-text\">ConfigMap</code>이나 <code class=\"language-text\">Secret</code>을 따로 만들고 참조하도록 연결하는 방식도 가능합니다. 특히 Airflow 1.10의 RBAC을 사용한다면 <code class=\"language-text\">webserver_config.py</code>를 통해 <code class=\"language-text\">APP_THEME</code>를 변경해줄 수 있는데 이런 경우에 <strong>extraConfigmap</strong>을 통해 적용할 수 있습니다.</p>\n<br>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 54.861111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAWCAIAAAA97EnnAAAEmUlEQVRIx71Wzc7sWA2ssp2k++t7Z3QHiR0SAt6AzbBkxRMizWPwBrACMRuQkFjyAsOPGO7X3UlsF4uTbj50ESvEWbQ6zonruMquhPjFz3+G0/bh9Mvt+oH2t64feizgH3P74P59i9/l+h2L75n/fr//IOZv1P/o+sl0/k2u2Fd8uogfzS/vad90vaN9MA9glb7ebz+eTq/SBv1pu/GrP/x6JubJ10oALTnNyL3LSadtXU5zcu2c6IJSWsxTvVbxPyDj5EGiJANJEhCwdZ0sBAm6VXJftz33eV48HP/HFeu+3e9rS5e4/CssfPvxo9QkJbn7u8vlfwx8Op3c3UgAkgCQvN3vv/r6t7d1hSDgu198+OmXX5L877mu15u5nZYFgIC3u99eCpDEfd9fr9fw2PdtWRY+TvB6vRLcM2/3++Xl/O7y7r7eT8tiZvf72uqqOp9OEfHMnpnrugG4vLyA3PZ9W9eWXs7nCIdwX9d5nszM3CPVf/7LXwF8/sXnyh2AmZ08/DT/fb1dpvDdL5eLGZd5cffu3nKdYp5iAtDdT+CSdrbRbrVVdW2buy8+0/hxW0uVVdc1F/Kz5RzuDqKy3l/eVbcgp80e265vr+vZXcA8z+E+9O7u9/Z+glFShAA8BDJ1B43WEqTz6XxaZq/WNK3obE3h2U0wzIKkR5BcYsJTZ+BlWk4eAFrNhzYHAG0IBZISyBHHOABgZJNGI42qx1MkSNJgJKOl++3eVYOulqqKZKuru9HqI0IaoKp6vb2+nF7MHVXHaY5nu7tAA9DV99pALTZJXV1VbSOt1N3hZuFeT9shI2IAu7nT52mapsnMHvcZEeFBMxzsHDfU5QojwYP/MI9913QODxEEJQZoZlFdWaWqQXNVDbJbqq5CVde+7+7u7iSras9Mz0HAG6NkqjLTSAGVaVVZ7pnKKTOzk2CqE2zrcHN3bx2ndvfxp/qo2M1HxQPE3CIi4pOKj2rkJMgCNbhpKiJUXTASagfNLbq7u1oNoFuAxoQcFbPv2/p6vV5eXkgK6OquqnX1/d6nE2x6M05dVTq2Jaoqqyq7sqq6S2CpG5R3jK4hBYCHPqOJZWZGk7RnPm2LRnM30tQgYf4k3AQzG7lEo8nMzOwRNSNNGL0dAiJ8TAyB7pZ0vFEEQOExT9OhBIAegyRZgC7oOcdj/9MZw8PNpf3INDJKAAWE1Bb+1oelsUHjx92Xee7uIbOklhrEtIiGN87Vakl6uPFA6m7oWEPBkT2MZrTmgy4zHn5NO1SgmT/DZuZmPk3j4u1LwglTGQ0A/OgVd5ebt5dkpEgDaRbdnZWoHrWOiSJQUnU3qruy0mWj4UfH5Hq3lpbTk1uSo4ucDbCyFg+C1VJWVlZlk9ldsPYOd++9qg5jIzm8wtRubnQJ4T5QAXjEFBHz2Wh6GMXDQBjQ0VxSVk6M5bP3IkI1DATWTwPpqupRMQCpu9VqdXU1qrszU4CbHRVnpqWZ6d+dq7qrUoeBFCsz0+GCsjKrjCx1ij3GSY8OHh9HNDMDRZpBbLW5D5EBuNlwsU+Bm1ATNEAijHa4E4SkiCZKAmngPwG9aXTS4WirhgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"airflow\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/7LvzyngOcQO4D6jIwRlQUb/52a76f0b579ccdb4dea892df1b236156/airflow.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/7LvzyngOcQO4D6jIwRlQUb/52a76f0b579ccdb4dea892df1b236156/airflow.png?w=720 720w,\nhttps://images.ctfassets.net/tushy4jlcik7/7LvzyngOcQO4D6jIwRlQUb/52a76f0b579ccdb4dea892df1b236156/airflow.png?w=1440 1440w,\nhttps://images.ctfassets.net/tushy4jlcik7/7LvzyngOcQO4D6jIwRlQUb/52a76f0b579ccdb4dea892df1b236156/airflow.png?w=2880 2880w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p>제가 주로 사용하는 테마는 <code class=\"language-text\">flatly.css</code>에 <code class=\"language-text\">NAVBAR #18bc9c</code> 컬러 조합입니다. 적용된 화면은 위와 같습니다. (+ 태그 기능도 1.10.10 버전에 추가되었습니다)</p>\n<br>\n<h2 id=\"celery-worker\" style=\"position:relative;\"><a href=\"#celery-worker\" aria-label=\"celery worker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Celery Worker</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 39.050000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAQCAMAAABTCc2fAAAC31BMVEX5+vr7+/37/P/7/P77+/z6+vv////8/P719/zy9vz2+Pz+/v///fj/+uz/+u3/++7/++3///z7/Pzb5vfX5frY5vzY5vvW5Pnh6vf9/f37/P38/P3/+OX46b7t4Lfw4rrt37fx47r87sT69+/4+fv9/v709vrY5fnM2/DBz+PE0ubS4ffd6Pj6+/z8/f79/f77+vf++e7/++//+u79+fD6+vr/+ez98tL679H679L579H+89X9+/Xz9frO2+/Bz+LBzuG+y97F0+jZ5PT89uj+8cni1rLv4rz/9NH6+fX///78/Pz+///q8Prg6vne6fre6fnh6vnv8/v2+Pn49OTy58CaknjFupr/9dH9/vz79eXx5Lvazqrk17H57Mn7+fX08+/18+719PH19fXz8/P//vr9/v39+vP68dz789368tz79eL7+vn58Nb/8cnv7/Do6Ojp6enw8PD09PT/+Of978Xz5r/26ML058D057/98Mn8+fL5+vz+/v7x8fLw8PH4+Pn18uj48uP48uL39Ovy8vLu7u7t7e3/+Ob+8Mf16MP058L16ML8+fH19vj19vf09ff4+Prz9PTy9PTx8/L09fXo6Onl5eXq6urx8fH/8sn98Mr67cj67sj/8cv/8sv//PP//v/9+e7/+u/++u78+fD7+/rz8/Ty8/Tx8vP09fbd3d3k5OT98Mbv4r3v473t4bzy5b/9+u/4+vn7/Pv8/f38/fz99+jj17Pw47z/8s//89D/89H+89P//Pf7/Pr5+/r2+PqZkXf//vv//vz8+/z7/fvy+PHw9u/v9e75+/j6+/vw47rbz6r7+/v8/vzZ59jD18LG2sXI28bH28bM4srQ5c7Z6df+/v37/fr68tv58dv79OL4+/fL28mzxLK0xLO7zLq7zbrM4MrV6NTU59L0+PPu7+/29vf5+fnn5+fr8+nV5tPW59TV5tTU5tHm8OT+//74+fn4+Pj39/gcdtLqAAABlUlEQVQYGW3BzUsUcQDH4e9n5reCzr60zU6SBB6SQIgOUbFRkORuQQkR5D8QBoF4CULoEHQxutTSCxQkdJBOdokghLUXiaAu4Sk07BB0UHZ0l2KJjN1mptnZS8+DQAECEiDY1n+AA4iWzU+RJrSpgItfUH1bHdi7ia0N0VHzmg6hZXWY/gECLZvGfn8vkVcHGv7vUUJKmI1aqSqpVC0vWAeJpNoD/hihhgb7mn3akISx9E9LlmLDzUNvRwjNjyOQhNl1dvmzpH39LKgrU8gQGsqgPykCZj13YoTItxV1nbt5jXr+7qQhspYzKoBgc+eWpa4fT7SDPJOfThE5vGrayhNwuT1zSYnMoFMAPHnA+2OsyCCXwP2phyhRYfbFyzPcYemyVD/yxf0KtjMPaltceHZasVTuKfeYekBj0ZU0IT2W4VevApx8vaU3SAKO19pOzxV6kHxJtxQwH4ujin0g9i7L0fFs5TqVRXVYkobLZUm9z7Mde274c7NzXjp9UQnWx3R+YsZe0qOivoNA4JWq01dhtajEX9GlZcWnzX5HAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"celery\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/2xWBy0Pj9CiXMubnr26Jgt/3b9f9baa289538f55f3cf20890aa2611/celery.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/2xWBy0Pj9CiXMubnr26Jgt/3b9f9baa289538f55f3cf20890aa2611/celery.png?w=500 500w,\nhttps://images.ctfassets.net/tushy4jlcik7/2xWBy0Pj9CiXMubnr26Jgt/3b9f9baa289538f55f3cf20890aa2611/celery.png?w=1000 1000w,\nhttps://images.ctfassets.net/tushy4jlcik7/2xWBy0Pj9CiXMubnr26Jgt/3b9f9baa289538f55f3cf20890aa2611/celery.png?w=2000 2000w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p>CeleryExecutor에서 worker는 실제 task를 수행을 담당하는 컴포넌트입니다. K8S에서는 celery worker가 StatefulSet으로 배포됩니다. 기존에는 worker가 <code class=\"language-text\">AutoScalingGroup</code> 등을 통해 인스턴스가 자동 확장되도록 구성했다면, K8S에서는 <code class=\"language-text\">HorizontalPodAutoscaler</code>를 통해 Pod 단위로 확장 가능하도록 구성할 수 있습니다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">workers</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">memory</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2Gi\"</span>\n\n  <span class=\"token key atrule\">autoscaling</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">maxReplicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">16</span>\n    <span class=\"token key atrule\">metrics</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Resource\n      <span class=\"token key atrule\">resource</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> memory\n        <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> Utilization\n          <span class=\"token key atrule\">averageUtilization</span><span class=\"token punctuation\">:</span> <span class=\"token number\">80</span></code></pre></div>\n<br>\n<h2 id=\"airflow-ingress\" style=\"position:relative;\"><a href=\"#airflow-ingress\" aria-label=\"airflow ingress permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow Ingress</h2>\n<p>보통 K8S 클러스터에 Ingress Controller를 설정하고 path를 통해 여러 서비스에 접속하는 경우가 많습니다. Airflow Chart 역시 Webserver와 Flower UI에 대한 ingress를 지원합니다. 저는 nginx-ingress controller를 사용해서 진행해보겠습니다. 아래 예시는 각자의 ingress-controller 설정에 맞게 바꾸시면 됩니다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">web</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> ClusterIP\n    <span class=\"token key atrule\">externalPort</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">loadBalancerIP</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token key atrule\">loadBalancerSourceRanges</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token punctuation\">...</span>\n\n<span class=\"token key atrule\">ingress</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">web</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">kubernetes.io/ingress.class</span><span class=\"token punctuation\">:</span> nginx\n      <span class=\"token key atrule\">ingress.kubernetes.io/rewrite-target</span><span class=\"token punctuation\">:</span> /\n      <span class=\"token key atrule\">nginx.ingress.kubernetes.io/ssl-redirect</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"false\"</span>\n\n    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/airflow\"</span>\n    <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"myloadbalancer-domain.com\"</span></code></pre></div>\n<p>예를 들어 web path에 <code class=\"language-text\">/airflow</code> 라고 설정하셨다면, UI 접속 주소는 <code class=\"language-text\">myloadbalancer-domain.com/airflow</code>가 됩니다. flower도 위와 동일한 방식으로 설정하시면 됩니다.</p>\n<br>\n<h2 id=\"airflow-auth\" style=\"position:relative;\"><a href=\"#airflow-auth\" aria-label=\"airflow auth permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow Auth</h2>\n<p>Airflow 에서는 다양한 인증 방식을 지원하지만 여기에서는 가장 기본이 되는 Password Auth 방식으로 배포하겠습니다. 새로 추가된 RBAC 설정도 함께 추가해보겠습니다. 먼저 <code class=\"language-text\">extraPipPackages</code> 설정을 통해 의존성 패키지를 설치해주고 상단에 환경 변수도 추가해줍니다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">AIRFLOW__WEBSERVER__RBAC</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"True\"</span>\n  <span class=\"token key atrule\">AIRFLOW__WEBSERVER__AUTHENTICATE</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"True\"</span>\n  <span class=\"token key atrule\">AIRFLOW__WEBSERVER__AUTH_BACKEND</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"airflow.contrib.auth.backends.password_auth\"</span>\n\n<span class=\"token punctuation\">...</span>\n\n<span class=\"token key atrule\">web</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">extraPipPackages</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"flask-bcrypt\"</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"flask-oauthlib>=0.9\"</span></code></pre></div>\n<br>\n<p>이제 로그인할 사용자를 추가해주어야 합니다. Scheduler Pod의 Bash에서 create_user 명령어를 통해 생성해주시면 됩니다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ kubectl exec \\\n  -it \\\n  --namespace airflow \\\n  --container airflow-scheduler \\\n  Deployment/airflow-scheduler \\\n  /bin/bash\n\n$ airflow create_user \\\n--username=admin \\\n--email=test@example.com \\\n--password=mypassword \\\n--role=Admin \\\n--firstname=test \\\n--lastname=park</code></pre></div>\n<br>\n<h2 id=\"airflow-iam-role\" style=\"position:relative;\"><a href=\"#airflow-iam-role\" aria-label=\"airflow iam role permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow IAM Role</h2>\n<p>AWS EKS와 같은 클라우드 서비스 위에 배포한다면 각 컴포넌트의 세부 권한을 지정해주어야 합니다. 만일 Pod에 IAM Role을 할당하지 않는다면 Airflow는 클러스터의 기본 IAM Role인 EKS worker 설정을 따르게 됩니다. 따라서 보안을 신경쓰셔야 한다면 설정하는 것이 바람직합니다. 특히 Airflow에서 다른 AWS Managed Service(EMR, Athena, Lambda)와 연계하는 DAG이 존재하신다면 필수적입니다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">serviceAccount</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">create</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"airflow\"</span>\n  <span class=\"token key atrule\">annotations</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">eks.amazonaws.com/role-arn</span><span class=\"token punctuation\">:</span> arn<span class=\"token punctuation\">:</span>aws<span class=\"token punctuation\">:</span>iam<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span>123456789999<span class=\"token punctuation\">:</span>role/airflow\n\n<span class=\"token punctuation\">...</span>\n\n<span class=\"token key atrule\">securityContext</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">fsGroup</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1000</span></code></pre></div>\n<br>\n<p><code class=\"language-text\">values.yaml</code>에는 포함되어 있지 않지만 각 컴포넌트마다 <code class=\"language-text\">securityContext</code>를 지정해주셔야 IAM Role을 매핑할 수 있습니다. <code class=\"language-text\">IAM Role for Service Account</code>가 내부적으로 K8S TokenProjection을 사용하기 때문에 설정을 안하면 토큰을 읽을 수 없다는 오류가 발생합니다. IAM Role 설정에 대한 자세한 내용은 <a href=\"https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html\">EKS 공식 문서</a>를 참고하시기 바랍니다.</p>\n<br>\n<h2 id=\"dags\" style=\"position:relative;\"><a href=\"#dags\" aria-label=\"dags permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>DAGs</h2>\n<p>Airflow는 Scheduler가 DAG 파일을 주기적으로 동기화하며 문법적 오류가 없는지 체크하는 역할을 수행합니다. 단일 노드에서는 로컬에 있는 DAG 파일을 읽으면 되지만 K8S에서는 worker pod가 여러 노드에 걸쳐있기 때문에 모두 같은 DAG 파일을 바라보도록 하는 동기화 설정이 필요합니다. Helm Chart에서는 이를 지원하기 위해 두 가지 옵션을 제공합니다.</p>\n<br>\n<p><strong>1. Git-Sync Sidecar</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># git-sync sidecar</span>\n<span class=\"token key atrule\">dags</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">git</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> ssh<span class=\"token punctuation\">:</span>//git@repo.example.com/example.git\n    <span class=\"token key atrule\">repoHost</span><span class=\"token punctuation\">:</span> repo.example.com\n    <span class=\"token key atrule\">secret</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>git<span class=\"token punctuation\">-</span>keys\n    <span class=\"token key atrule\">privateKeyName</span><span class=\"token punctuation\">:</span> id_rsa\n\n    <span class=\"token key atrule\">gitSync</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token key atrule\">refreshTime</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60</span></code></pre></div>\n<br>\n<p>첫 번째 방식은 <strong>git-sync 사이드카 컨테이너</strong>를 활용하는 방법입니다. 간단히 말하자면 주기적으로 외부 저장소를 당겨오는 방식으로 git 인증이 필요합니다. 사이드카 패턴이 생소하시다면 이전에 작성한 <a href=\"https://swalloow.github.io/container-patterns/#sidecar-pattern\">분산 컨테이너에서의 디자인 패턴</a> 글을 참고하시기 바랍니다.</p>\n<br>\n<p><strong>2. Shared Persistent Volume</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># EFS PV, PVC</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolume\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>dags\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> airflow\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>dags\n    <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> airflow\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">capacity</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 20Gi\n  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ReadWriteMany\n  <span class=\"token key atrule\">nfs</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> 0.0.0.0 &lt;<span class=\"token punctuation\">-</span> EFS endpoint\n    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"/airflow\"</span>\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> v1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> PersistentVolumeClaim\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>dags\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> airflow\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> airflow\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">storageClassName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"\"</span>\n  <span class=\"token key atrule\">accessModes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ReadWriteMany\n  <span class=\"token key atrule\">resources</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">requests</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">storage</span><span class=\"token punctuation\">:</span> 10Gi\n  <span class=\"token key atrule\">selector</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">matchLabels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> airflow<span class=\"token punctuation\">-</span>dags\n\n<span class=\"token punctuation\">---</span>\n<span class=\"token comment\"># shared persistent volume</span>\n<span class=\"token key atrule\">dags</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">persistence</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">existingClaim</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"airflow-dags\"</span>\n    <span class=\"token key atrule\">accessMode</span><span class=\"token punctuation\">:</span> ReadWriteMany\n    <span class=\"token key atrule\">size</span><span class=\"token punctuation\">:</span> 1Gi</code></pre></div>\n<br>\n<p>두 번째 방식은 <strong>EFS와 같은 공유 파일시스템을 활용한 방법</strong>입니다. EFS의 특정 경로에 DAG 파일을 저장하고 마운트를 통해 모든 Pod이 같은 경로를 바라보도록 설정하는 방식입니다. 저는 EFS PV와 PVC를 먼저 추가한다음 existingClaim을 통해 참조하도록 설정해주었습니다.</p>\n<br>\n<h2 id=\"deploy\" style=\"position:relative;\"><a href=\"#deploy\" aria-label=\"deploy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy</h2>\n<p>필요한 설정을 완료했다면 배포는 아래 Helm 명령어를 통해 할 수 있습니다. 가능하다면 데이터베이스는 external로 사용하는 방법을 추천드립니다. DB 암호는 secret을 통해 생성하고 참조하도록 설정해주시면 됩니다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">helm install stable/airflow \\\n--version 7.1.1 \\\n--namespace airflow \\\n--name airflow \\\n-f ./values.yaml</code></pre></div>\n<br>\n<p>배포 이후에 namespace를 보면 아래와 같은 Pod이 존재하는걸 확인할 수 있습니다.</p>\n<br>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 45.08196721311475%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAASCAIAAACmfQvxAAADyUlEQVRIx7VVW2sbRxSemZ3VrlYrVWvHJHZS7JYSaB2D45c+hQTyUGgf+pKfl7c8lr70KT+gLY1DUBxiCiWgGpfYjlxd9qK9z+SbmbWtQgotKCNpdjW375zvfOcM/eHpz4RINKLaxfMjNEpVp1/QU25QpRCqk8YCSZYLT82HMqoaYXgSrkHruqrTLC3KUtaCYkhZJpeISxka5dx23bbFOf5woWDrOIl/+elH//y4WCMvCWVHNWmIWRLNlFRV9enmZ99+/6jj+4RwDn8xlGWpPPpzs3qebGWPySfk19nHCLOoRZ6ljutqj6Woq6rM8wMhnrxqkcOVm74j13uEqZBbltWybWaxNE2zLKcmSBftv0sRK8fnI+DleQ44wW0VY1BdlqXvtO59vYsABP0giiJEIJnPu77PgN1qAXgweLkILPWnqlVQLMbQ17XAMGzFGpwptFl455aFgOoFdVWW6AHK1XYdZxydRlPG+evXh9gCzdVCYE9V1dAFjjPuYYZq4YEQ27Y31m/gfTweQ0H9oI+pMIymYXhzYx174SK2n5yera6u9LodoyfA4XQuzSlSdjzvzle3i7x4tr+f54XntUED5iytA6RCAgbmc8uCJiF8+FqtrV3bvbsL3waDQa/X29raQqKcnJ6+eDHY3t4mSkI8SeLpdLqzswOQN8Pjy4rBG1wiy6ocjRAGa29vLwrDfhDkWQaeYXhZVUVRTMaTJEkq3UBAURbzeYrB07Oz3w8P7z94AHdhWRAEq6vBbDY7OHiVZRkSCcvgKejRGWo8VcAL2aZloN4Zw1Kv0wEzkIPNueW63q0NbIbEijyHQdDBcDgkVyFX8ZQ6qOYoPGG2KhiUNVFaqA38AvUfElRInE8mk16367XbEDQgR+/e+b4PNUFliAVIWumroNJ/T14ExRRLeuld8yWcmjdqilpT1oiWZbfbDcMQpP22/9zzPMwgZkbVoLoWdeNb495VM4N0gUxyNdOMc6KoUBUN6RVHEbioOyq7QDXWABV+E1GJshCoPmVOLk6AuFKnlcTRPEnAUhKj+sXIDHBTZGmM8TTJsxwYWZrGUQij4YyqnEw5qTxAwGy71QuuHQ3fKPPk31LXBtrQxW9/eYd+iFEsOn57hiksmIbJZPaHVGQwr9sfnU+v37h16fZfJyN4svn5FxzliKlE5xrX6nT8h998B+kXeQbRqnyX5H+Xa7nA7SLNsJ3zluMCBYLVFYbpi4LbqJ/9YKXteYbk5nJc2g1hSLUdxwUQ4BQofhCwQ1xVGh3HVJblXsjmWoSjALK5ba7F9x8mQXKGgi2SAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"airflow-po\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/66f6m4fL2LaJ0YdPRPt2Je/0dd206a14f2bdc97fbac20bba3109c30/airflow-po.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/66f6m4fL2LaJ0YdPRPt2Je/0dd206a14f2bdc97fbac20bba3109c30/airflow-po.png?w=366 366w,\nhttps://images.ctfassets.net/tushy4jlcik7/66f6m4fL2LaJ0YdPRPt2Je/0dd206a14f2bdc97fbac20bba3109c30/airflow-po.png?w=732 732w,\nhttps://images.ctfassets.net/tushy4jlcik7/66f6m4fL2LaJ0YdPRPt2Je/0dd206a14f2bdc97fbac20bba3109c30/airflow-po.png?w=1464 1464w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p>이 글에서 언급한 설정은 FIXME 주석을 해두었으니 궁금하신분들은 <a href=\"https://github.com/Swalloow/airflow-helm\">https://github.com/Swalloow/airflow-helm</a> 저장소를 확인하시기 바랍니다.</p>","excerpt":"최근 Airflow에는 Kubernetes 지원을 위해 다양한 컴포넌트들이 추가되고 있습니다. 이러한 변화의 흐름에 따라 Airflow…"}}}}]}},"pageContext":{"basePath":"","paginationPath":"","pageNumber":3,"humanPageNumber":4,"skip":19,"limit":6,"numberOfPages":17,"previousPagePath":"/3","nextPagePath":"/5"}},"staticQueryHashes":["1946181227","2744905544","3732430097"]}