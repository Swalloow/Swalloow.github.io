{"componentChunkName":"component---src-templates-post-js","path":"/spark-on-kubernetes-spot-instance/","result":{"data":{"contentfulPost":{"title":"Spark on Kubernetes: 스팟 인스턴스 사용을 위한 기능들","slug":"spark-on-kubernetes-spot-instance","metaDescription":null,"publishDate":"July 23, 2022","publishDateISO":"2022-07-23","tags":[{"title":"DataEngineering","id":"25d7d0d6-3cf7-5e19-a5cb-9c3fa926046f","slug":"dataengineering"}],"heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAlgCWAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiExYeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgtxW9EylQu8nTotmo+gHfAEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":3,"html":"<p>스팟 인스턴스 유형을 사용하면 온디맨드에 비해 70~90%의 비용을 절감할 수 있습니다.\n하지만 스팟 인스턴스는 가격 입찰, 가용성 등 여러 이유로 중단될 수 있습니다.\n따라서 스팟 인스턴스를 사용한다면 노드가 중단되는 상황에 대비할 수 있어야 합니다.\n이 글에서는 Spark on Kubernetes를 스팟 인스턴스 위에서 안정적으로 운영하기 위해 필요한 설정들을 정리해보려 합니다.</p>\n<p><br><br></p>\n<h2 id=\"driver는-on-demand에-할당하기\" style=\"position:relative;\"><a href=\"#driver%EB%8A%94-on-demand%EC%97%90-%ED%95%A0%EB%8B%B9%ED%95%98%EA%B8%B0\" aria-label=\"driver는 on demand에 할당하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>driver는 on-demand에 할당하기</h2>\n<p>중단된 노드에 있던 <code class=\"language-text\">driver pod</code>가 종료되는 경우, Spark 작업은 실패하게 됩니다. <code class=\"language-text\">executor pod</code>가 종료되는 경우, 캐시된 데이터 또는 셔플 파일을 잃게 되지만 새로운 executor를 통해 이를 다시 계산하기 때문에 전체 작업이 실패하지는 않습니다.</p>\n<p>위와 같은 이유로 <strong>driver는 온디맨드 인스턴스에 할당</strong>하는 것이 안전합니다.\n노드 그룹을 분리하고 <code class=\"language-text\">nodeSelector</code>를 활용한다면 driver는 온디맨드에서, executor는 스팟에서 실행하도록 설정할 수 있습니다.</p>\n<p><br><br></p>\n<h2 id=\"적절한-인스턴스-유형-선택하기\" style=\"position:relative;\"><a href=\"#%EC%A0%81%EC%A0%88%ED%95%9C-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4-%EC%9C%A0%ED%98%95-%EC%84%A0%ED%83%9D%ED%95%98%EA%B8%B0\" aria-label=\"적절한 인스턴스 유형 선택하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>적절한 인스턴스 유형 선택하기</h2>\n<p>일부 인스턴스 유형은 해당 시점의 spot market 상황에 따라 안정적으로 확보하지 못할 수도 있습니다. 확보를 못하게 되면 executor는 계속 pending 상태에 머무르게 되고 전체 수행시간도 지연됩니다.</p>\n<p>사용량에 비해 크기가 큰 인스턴스 유형을 선택했다면, 여러 <code class=\"language-text\">executor pod</code>가 하나의 노드에 할당됩니다. 이 때 해당 노드가 중단된다면 여러 executor가 종료되므로 재계산에 더 많은 시간이 소요됩니다.</p>\n<p>위와 같은 이유로 적절한 인스턴스 유형을 선택하는 것이 spot kill을 줄이는데 도움이 됩니다.\nKarpenter를 사용한다면, 여러 인스턴스 유형을 지정하여 Pod의 리소스 요청량에 가장 적합한 노드를 프로비저닝 할 수 있습니다. 또한 <code class=\"language-text\">Instance Fleet</code>의 <code class=\"language-text\">Allocation Strategy</code>에 따라 가장 안정적으로 확보 가능한 인스턴스 유형을 선택할 수 있습니다.</p>\n<p><br><br></p>\n<h2 id=\"spark-31-graceful-executor-decommissioning\" style=\"position:relative;\"><a href=\"#spark-31-graceful-executor-decommissioning\" aria-label=\"spark 31 graceful executor decommissioning permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Spark 3.1: Graceful Executor Decommissioning</h2>\n<p><code class=\"language-text\">Graceful Executor Decommissioning</code>은 Spark 3.1 버전에 추가된 기능입니다.\n이 기능을 통해 <strong>노드가 중단되더라도 최소한의 손실로 Spark 작업이 지속되도록 설정</strong>할 수 있습니다. 이를 사용하려면 먼저 클러스터에 <code class=\"language-text\">Node Termination Handler</code>가 설치되어 있어야 합니다. <code class=\"language-text\">Node Termination Handler</code>는 클라우드에 따라 다르게 설치할 수 있도록 지원하고 있습니다.</p>\n<p>이제 노드가 중단되었을 때 과정을 아래 그림을 통해 확인해보겠습니다.</p>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 67.34972677595628%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"spark-decom\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/315V3THD4uhXyyad1fIbNH/cf51c68cfb4ce7c016d885a15813aa35/spark-decom.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/315V3THD4uhXyyad1fIbNH/cf51c68cfb4ce7c016d885a15813aa35/spark-decom.png?w=366 366w,\nhttps://images.ctfassets.net/tushy4jlcik7/315V3THD4uhXyyad1fIbNH/cf51c68cfb4ce7c016d885a15813aa35/spark-decom.png?w=732 732w,\nhttps://images.ctfassets.net/tushy4jlcik7/315V3THD4uhXyyad1fIbNH/cf51c68cfb4ce7c016d885a15813aa35/spark-decom.png?w=1464 1464w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<ol>\n<li>스팟 인스턴스가 중단되기 약 120초 전에 <code class=\"language-text\">Termination Handler</code>의 notice 발생</li>\n<li>driver가 해당 executor를 blacklist에 추가하고 신규 task의 스케줄링을 차단</li>\n<li>중단되는 노드에 있던 캐시된 데이터, 셔플 파일을 다른 노드로 복제</li>\n<li>실패 처리된 task를 이어서 수행 (복제한 파일을 그대로 활용)</li>\n</ol>\n<br>\n<p>위의 과정을 통해 노드가 중단되었을 때 재계산을 최소화 할 수 있습니다.<br>\n이 기능에는 다음과 같이 일부 제한 사항도 존재합니다.</p>\n<p>120초의 시간 제한이 있기 때문에 <strong>옮겨야할 파일이 아주 큰 경우, 일부 파일 손실이 발생</strong>할 수 있습니다. 일반적으로 non-SSD 볼륨은 분당 최대 15GB, SSD 볼륨은 35~40GB 까지 가능합니다. 동시에 많은 executor가 spot kill 당하는 경우, 동일한 이유로 파일 손실이 발생할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">spark.decommission.enabled\nspark.storage.decommission.enabled\nspark.storage.decommission.rddBlocks.enabled\nspark.storage.decommission.shuffleBlocks.enabled</code></pre></div>\n<p><code class=\"language-text\">Graceful Executor Decommissioning</code>은 위의 설정을 통해 활성화 할 수 있습니다.</p>\n<p><br><br></p>\n<h2 id=\"spark-32-executor-pvc-reuse\" style=\"position:relative;\"><a href=\"#spark-32-executor-pvc-reuse\" aria-label=\"spark 32 executor pvc reuse permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Spark 3.2: Executor PVC Reuse</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 53.49127182044888%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"spark-reuse\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/2gUc710YoiViDEOzz2ymvR/6dedcbcbb552efa10c0e359d90872ffb/spark-reuse.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/2gUc710YoiViDEOzz2ymvR/6dedcbcbb552efa10c0e359d90872ffb/spark-reuse.png?w=401 401w,\nhttps://images.ctfassets.net/tushy4jlcik7/2gUc710YoiViDEOzz2ymvR/6dedcbcbb552efa10c0e359d90872ffb/spark-reuse.png?w=802 802w,\nhttps://images.ctfassets.net/tushy4jlcik7/2gUc710YoiViDEOzz2ymvR/6dedcbcbb552efa10c0e359d90872ffb/spark-reuse.png?w=1604 1604w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p><code class=\"language-text\">Executor PVC Reuse</code>는 Spark 3.2 버전에 추가된 기능입니다.\n이 기능을 통해 spot kill 이후에도 <strong>동일한 PVC 연결을 통해 셔플 파일을 재사용</strong>할 수 있습니다. 이를 사용하려면 먼저 클러스터에 <code class=\"language-text\">Dynamic PVC</code>에 대한 설정이 필요합니다.</p>\n<p>현재는 NVMe 기반의 SSD에서 사용이 어렵다는 제한 사항이 있습니다.<br>\n또한 PVC가 즉시 재사용 불가능한 상황이라면 race condition이 발생할 수도 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">spark.kubernetes.driver.reusePersistentVolumeClaim\nspark.kubernetes.driver.ownPersistentVolumeClaim\nspark.kubernetes.executor.volumes.persistentVolumeClaim.data.options.*\nspark.kubernetes.executor.volumes.persistentVolumeClaim.data.mount.*</code></pre></div>\n<p>Executor PVC Reuse는 위의 설정을 통해 활성화 할 수 있습니다.</p>\n<br>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<ul>\n<li><a href=\"https://databricks.com/it/dataaisummit/session/how-make-apache-spark-kubernetes-run-reliably-spot-instances/\">https://databricks.com/it/dataaisummit/session/how-make-apache-spark-kubernetes-run-reliably-spot-instances/</a></li>\n<li><a href=\"https://issues.apache.org/jira/browse/SPARK-20624\">https://issues.apache.org/jira/browse/SPARK-20624</a></li>\n<li><a href=\"https://issues.apache.org/jira/browse/SPARK-35593\">https://issues.apache.org/jira/browse/SPARK-35593</a></li>\n</ul>","excerpt":"스팟 인스턴스 유형을 사용하면 온디맨드에 비해 70~90%의 비용을 절감할 수 있습니다.\n하지만 스팟 인스턴스는 가격 입찰, 가용성 등 여러 이유로 중단될 수 있습니다.\n따라서 스팟 인스턴스를 사용한다면 노드가 중단되는 상황에 대비할 수 있어야 합니다.\n이 글에서는 Spark on Kubernetes를 스팟 인스턴스 위에서 안정적으로 운영하기 위해 필요한 설정들을 정리해보려 합니다.  driver는 on-demand에 할당하기 중단된 노드에 있던 가 종료되는 경우, Spark…"}}}},"pageContext":{"slug":"spark-on-kubernetes-spot-instance","basePath":"","prev":{"slug":"mlops-dmls-fsdl","publishDate":"2022-09-13"},"next":{"slug":"gpu-utilization","publishDate":"2022-07-08"}}},"staticQueryHashes":["1946181227","2744905544","3732430097"]}