{"componentChunkName":"component---src-templates-post-js","path":"/airflow-on-kubernetes-2/","result":{"data":{"contentfulPost":{"title":"Airflow on Kubernetes (2)","slug":"airflow-on-kubernetes-2","metaDescription":null,"publishDate":"July 12, 2020","publishDateISO":"2020-07-12","tags":[{"title":"DataEngineering","id":"25d7d0d6-3cf7-5e19-a5cb-9c3fa926046f","slug":"dataengineering"}],"heroImage":{"title":"cover-dataengineering","gatsbyImageData":{"images":{"sources":[{"srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&q=50&fm=webp 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&q=50&fm=webp 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&q=50&fm=webp 1600w","sizes":"(min-width: 1600px) 1600px, 100vw","type":"image/webp"}],"fallback":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg","srcSet":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=400&h=267&fl=progressive&q=50&fm=jpg 400w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=800&h=533&fl=progressive&q=50&fm=jpg 800w,\nhttps://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1600&h=1067&fl=progressive&q=50&fm=jpg 1600w","sizes":"(min-width: 1600px) 1600px, 100vw"}},"layout":"constrained","width":1800,"height":1200,"placeholder":{"fallback":"data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wAARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIBAwb/xAAcEAACAgMBAQAAAAAAAAAAAAAAAQIREiFBMeH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgP/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDK1DF0vgjileglOuFeTk6fC2ZH6BKV7ugEP//Z"}},"ogimg":{"src":"https://images.ctfassets.net/tushy4jlcik7/7uo9TsqFN9EBsDBqDJ5vXl/4c58a9f94babb15d8fd996c247737656/cover_dataengineering.jpg?w=1800&q=50"}},"body":{"childMarkdownRemark":{"timeToRead":5,"html":"<p>최근 Airflow에는 Kubernetes 지원을 위해 다양한 컴포넌트들이 추가되고 있습니다. 이러한 변화의 흐름에 따라 Airflow를 Kubernetes 위에 배포하고 운영하는 방법에 대해 글을 작성해보고자 합니다. 이 글은 시리즈로 연재됩니다.</p>\n<ul>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-1\">Airflow on Kubernetes (1): CeleryExecutor</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-2\">Airflow on Kubernetes (2): KubernetesExecutor</a></li>\n<li><a href=\"https://swalloow.github.io/airflow-on-kubernetes-3\">Airflow on Kubernetes (3): Airflow Logging, Monitoring</a></li>\n</ul>\n<br>\n<h2 id=\"airflow-on-kubernetes\" style=\"position:relative;\"><a href=\"#airflow-on-kubernetes\" aria-label=\"airflow on kubernetes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow on Kubernetes</h2>\n<p>지난 글에서는 <a href=\"https://github.com/helm/charts/tree/master/stable/airflow\">stable/airflow</a> helm chart를 이용하여 CeleryExecutor의 각 모듈을 Kubernetes 위에 올리는 방식에 대해 설명하였습니다. 이번 글에서는 많이 사용하는 Airflow Helm Chart에 대해 알아보고 최근에 추가된 <strong>Official Airflow Helm Chart</strong>를 이용하여 KubernetesExecutor를 배포했을 때 어떤 아키텍쳐를 가지는지에 대해 설명드리려 합니다. 먼저 많이 사용하는 차트는 아래와 같이 3가지가 있습니다.</p>\n<br>\n<p><strong>1. stable/airflow</strong>:\n다양한 옵션을 지원하고 많이 사용하지만 커뮤니티 버전입니다.\n공식 릴리즈 이후에 개발이 중단될 예정입니다.</p>\n<p><strong>2. astronomer/airflow-chart</strong>:\nAirflow as a Service를 개발하는 astronomer에서 공개한 차트입니다.\nairflow 2.0의 공식 차트로 활용될 예정입니다. (merge된 상태)</p>\n<p><strong>3. apache/airflow-on-k8s-operator</strong>:\nKubernetes Operator를 활용한 방식으로 위와 다른 구성을 가지고 있습니다.\n구글에서 apache에 기증했으며 GCP의 Composer에서 활용되고 있다고 알려져 있습니다.</p>\n<br>\n<p>이외에도 최근에 공식 차트가 <a href=\"https://github.com/apache/airflow/pull/8777\">PR-8777</a>을 통해 merge 되었습니다.\n아직 정식 릴리즈는 아니지만 큰 이슈는 없는 것으로 보여 공식 차트 기준으로 설명하겠습니다.</p>\n<br>\n<h2 id=\"airflow-executor-on-kubernetes\" style=\"position:relative;\"><a href=\"#airflow-executor-on-kubernetes\" aria-label=\"airflow executor on kubernetes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Airflow Executor on Kubernetes</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 47.56972111553785%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAATCAMAAADVnb8xAAAAulBMVEX////8/Pz4+Pj+/v7u8Pm3weq0vurJz+7///7//v7+/f36+Pb5+Pb49vX7+ff//v339/f7+/vr7fertuens+bAyOz9/f359/b39fT+/fz5+fn7/P3Bye2tueiwuun09fz6+vr5+fj7+/y/yOyqtuetuOjz9fz19fX///36+vnZ3fKfreWWpePR1vH+/v3j5vW5w+uzvend4fX09PT8+/r29vX29vb5+v7u8Pf6+fj29vf9/v/6+v39/PxYrYZrAAAA6ElEQVQYGZ3B11LDMBQE0L13KSJALFEWME1U0zum//9vkcngBEZ5AM7B75kbMTU9M0uQDCHMcag3v7DYrzBmMTEsLa+sCiQGAod6/bX1foVCtVHXDJtb2zu7+BKEkvKeO7l/cHh0jA5RMsuNYyCcnDoZzs4vLkGUTFbnRABXOZO4vrm9A1GS6vumIcbCw2NCSShYNpSECSy3GcQPwgQyNxKWjOgIE1huCJm3TnSECWSeSQLEiIiScusUQWKE4ndiRySFP3l6bh2KraqX1+hR8BiJOnqMhu/e3k2ADOEjJUtESgmwNED8wyfnMQ+PHxS+iAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"task lifecycle\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/3elcSIiD8oPaLurWJrAgdG/eafa8785a7d101ad8e9d8690383f21f3/task_lifecycle.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/3elcSIiD8oPaLurWJrAgdG/eafa8785a7d101ad8e9d8690383f21f3/task_lifecycle.png?w=628 628w,\nhttps://images.ctfassets.net/tushy4jlcik7/3elcSIiD8oPaLurWJrAgdG/eafa8785a7d101ad8e9d8690383f21f3/task_lifecycle.png?w=1255 1255w,\nhttps://images.ctfassets.net/tushy4jlcik7/3elcSIiD8oPaLurWJrAgdG/eafa8785a7d101ad8e9d8690383f21f3/task_lifecycle.png?w=2510 2510w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>먼저 공식 차트 기준으로 executor마다 컴포넌트가 어떤 형태로 올라가는지 알아보겠습니다.\n컴포넌트는 크게 아래와 같이 구분하고 있으며 위의 그림과 같은 라이프사이클에 따라 동작합니다.</p>\n<ul>\n<li><strong>webserver</strong>: Airflow UI, RBAC, DAG monitoring</li>\n<li><strong>scheduler</strong>: task monitoring, trigger, DAG sync, DAG processing</li>\n<li><strong>executor</strong>: how task instance running (pluggable)</li>\n<li><strong>worker</strong>: task instance processing</li>\n</ul>\n<br>\n<h2 id=\"localexecutor\" style=\"position:relative;\"><a href=\"#localexecutor\" aria-label=\"localexecutor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>LocalExecutor</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAUCAMAAADImI+JAAABwlBMVEX////k6PrEzfTv8fz4+Pyot++4xPK3w/H+/v39/f38/f38/P36+/y8xvOjs+/O1fb+/v78/f/9/f/M1PXAyfP3+P75+v7FzvTCy/T6+/////3r7vuVqO6Em+zT2fL39/f09fb19fb19vbz9fbz9Pb5+fqSpu3b4PP29/f6+vv8/P+/yfOntezh5O7q7O7j5u3e4u3p6+7o6u3n6e3z9PW5xPKruezk5+7h5e3f4+309ffl6O21w9ra4/D7+/vr7O7r7e7k5u6ntu2ise7T2e3s7e75+vrg4+6ltO2isu7Z3e719veMmbEARqdllcz4+fvr7e/e4u6Up+6arPDFze3t7u/o6u7y8/T+/f329/js7e/Y3e6Xqu/N1O3s7u/6+vr4+PeVoLYAVat6odH5+vzq7O/n6evCyeS2wOXi5Orr7O/4+Pno6+7n6ey/x+W5wuXl5+vx8vTQ2OXp7fT5+vvk5ujd3t/e4ODi5Ob3+Pnn6u3m6Orf4OHd39/09PL29fT7/Pzx8vPy8/X///7z8/Pu7u7x8fHw7+/w8PDz8/Ly8/f8/Pz7/P6yvvHv8fultPCisvDW3PbP1fK/yO/19PLy8vAbbKKAAAABU0lEQVQoz2NgIB4wMjETpY6FlY2dg5MLBLi5uNBpboRCHl4+ftzGcAnAmRyC+GzmRFIoJCwiiiQlJi4hiVWhlLSMrJy8gqKSgoKyiirQb2qy6hoKSmCuJoqJWto6unp6+gZ6hkbGJkATTc3M9fQsLEFcK7BCaxtbsOEMdvYODo5Ozi6uhkYqQAE3PQcHdw9PLwdDI2+wQh9fP3+Qvxg0DQ0DAoOCQ0L1wsI5OSMiDfWiooNiYuMMw1Q44u04EhKTklNgClPT0jMysyAmZucYpubm5RdkwUwsLCoGhxRDiZGRYWlZeQXEjQyVVUaG1TW1pYZhUDcm1NWDFHIzcCkoWHl7K3hbKYB8zdCgbFXYaNJUWKiA6mtYJDUjhWVLa1t7RydaOHJBqJIuQjHTDSZ7tHuxxiQ3QiE44XD09U+Y2MzJhQG4MbROmixGXPKdMpWDgSoAAB6tQoLweWe+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"local\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/45idFgE5WjfADlRxw6HqW2/f7b3eaaf9173a8e53d8496fa6797c0a6/local.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/45idFgE5WjfADlRxw6HqW2/f7b3eaaf9173a8e53d8496fa6797c0a6/local.png?w=295 295w,\nhttps://images.ctfassets.net/tushy4jlcik7/45idFgE5WjfADlRxw6HqW2/f7b3eaaf9173a8e53d8496fa6797c0a6/local.png?w=590 590w,\nhttps://images.ctfassets.net/tushy4jlcik7/45idFgE5WjfADlRxw6HqW2/f7b3eaaf9173a8e53d8496fa6797c0a6/local.png?w=1180 1180w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>LocalExecutor는 Scheduler에서 각 task가 subprocess 형태로 돌아가는 구조입니다. Scale-Out이 어렵기 때문에 간단한 테스트 용도로 사용하는 경우가 많습니다.</p>\n<br>\n<h2 id=\"celeryexecutor--dag-pv\" style=\"position:relative;\"><a href=\"#celeryexecutor--dag-pv\" aria-label=\"celeryexecutor  dag pv permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CeleryExecutor + DAG PV</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 68.25396825396825%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAbCAMAAAA5zj1cAAAC3FBMVEX////m0dD++vns4N/JhH/szcz+///9/f7dxcTBX1bkrqr//v79/f3+/v/7/P/39/fm29r18fH+/v78/P7AyvOwvfHs7vv8/f36/Pz8+/n///3v8fqntvCtu/HU2vb///79/v719vy3we3V2vT+/v38/Pza3/jM1PX7+//7+/vV2vY2cOaBmev4+fz6+vrj5/rs7/z29vbx8/yltPDH0PX5+v7c4fjy9P35+fnh5fmYqu6er+/z9fr6+/v4+Pj7+/z6+vv5+vv8/P3N1PaTpu2xvvH4+Pnt8Pydru6ntevn6u7q7O7e4Obp6+3p6+7o6u3x8/Td4vmRpey5xOzr7e7f4ef29/ja3+rm7PTx8vfs7e7N1O2ks+3EzO3x8/Xr7fPr7O6/yO2ls+3S2O329/nKztYAS6FWjsnx8/j29vfs7u+zvu2fsPKmte3r7O/o6+7w8vTw8fPp6++hsO2er/G6xO3t7u/q6+7o6u719vf//v3Cxs8ATqJXj8nx9PjX2+awu+PS1+fP1OexvOTc3+nr7e/4+fnS2OTg5u/09ffn6u3h4uTg4uLh4+Tx8vTv8fPi4+Xg4eHj5ef29vT39vX8/fz3+Pn4+fr5+fr39/j9/f/x8/2uu/HM1Pbi5vnS2PeRpe6suu/s7vLx8vPy8/Pw8vPv8fLu8PLz9PbJ0fWAmeyksuzw8fLv8PDv8PPv8PLR2PPW2+3d4e3Byuzi5e7k5+7Cyuzc4O3FzezU2u33+P7J0fDb3+3a3u3EzOzj5u74+Pevu+2Cm+61wOzCy+2Gnu6js+zO1O6Koe6PpOyltO2ntvK8xuz39/nHz+6Tp+3J0O7V2+/d4e+fsO6ptuzo6u+2weySpezO1O3g4uXU19/d3+He3+HW2ODa297e3+Da3eTb3uLq6+3i5OfT1t3o6evt7vHs7e/t7vDu7/Lt7/Hy8/Xt7/Lu7/Ht7/Dw8PDy8vLv7+/t7u7x8fG3r+1XAAACW0lEQVQYGZ3BP2iUdwDH4c/3/XPv29zv3vfNm0v0ktbToraIQ4uDQ1ALQulQqkOHTJ1E1OLgIKWODoIgETqmRIcOTboExyyCIAFFuzgETEMbHGKJ9x7aV5O7M3n7vpcIZ0kHfR7ekyz+h+hlK9diOw69XOVabMeCSsAbnue9LLEtiwHPG2KL75fwhtmOGFGuAR0XOrXMkvSUQgcXqDUSCjZZXCotttv11ocvsF/19bmuu2HcFuweetJut2GVgsXAY98HnI+fpLkl3/cfjez4KE3TcIkeoj4sqVGVNmzpNoXj0hp2qSU0Vyah4EAgKUTasCW6AilcdUpZG534LebYTk1h0ZjtV18YRdEHENA1U+mYwbgSGgiA/WF4BgeIXq4OSepf3CtDjWV2xs2VT7Rp3/CoclhAJPtVtVp9wV9Jmi4spOkfHCAJc/MsLjy6Ui6XL2MB0eiepjGmaY9+xqZdsd0MguDegZjcTWPAAYzmMcpWT/IrmybOr+FZG1/BnRgWzlMwTPBfAbmYQhzTZTHwszXJ226M34T6QXqJenRBBbLs90OZLY0xLc0xqrtHtPb8EgkFB/f7SNNjKnhV/eSMQb/UXPla31zbO/IgiemyeHo6mmmHXSei6Nynflz/8u/rK3alUqn/mfzAFguYTT6v5C7OlMvl3fNr/BOv2Bw2xtDDASLNfSvpF3X5CSB77jtpyZ6/yhZh0oe1O1/8COn42cnJU9IgTB0trTvKXuv1rbNxQkGYFPbdl7TurGdOPeFtMQkFh9oyneVjnerzeP1ZlbbnsqXjkhto8G7+BVryrBrc49g2AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"celery3\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/5p5hiUjVWUHOBKRYwHovZV/4d4786a674ddec022cb25333b9e715b1/celery3.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/5p5hiUjVWUHOBKRYwHovZV/4d4786a674ddec022cb25333b9e715b1/celery3.png?w=315 315w,\nhttps://images.ctfassets.net/tushy4jlcik7/5p5hiUjVWUHOBKRYwHovZV/4d4786a674ddec022cb25333b9e715b1/celery3.png?w=630 630w,\nhttps://images.ctfassets.net/tushy4jlcik7/5p5hiUjVWUHOBKRYwHovZV/4d4786a674ddec022cb25333b9e715b1/celery3.png?w=1260 1260w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>CeleryExecutor는 Scheduler가 task queue에 작업을 전달하고 worker에서 작업이 수행되는 구조입니다. 지난 번 글에서 언급했듯이 여러 노드에 걸쳐 있는 DAG 파일을 동기화하기 위해 <strong>PV, git-sync</strong> 2가지 옵션을 지원합니다. 이 옵션은 KubernetesExecutor에서도 지원합니다.</p>\n<br>\n<p>위의 그림에서는 AWS EFS를 기준으로 표현했지만 다른 스토리지에서도 활용 가능합니다. 이 방식은 스토리지를 별도로 두기 때문에 git과 다르게 배포 주기를 가져갈 수 있습니다.\n그리고 worker pod이 <strong>statefulset</strong> 형태로 변경되었습니다. 이를 통해 각 worker에 PV를 연결하고 airflow UI에서 각 task의 로그를 볼 수 있습니다.</p>\n<br>\n<h2 id=\"celeryexecutor--dag-git-sync\" style=\"position:relative;\"><a href=\"#celeryexecutor--dag-git-sync\" aria-label=\"celeryexecutor  dag git sync permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CeleryExecutor + DAG git-sync</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 67.06349206349206%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAbCAIAAACBclo5AAAEl0lEQVRIx8VW21IbRxDVH/k78if5hLwlD67kwamkYldMxVUJxgYDdhzAOIbCgB0gkQMoIIS5CHSXdrW7c9v7fZWeXSQtWAhIueKuqVHvqHvOTPf0mcl0PpFkrm96VDPKLev/BhaR8/lI+f6LFtPdjwkchh3Xi4bYhVFnfRfnT7TYOOx0oo8A7PnR8l/6r0uqhDz4jD6QGCxQVaZpahSFuq5TSh3XHWg80H0wMFW9yVfs+Wt1vwgpjMJwQEtJEPgu/MBYyiAc6AUtCIKB2Jl41WGx6mzumcOjnYggOUcl4/ohvWzTZ8ADHcKuBLHAmGkFEy/pLzO01nLiNEdJvnu2H2IMA45nDNe2jN3DfrW4rtvz1HUt+YTT8HSRjUxjhfjwKSNv6U+tVHN6lp7n3gy4VHe/HcPfP0aImJZlGaZJKNPhh+uWZpiOczaj64WGFSR6dsf85mc0Po/BBizBnlD1TDdNTTc93x8e6shxo5Wsur6NFESKFXxSwQomkkIOTnCljiUFq3o6r2cTETWYf0N3D7CMuGW1wb0EiRSOUFPgXpbtJPNzY6pNLeTXdoUw/sx067JjOzYm5LRKHs/T8XlSbZL8IR6doRMvcUvEWhc4yWdvCTCOKcnt4/F5Nr3AV7D6Dj+cZS9WEegA3Nvxm41c5taDW19tYNU+B2xaNpgC8I9TZGSa1Jo0f0juTpDRGdxqE1Uzou5B832/e5RCpuoIk+0CvvuEPpoDYLqSxT+Mk9llvgiYMzmYYJnfL372xdztyYLl+BeBIbZNQdzcKef2qqIki5KSzVUPjlsygh2bfRZL7RiAwaveFLPblcJBTUG41mxvbFZLVRGAbcfthRq82jI/Of0cp4HbMhJESWhLksyTBArAw/ilwJpx5tWWwBHAEh16GL8A7LqO1y2WTGoiHssgiScPKe/9IPCgRFwvCW/CV+eJOuUVhJ7nBz33mLOGneoEWDdD3x9AIxdGDDMgLOh9qnp6/50bEwgQwsNZ+semAbtKW9u27Qd9GMcNny2y0VnaVvgaj8rO2BzdyBm9FAAHRKmb42pgQfbvTZLfXhMZMcp4g2MQN5oofFBlgsQePEP3nkCx8nts58D68ic09QphyjDhZphQ0BFhCDMFM8hxNCgM57i60jDLdYwIp4LZZaVUI9UGmVtR9ou8nH5/q2zmOT/k3zf+KQideK4g7ByXtXqLAO3AX3tHeGENleuwehKfuHMEcmmOgUDk2P/5Ev56FCDR27/xnUd0dAZt7ZHvxumdMeAjIrTbCkLd+yDSdB28+GFWyNgcnlrQFtehsGkMTGzbvRo4KScF01yBQDx33pNiGS4ivLYFpcn5C8hIQhQwqKqn6xgg4xXT1Sy6PyXvH2MI/Q2ADdMWZU43tXrz8Lh0Wq5AOz6BdnpaKpeqjdNyFSobAkiY1vOHRYi84jl2oyWCY1vmdQ+rEa8dahdmhB3AjvhhiXuuE8YVpoEOMJQBPVup6rLgLz6u6izVA0PBOBAAgF4B3CsJxpiqqvCqwhhDr8bCYrnsAfUfXyBAMf3HBrAVCL8J+GUQ9/0W3lyGvbk+ifwLeSgZA665A00AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"celery4\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/3ZgJBdBXHTXvfqzRkRlroV/029606fb3f630f35939c4be45de6ab8f/celery4.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/3ZgJBdBXHTXvfqzRkRlroV/029606fb3f630f35939c4be45de6ab8f/celery4.png?w=315 315w,\nhttps://images.ctfassets.net/tushy4jlcik7/3ZgJBdBXHTXvfqzRkRlroV/029606fb3f630f35939c4be45de6ab8f/celery4.png?w=630 630w,\nhttps://images.ctfassets.net/tushy4jlcik7/3ZgJBdBXHTXvfqzRkRlroV/029606fb3f630f35939c4be45de6ab8f/celery4.png?w=1260 1260w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<p>git-sync 옵션을 사용한다면 위와 같은 그림으로 구성됩니다.\nairflow의 각 컴포넌트에 git-sync 컨테이너가 sidecar 형태로 추가됩니다.\n이 방식은 <strong>DAG 전용 git repository가 있다면 자동으로 배포를 구성할 수 있다</strong>는 장점이 있습니다. 처음 차트를 배포할때 init container 단계에서 git clone을 수행하고 이후부터는 git-sync 사이드카 컨테이너를 통해 주기적으로 pull을 수행하게 됩니다.</p>\n<br>\n<h2 id=\"celeryexecutor--keda-autoscaler\" style=\"position:relative;\"><a href=\"#celeryexecutor--keda-autoscaler\" aria-label=\"celeryexecutor  keda autoscaler permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CeleryExecutor + KEDA AutoScaler</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 583px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 85.76329331046313%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"keda1\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/w8juWviWwsFWzYn3oA0hQ/5f47b74cd9e3b94ebcfb10aa7254d0d9/keda1.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/w8juWviWwsFWzYn3oA0hQ/5f47b74cd9e3b94ebcfb10aa7254d0d9/keda1.png?w=146 146w,\nhttps://images.ctfassets.net/tushy4jlcik7/w8juWviWwsFWzYn3oA0hQ/5f47b74cd9e3b94ebcfb10aa7254d0d9/keda1.png?w=292 292w,\nhttps://images.ctfassets.net/tushy4jlcik7/w8juWviWwsFWzYn3oA0hQ/5f47b74cd9e3b94ebcfb10aa7254d0d9/keda1.png?w=583 583w\"\n        sizes=\"(max-width: 583px) 100vw, 583px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p><strong>KEDA AutoScaler</strong>는 공식 차트에만 추가된 옵션입니다.\n기존의 Horizontal Pod Autoscaler는 리소스(CPU, Memory) 메트릭을 기반으로 스케일 여부를 결정하게 됩니다. 반면에 KEDA는 <strong>특정 이벤트를 기반으로 스케일 여부를 결정</strong>할 수 있습니다. 예를 들어 airflow는 metadb를 통해 현재 실행 중이거나 대기 중인 task가 얼마나 존재하는지 알 수 있습니다. 이러한 이벤트를 활용하여 worker의 scale을 결정한다면 queue에 task가 많이 추가되는 시점에 더 빠르게 확장할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> ceil<span class=\"token punctuation\">(</span><span class=\"token function\">COUNT</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>::<span class=\"token keyword\">decimal</span> <span class=\"token operator\">/</span> <span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> task_instance\n<span class=\"token keyword\">WHERE</span> state<span class=\"token operator\">=</span><span class=\"token string\">'running'</span> <span class=\"token operator\">OR</span> state<span class=\"token operator\">=</span><span class=\"token string\">'queued'</span></code></pre></div>\n<p>이를 위해 airflow에서는 KEDA의 <strong>PostgreSQL trigger</strong>를 활용하였고 실제 위와 같은 쿼리가 등록되어 있습니다. KEDA는 CRD와 custom controller로 구성되어 있기 때문에 기존 HPA와 함께 사용 가능하며 모든 K8S 클러스터에 추가할 수 있습니다.</p>\n<br>\n<h2 id=\"celeryexecutor-vs-kubernetesexecutor\" style=\"position:relative;\"><a href=\"#celeryexecutor-vs-kubernetesexecutor\" aria-label=\"celeryexecutor vs kubernetesexecutor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CeleryExecutor vs KubernetesExecutor</h2>\n<p>여기까지 CeleryExecutor에 대해 알아보았습니다. CeleryExecutor 또한 Kubernetes 위에 배포하면 Helm 차트를 통한 선언형 리소스 관리, 쉬운 버전 업데이트, DAG 배포 자동화, 쉬운 리소스 확장 등의 장점을 가질 수 있습니다. 하지만 Celery에 대한 의존성이 남아있기 때문에 Redis, Celery Worker에 대한 리소스를 계속 점유하고 있어야 합니다. 다시 말해서, <strong>Scale to Zero</strong>가 어렵다는 단점이 있습니다. KubernetesExecutor는 task가 존재할때만 pod이 생성되고 task가 완료되면 종료되기 때문에 더 리소스를 효율적으로 사용한다고 볼 수 있습니다.</p>\n<br>\n<h2 id=\"kubernetesexecutor-kubernetespodoperator\" style=\"position:relative;\"><a href=\"#kubernetesexecutor-kubernetespodoperator\" aria-label=\"kubernetesexecutor kubernetespodoperator permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>KubernetesExecutor, KubernetesPodOperator</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 407px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 51.35135135135135%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAVCAMAAAADxFwsAAABmFBMVEX////9/f/e4/ns7/vi5vnk6PrY3fiJn+wAX+RkhejAyvPv8fzh5fmYqu4PZOWKoOy+yfPm6vrY3vgAYeQAUuOSpe2zv/GCmuv8/f/p7PtQeucUZOUrauWntvCDm+tWfefz9f2yvvG5w/KxvfG5xPKzvvE9cebu8fzM0/WKn+zCzPTHz/XL0/amtfAAXeTd4viHnexdgejI0PXByvO+yPOyvfEAWuTX3feFm+vS2ff3+f7y9f1qiem7xvP9/v+DmutcgOjJ0PW/yfMAWeSks+9siumcre7q7ftgg+i2wvLg5PlEdOYjZ+VXf+hUfOcAW+SbrO7u8PxniOkTZuVihemzwPKUqe59luv09v3Gz/VHdudzkupjh+l3kure5Plzk+tykepykuuDnezn6/vr7/3o6/zm6vv19//u8P7n6vzn6/zw8v719fXt7e3v7u7v7+z7+vf19fPu7u7s7Ov7+/v+/v3r6+rr6+ny8u/19PLw8O/+/v7m5ubY2NjQ0NDLy8vPz87X19fPz8/R0dH5+fnMzMvU1NP9/f3BXEGgAAAAtklEQVQoz2NgGJ6AkYkZVYCFFVkWzmJjBIGvcD4PmP8eQ6EQIyMDSOYFlC/JCAEPYMbDFPL/5GBEVsgPVciAoRBN4qv0G1FkPhOUtuPn52fge8gL4zOo8ypx3uPh4cFwoxfEwI3/ofxAqA0rMHwdCRI+/ADOjwOrm4tuNQPDci4gQKhjWMQJBHMxwjGHERo8jD0QgVKoQCuarwVAav6wIrzJ/5eFgfEPwycsUVgNRiigvWRIJUIAbBgcR71IxjgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"kubeexec2\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/7aImqhPOqW08NxOj0rGEjK/aa9cf6a2be5efeea4fcf8496d9c4526b/kubeexec2.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/7aImqhPOqW08NxOj0rGEjK/aa9cf6a2be5efeea4fcf8496d9c4526b/kubeexec2.png?w=102 102w,\nhttps://images.ctfassets.net/tushy4jlcik7/7aImqhPOqW08NxOj0rGEjK/aa9cf6a2be5efeea4fcf8496d9c4526b/kubeexec2.png?w=204 204w,\nhttps://images.ctfassets.net/tushy4jlcik7/7aImqhPOqW08NxOj0rGEjK/aa9cf6a2be5efeea4fcf8496d9c4526b/kubeexec2.png?w=407 407w\"\n        sizes=\"(max-width: 407px) 100vw, 407px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p>위의 그림처럼 KubernetesExecutor는 Broker와 같은 리소스를 점유하고 있을 필요가 없습니다. 리소스를 할당하고 스케줄링 하는 역할은 Kubernetes Scheduler가 수행하게 됩니다. Airflow Scheduler는 API Server에게 task 수행을 위한 Pod 생성을 요청합니다. worker는 <code class=\"language-text\">images.airflow</code>에 설정한 이미지로 Pod이 생성되기 때문에 추가로 필요한 파이썬 패키지가 존재한다면 별도의 이미지를 만들어주어야 합니다. 만일 task pod 마다 다른 이미지와 리소스 설정을 가지도록 하고 싶다면 <strong>KubernetesPodOperator</strong>를 사용하시면 됩니다. KubernetesPodOperator는 worker를 통해 pod이 생성되는 구조이므로 파라메터를 통해 사용자가 원하는 설정으로 변경할 수 있습니다.</p>\n<br>\n<h2 id=\"kubernetesexecutor-process\" style=\"position:relative;\"><a href=\"#kubernetesexecutor-process\" aria-label=\"kubernetesexecutor process permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>KubernetesExecutor Process</h2>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 19.869174161896975%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAICAMAAAC8jE1pAAABJlBMVEXu58vp5Lvq5b3p48r+/v7////07tzo47nq5NH+/v/+/fvs5cXo47rm4MP7+vn38ujn4c/39fH08uzw7efr6OLu6+f49/j4+Pj5+Pj49/f8+/z//v/59vTx7efz8Or39fL29O/z8ev08u78+/n29PL+/f76+fr7+vv6+fn8+/v+/f39+/z59/j29vb39vb39/f//v7//f78+vv7+/v7+vr9/f38+vr29PX29fX49vb59/f29fb7+fn+/P38+vz29Pb08/T19PT08/P8+fv9/P38/Pz9/f79/P738uP18tv07tjy7tbx7d/9/Pz18dr18uf//v328uD079/7+PL08Obv69rp5c3q5s7q5tf18ebp5czs6Nz+///t6NXo49L49e/p5Mzq5txrQcUEAAAA2ElEQVQYGV3BvUrDUACG4fdLzjltkkoiShcX9+rkJLg5uTgJXqM34TU4WIeKIBZc4uBZmrb5OabEgvg8QgqRxEBCahhYCamCtMWYQw0CUYi088mv+kSt+RAcd62T5VTSd0FP8oXKqSiZdl/FaH72zJ4sszl/nEuEFalCVONUhWyFUv8a8c+4NputcXZrXRaW3o4atzHxEbJcqrHrpEoDsGWsl9zn9PxMemTPXKv3NpnESeVzv7iKVZaU7GRa35jlE9zWOHMghei9YXAndP/AYHGRYDpgUjv9AEykRBreSQzjAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"k8s-happy-path\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/2usGvGAxaTlKGcNVJZcawO/37094fe04db84de87652672da1f50543/k8s-happy-path.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/2usGvGAxaTlKGcNVJZcawO/37094fe04db84de87652672da1f50543/k8s-happy-path.png?w=306 306w,\nhttps://images.ctfassets.net/tushy4jlcik7/2usGvGAxaTlKGcNVJZcawO/37094fe04db84de87652672da1f50543/k8s-happy-path.png?w=612 612w,\nhttps://images.ctfassets.net/tushy4jlcik7/2usGvGAxaTlKGcNVJZcawO/37094fe04db84de87652672da1f50543/k8s-happy-path.png?w=1223 1223w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p>KubernetesExecutor는 위와 같은 프로세스를 통해 동작합니다. 일반적으로 Pod이 생성되는 과정과 동일하며 airflow에서는 내부적으로 python kubernetes client library를 통해 k8s_model 이라는 객체로 K8S API를 추상화하여 사용하고 있습니다.</p>\n<br>\n<p><span\n        class=\"gatsby-resp-image-wrapper\"\n        style=\"position: relative; display: block; ; max-width: 650px; margin-left: auto; margin-right: auto;\"\n      >\n        <span\n          class=\"gatsby-resp-image-background-image\"\n          style=\"padding-bottom: 25.021949078138718%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAKCAMAAADxROxiAAABfVBMVEXv58vq5Lrs5r3r5rzp4bz28/D////y69Xq5Lno4cf8+/z79/Hq47zq5Lvn4MH59/f1797p47jr5brk3Mf18+3w7uXv7OPq597q59/19PT7+/v6+vr7+vr6+fn+/v739O/x7+r9/Pvx7+bv7OTw7eXw7uf8/Pz59/Tw7eTw7ur+/f729fb49vj49vf29PT29fX39vb39fX8+fr7+fv7+/z5+fn//v///v729PX8+vr+/P369vf8+/v7+vv+/f38+vvz7+/18/P39/f4+Pj49PX08/Pz8vL08vLz8fH08vP+/Pz9+/v09PT08/T19PX9/f38+vzx7vDz8fLx7+/x7/Dy8PDy8PHy8PL6+Pr+/P79+vv48+b28t728d3079vy7dv49vT38ub08Nv079rz7uL9+/z8+fb079zz7t/7+fr59ezy7Nf18dzz7+Xr5NHh3L3j3sDi3r/h27/08/Dv6trh3b3i3b3i3Mn6+PPj3sHh3b7i3b7h28T5+Pjf2cpUxWsqAAAA/klEQVQYGXXBQUvCAACG4febc5ktoZIaFaFk1KkUJOrasWvHfmN07NIPqKAU6WgxCHOZsIOrIahrcwpeeh6hKVLSMKcRqawUrCqEvGJFpSJJY1Mh+U9mdpRwoeyvSxYVpRgb/UJO6gKK2O6YXrXJnCxqDRYcGiyHRgRfRVvSO3Zgs/WILM4e+M+5YtGgEP00TBiyoFqQiIzWyXBJo1d/954ZE4pHe8+wudnr1aMP57tjE5D9dUsu2fIdc7K4VIKJwSQj6abWtUkETvPqDa9E3660m7pW4unAhzWffcVaA2KBU1VIXi9dpy7J3FCi3WbqVNKty5R3oUQD73jFzvwBa75NSwLDLFEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n        >\n          <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"k8s-failed-pod\"\n        title=\"\"\n        src=\"https://images.ctfassets.net/tushy4jlcik7/5DNugNWbyej6H0ls4cPuix/426601ff509e37357de86d7521439406/k8s-failed-pod.png\"\n        srcset=\"https://images.ctfassets.net/tushy4jlcik7/5DNugNWbyej6H0ls4cPuix/426601ff509e37357de86d7521439406/k8s-failed-pod.png?w=285 285w,\nhttps://images.ctfassets.net/tushy4jlcik7/5DNugNWbyej6H0ls4cPuix/426601ff509e37357de86d7521439406/k8s-failed-pod.png?w=570 570w,\nhttps://images.ctfassets.net/tushy4jlcik7/5DNugNWbyej6H0ls4cPuix/426601ff509e37357de86d7521439406/k8s-failed-pod.png?w=1139 1139w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        loading=\"lazy\"\n      />\n        </span>\n      </span></p>\n<br>\n<p>task가 완료되기 전에 Airflow DB 상태 업데이트 단계에서 OOM 등의 이유로 Pod Crash가 언제나 발생할 수 있기 때문에 이에 대한 장애 시나리오도 준비되어 있습니다. DB 업데이트에 실패하더라도 airflow scheduler는 Kubernetes Watch API를 통해 pod의 상태를 전달받아 다시 DB 상태를 업데이트 할 수 있습니다. CeleryExecutor의 경우, task 상태에 대한 처리를 celery에 주기적으로 확인하는 방식이라면 <strong>KubernetesExecutor는 이벤트 스트림으로 전달받기 때문에 스케줄러에 대한 부하가 더 낮다</strong>고 볼 수 있습니다.</p>\n<br>\n<h2 id=\"kubernetesexecutor-batch-cronjob\" style=\"position:relative;\"><a href=\"#kubernetesexecutor-batch-cronjob\" aria-label=\"kubernetesexecutor batch cronjob permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>KubernetesExecutor Batch, CronJob</h2>\n<p>공식 차트에서는 사용자의 편의를 위해 RBAC 초기 사용자를 생성해주는 <strong>create-user BatchJob</strong>이 추가되었습니다. <strong>Helm Hooks (post-install)</strong> 를 통해 차트 리소스가 모두 생성된 이후에 수행됩니다. 더 이상 exec 명령어로 bash에 들어가 create-user 명령어를 수행할 필요가 없습니다!</p>\n<p>추가로 <strong>cleanup CronJob</strong>이 있습니다. <code class=\"language-text\">AIRFLOW__KUBERNETES__DELETE_WORKER_PODS</code> 옵션을 통해 task가 끝나더라도 pod이 종료되지 않도록 설정할 수 있는데 이때 내가 원하는 주기마다 오래된 pod을 삭제할 수 있는 CronJob 입니다.</p>\n<br>\n<h2 id=\"official-helm-chart-issue\" style=\"position:relative;\"><a href=\"#official-helm-chart-issue\" aria-label=\"official helm chart issue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Official Helm Chart Issue</h2>\n<p>공식 버전 차트는 아래와 같은 이슈가 남아있지만 2.0 정식 버전 출시와 함께 해결될 예정입니다.\n글을 작성하는 과정에서 DAG 동기화 관련 버그를 발견하였지만 리뷰를 통해 곧바로 수정되었습니다. (<a href=\"https://github.com/apache/airflow/pull/9371\">PR-9371</a>). stable/airflow 차트와 비교했을때 아쉬운 점은 아래와 같습니다.</p>\n<ul>\n<li>현재 버전에서는 backend로 postgresql만 지원 <a href=\"https://github.com/apache/airflow/issues/9627\">(ISSUE-9627)</a></li>\n<li>pip 등 작업 실행에 필요한 패키지 설치하는 옵션이 없음</li>\n<li>initContainer를 수정해서 설치하거나 이미지 별도로 생성해야함</li>\n<li>차트에 Ingress 설정에 대한 옵션이 부족</li>\n<li>KubernetesExecutor의 경우 remote logging 설정을 해야 UI에서 로그 확인 가능</li>\n</ul>\n<br>\n<h2 id=\"deploy\" style=\"position:relative;\"><a href=\"#deploy\" aria-label=\"deploy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Deploy</h2>\n<p>사실 배포와 옵션에 대한 내용은 지난 글에서 말한 내용과 크게 다름이 없습니다. 아직 정식 릴리즈까지 변경될 여지가 많다보니 아래 공식 문서 따라하시는 방법을 추천드립니다 <a href=\"https://github.com/apache/airflow/tree/master/chart\">(apache/airflow/chart)</a>. 다음 글에서는 KubernetesExecutor의 로깅과 모니터링에 대해 다루어보겠습니다!</p>","excerpt":"최근 Airflow에는 Kubernetes 지원을 위해 다양한 컴포넌트들이 추가되고 있습니다. 이러한 변화의 흐름에 따라 Airflow를 Kubernetes 위에 배포하고 운영하는 방법에 대해 글을 작성해보고자 합니다. 이 글은 시리즈로 연재됩니다. Airflow on Kubernetes (1): CeleryExecutor Airflow on Kubernetes (2): KubernetesExecutor Airflow on Kubernetes (3): Airflow Logging, Monitoring Airflow on Kubernetes 지난 글에서는 stable…"}}}},"pageContext":{"slug":"airflow-on-kubernetes-2","basePath":"","prev":{"slug":"airflow-on-kubernetes-3","publishDate":"2021-02-05"},"next":{"slug":"umbrella-helm-chart","publishDate":"2020-06-20"}}},"staticQueryHashes":["1946181227","2744905544","3732430097"]}