{"componentChunkName":"component---src-templates-post-js","path":"/aws-cli-mfa/","result":{"data":{"contentfulPost":{"id":"0281d9ec-989b-5d76-83e6-17dbd339a401","title":"AWS MFA CLI 설정 변경 자동화하기","slug":"aws-cli-mfa","metaDescription":null,"publishDate":"October 03, 2019","publishDateISO":"2019-10-03","tags":[{"title":"DevOps","id":"701ee587-d6e3-5391-af93-e295765b6f45","slug":"devops"}],"heroImage":{"id":"f36c235f-3e3e-517d-bd80-697bc6183072","title":"cover-devops","fluid":{"aspectRatio":1.5,"src":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1800&q=50","srcSet":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=450&h=300&q=50 450w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=900&h=600&q=50 900w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1080&h=720&q=50 1080w","srcWebp":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1800&q=50&fm=webp","srcSetWebp":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=450&h=300&q=50&fm=webp 450w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=900&h=600&q=50&fm=webp 900w,\n//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1080&h=720&q=50&fm=webp 1080w","sizes":"(max-width: 1800px) 100vw, 1800px"},"ogimg":{"src":"//images.ctfassets.net/tushy4jlcik7/7KaSTt3mdmrYq2ZK1RiJku/dafd981ff3686217ac151b562e8b1412/cover_devops.jpg?w=1800&fl=progressive&q=50"}},"body":{"id":"7ac3472c-5592-59a3-a44e-93e0c7cc9351","childMarkdownRemark":{"id":"75823e04-fa87-5c91-b69f-14ba1eb90edf","timeToRead":3,"html":"<p>클라우드 인프라를 관리하는 경우 여러 계정에 걸친 CLI를 사용하는 경우가 빈번합니다.\n만일 CLI 사용 시 MFA 인증을 요구하는 계정과 아닌 계정이 혼재되어 있다면 설정이 정말 귀찮아집니다.\n이 글에서는 간단한 스크립트를 통해 AWS CLI 설정 변경을 자동화해보려 합니다.</p>\n<br>\n<h2 id=\"aws-credential-설정\" style=\"position:relative;\"><a href=\"#aws-credential-%EC%84%A4%EC%A0%95\" aria-label=\"aws credential 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AWS Credential 설정</h2>\n<p>먼저 사용하는 프로필의 credential 정보를 설정해줍니다.\nMFA인 프로필과 MFA가 아닌 프로필을 구분하기 위해 아래와 같은 구조로 저장하겠습니다.\n<code class=\"language-text\">-default</code>가 붙은 프로필이 MFA를 사용하는 프로필입니다.\n스크립트 실행을 통해 autogen 값이 자동생성됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[test]\naws_access_key_id = mykey\naws_secret_access_key = mykey\n \n[dev-default]\naws_access_key_id = mykey\naws_secret_access_key = mykey\n \n[prod-default]\naws_access_key_id = mykey\naws_secret_access_key = mykey\n \n[dev]\naws_arn_mfa = arn:aws:iam::myaccount:mfa/myaccount\naws_access_key_id = autogen\naws_secret_access_key = autogen\naws_session_token = autogen\n \n[prod]\naws_arn_mfa = arn:aws:iam::myaccount:mfa/myaccount\naws_access_key_id = autogen\naws_secret_access_key = autogen\naws_session_token = autogen</code></pre></div>\n<ul>\n<li><code class=\"language-text\">aws_arn_mfa</code> : MFA 에 대한 ARN 값 입니다. 콘솔의 security credentials 메뉴에서 확인하실 수 있습니다.</li>\n<li><code class=\"language-text\">aws_session_token</code>: MFA 인증을 거치게 되면 생성되는 STS 토큰 값 입니다. 스크립트를 통해 자동생성 됩니다.</li>\n</ul>\n<br>\n<h2 id=\"mfa-설정-스크립트\" style=\"position:relative;\"><a href=\"#mfa-%EC%84%A4%EC%A0%95-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\" aria-label=\"mfa 설정 스크립트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>MFA 설정 스크립트</h2>\n<p>다음으로 아래의 스크립트를 각 <code class=\"language-text\">awsp.sh</code>, <code class=\"language-text\">mfa.py</code> 이름으로 <code class=\"language-text\">~/.aws/</code> 경로에 추가해줍니다.\n이후에 <code class=\"language-text\">~/.zshrc</code> 또는 <code class=\"language-text\">~/.bashrc</code> 경로에 <code class=\"language-text\">source ~/.aws/awsp.sh</code>를 추가해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#! /bin/bash</span>\n\n<span class=\"token function-name function\">setProfile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AWS_PROFILE</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\n  <span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">AWS_DEFAULT_PROFILE</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\n\n  python ~/.aws/mfa.py --profile <span class=\"token variable\">$1</span> <span class=\"token variable\">$2</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token builtin class-name\">alias</span> <span class=\"token assign-left variable\">awsp</span><span class=\"token operator\">=</span>setProfile</code></pre></div>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> os\n<span class=\"token keyword\">import</span> json\n<span class=\"token keyword\">import</span> sys\n<span class=\"token keyword\">import</span> argparse\n<span class=\"token keyword\">import</span> subprocess\n<span class=\"token keyword\">import</span> configparser\n\nparser <span class=\"token operator\">=</span> argparse<span class=\"token punctuation\">.</span>ArgumentParser<span class=\"token punctuation\">(</span>description<span class=\"token operator\">=</span><span class=\"token string\">'Update your AWS CLI Token'</span><span class=\"token punctuation\">)</span>\nparser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'token'</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">'token from your MFA device'</span><span class=\"token punctuation\">)</span>\nparser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--profile'</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">'aws profile to store the session token'</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span>os<span class=\"token punctuation\">.</span>getenv<span class=\"token punctuation\">(</span><span class=\"token string\">'AWS_PROFILE'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nparser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--arn'</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">'AWS ARN from the IAM console (Security credentials -> Assigned MFA device). This is saved to your .aws/credentials file'</span><span class=\"token punctuation\">)</span>\nparser<span class=\"token punctuation\">.</span>add_argument<span class=\"token punctuation\">(</span><span class=\"token string\">'--credential-path'</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">help</span><span class=\"token operator\">=</span><span class=\"token string\">'path to the aws credentials file'</span><span class=\"token punctuation\">,</span> default<span class=\"token operator\">=</span>os<span class=\"token punctuation\">.</span>path<span class=\"token punctuation\">.</span>expanduser<span class=\"token punctuation\">(</span><span class=\"token string\">'~/.aws/credentials'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\nargs <span class=\"token operator\">=</span> parser<span class=\"token punctuation\">.</span>parse_args<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> args<span class=\"token punctuation\">.</span>profile <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    parser<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">(</span><span class=\"token string\">'Expecting --profile or profile set in environment AWS_PROFILE. e.g. \"stage\"'</span><span class=\"token punctuation\">)</span>\n\nconfig <span class=\"token operator\">=</span> configparser<span class=\"token punctuation\">.</span>ConfigParser<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nconfig<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>credential_path<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> args<span class=\"token punctuation\">.</span>profile <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> config<span class=\"token punctuation\">.</span>sections<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    parser<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">(</span><span class=\"token string\">'Invalid profile. Section not found in ~/.aws/credentails'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> args<span class=\"token punctuation\">.</span>arn <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token string\">'aws_arn_mfa'</span> <span class=\"token keyword\">not</span> <span class=\"token keyword\">in</span> config<span class=\"token punctuation\">[</span>args<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        sys<span class=\"token punctuation\">.</span>exit<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># parser.error('ARN is not provided. Specify via --arn')</span>\n\n    args<span class=\"token punctuation\">.</span>arn <span class=\"token operator\">=</span> config<span class=\"token punctuation\">[</span>args<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'aws_arn_mfa'</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># Update the arn with user supplied one</span>\n    config<span class=\"token punctuation\">[</span>args<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'aws_arn_mfa'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> args<span class=\"token punctuation\">.</span>arn\n\n<span class=\"token comment\"># Generate the session token from the profile</span>\nresult <span class=\"token operator\">=</span> subprocess<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'aws'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'sts'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'get-session-token'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'--profile'</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">.</span>profile <span class=\"token operator\">+</span> <span class=\"token string\">'-default'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'--serial-number'</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">.</span>arn<span class=\"token punctuation\">,</span> <span class=\"token string\">'--token-code'</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">.</span>token<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> stdout<span class=\"token operator\">=</span>subprocess<span class=\"token punctuation\">.</span>PIPE<span class=\"token punctuation\">,</span> stderr<span class=\"token operator\">=</span>subprocess<span class=\"token punctuation\">.</span>PIPE<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">if</span> result<span class=\"token punctuation\">.</span>returncode <span class=\"token operator\">!=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n    parser<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>stderr<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>strip<span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ncredentials <span class=\"token operator\">=</span> json<span class=\"token punctuation\">.</span>loads<span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token string\">'Credentials'</span><span class=\"token punctuation\">]</span>\n\nconfig<span class=\"token punctuation\">[</span>args<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'aws_access_key_id'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> credentials<span class=\"token punctuation\">[</span><span class=\"token string\">'AccessKeyId'</span><span class=\"token punctuation\">]</span>\nconfig<span class=\"token punctuation\">[</span>args<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'aws_secret_access_key'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> credentials<span class=\"token punctuation\">[</span><span class=\"token string\">'SecretAccessKey'</span><span class=\"token punctuation\">]</span>\nconfig<span class=\"token punctuation\">[</span>args<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'aws_session_token'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> credentials<span class=\"token punctuation\">[</span><span class=\"token string\">'SessionToken'</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># Save the changes back to the file</span>\n<span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>credential_path<span class=\"token punctuation\">,</span> <span class=\"token string\">'w'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> configFile<span class=\"token punctuation\">:</span>\n    config<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>configFile<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Saved {} credentials to {}'</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>profile<span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">.</span>credential_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<br>\n<p>이제 <code class=\"language-text\">awsp [프로필명] [mfa code]</code>과 같은 명령어로 사용하실 수 있습니다.\n예를 들어 dev 프로필의 경우 <code class=\"language-text\">awsp dev 012345</code>와 같이 실행합니다.\nMFA 조건이 없는 프로필의 경우 <code class=\"language-text\">awsp test 0</code>과 같이 실행하시면 됩니다.</p>\n<br>","excerpt":"클라우드 인프라를 관리하는 경우 여러 계정에 걸친 CLI를 사용하는 경우가 빈번합니다.\n만일 CLI 사용 시 MFA 인증을 요구하는 계정과 아닌 계정이 혼재되어 있다면 설정이 정말 귀찮아집니다.\n이 글에서는 간단한 스크립트를 통해 AWS CLI 설정 변경을 자동화해보려 합니다. AWS Credential 설정 먼저 사용하는 프로필의 credential 정보를 설정해줍니다.\nMFA인 프로필과 MFA가 아닌 프로필을 구분하기 위해 아래와 같은 구조로 저장하겠습니다.\n가 붙은 프로필이 MFA를 사용하는 프로필입니다.\n스크립트 실행을 통해 autogen…"}}}},"pageContext":{"slug":"aws-cli-mfa","basePath":"","prev":{"slug":"eks-vpc-cni","publishDate":"2019-11-04"},"next":{"slug":"tf-tips","publishDate":"2019-09-20"}}}}