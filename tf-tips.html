<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>Terraform 입문자를 위한 미세 팁</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- [[! highlight.js ]] -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    
        <meta property="og:site_name" content="Swalloow Blog" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="Terraform 입문자를 위한 미세 팁" />
        <meta property="og:description" content="​ ​ 클라우드를 활용하는 경우, 인프라 구성 관리 도구로 테라폼을 많이 사용합니다. 오늘은 처음 테라폼을 도입하려고 할때 알아두면 좋은 점들에..." />
        <meta property="og:url" content="/" />
        <meta property="og:image" content="/assets/images/cover_main.jpg" />
    

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Swalloow Blog" />
    <meta name="twitter:description" content="About Data Science, Data Engineering" />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image:src" content="/assets/images/cover_main.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Swalloow Blog",
    "url": "/",
    "image": "/assets/images/cover_main.jpg",
    "description": "About Data Science, Data Engineering"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Swalloow Blog" href="/feed.xml" />

</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        <li class="nav-personal " role="presentation"><a href="/tag/Personal">Personal</a></li>
        <li class="nav-develop " role="presentation"><a href="/tag/Develop">Develop</a></li>
        <li class="nav-devops " role="presentation"><a href="/tag/DevOps">DevOps</a></li>
        <li class="nav-datascience " role="presentation"><a href="/tag/DataScience">DataScience</a></li>
        <li class="nav-dataengineering " role="presentation"><a href="/tag/DataEngineering">DataEngineering</a></li>
        <li class="nav-financial " role="presentation"><a href="/tag/Financial">Financial</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/ghost.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-DevOps">

        <header class="post-header">
            <h1 class="post-title">Terraform 입문자를 위한 미세 팁</h1>
            <section class="post-meta">
            <!-- <a href='/'>Swalloow</a> -->
            <time class="post-date" datetime="2019-09-20">20 Sep 2019</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/DevOps'>Devops</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>​   ​</p>

<p>클라우드를 활용하는 경우, 인프라 구성 관리 도구로 테라폼을 많이 사용합니다.
오늘은 처음 테라폼을 도입하려고 할때 알아두면 좋은 점들에 대해 정리해보려 합니다.</p>

<p>​</p>

<h3 id="procedural-vs-declarative">Procedural vs Declarative</h3>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Ansible</span>
- ec2:
  count: 10
  image: ami-v1
  instance_type: t2.micro

<span class="c"># Terraform</span>
resource <span class="s2">"aws_instance"</span> <span class="s2">"example"</span> <span class="o">{</span>
   count         <span class="o">=</span> 10
   ami           <span class="o">=</span> <span class="s2">"ami-v1"</span>
   instance_type <span class="o">=</span> <span class="s2">"t2.micro"</span>
<span class="o">}</span></code></pre></figure>

<p>위에 나와있는 코드는 Ansible과 Terraform으로 EC2 인스턴스를 구성하는 코드입니다.
만일 여기서 둘의 count 값을 15로 변경한다면 어떻게 변할까요?</p>

<p>먼저 Ansible의 경우, declarative이며 mutable infrastructure를 지향합니다.
따라서 이미 생성된 10개의 인스턴스에 15개의 인스턴스가 추가로 생성되어 총 25개의 인스턴스가 떠있게 됩니다.
반면에 Terraform의 경우, procedural이며 immutable infrastructure를 지향합니다.
count를 15로 선언했기 때문에 Terraform은 이전 상태와 비교한다음, 5만큼의 변경에 대해 교체를 수행합니다.
결과적으로 총 15개의 인스턴스가 떠있게 됩니다.</p>

<p>서로 지향하는 성격이 다르다보니 적절한 상황에 사용하거나 함께 사용하면 좋습니다.
예를 들어 Provisioning 단계에서 Terraform을 사용하고 
Configuration, Dependency 설정 단계에서 Ansible을 사용하실 수 있습니다.</p>

<p><br /></p>

<h3 id="terraform-vs-cloudformation">Terraform vs CloudFormation</h3>

<p>AWS를 사용하는 경우, 클라우드 내에서 CloudFormation이라는 서비스를 제공합니다.
CloudFormation 역시 Terraform과 같은 기능을 제공하다보니 도입하기 전에 비교를 많이 합니다.
우선 모듈화, 개발, 문서 측면에서는 Terraform이 더 편했습니다.
이외의 큰 차이를 정리하자면 아래와 같습니다.</p>

<p><strong>CloudFormation은 AWS 지원이 빠릅니다.</strong>
신규 릴리즈된 서비스나 설정들은 Terraform AWS 모듈에 반영되기까지 시간이 좀 걸립니다.
반면에 CloudFormation은 대부분 바로 지원해주다보니 더 편할 수 있습니다.</p>

<p><strong>Terraform은 다른 클라우드 서비스도 지원합니다(Azure, Google Cloud).</strong>
만일 멀티클라우드 이슈에 대한 대응까지 고려하고 있다면 Terraform을 추천드립니다.</p>

<p><br /></p>

<h3 id="terraform-remote-backend">Terraform Remote Backend</h3>

<p><img src="http://drive.google.com/uc?export=view&amp;id=1NRXR-axT-hjEycpr3SigMI3x6e5m8Utx" alt="" /></p>

<p>Terraform은 상태를 <code class="highlighter-rouge">Consul, S3, Enterprise</code> 등의 원격 스토리지에 저장할 수 있습니다.
여러 명이 팀으로 일하는 경우, 인프라 변경 상태에 대한 동기화가 필요합니다.
이 경우 Remote Backend를 고려하시면 좋습니다.
state 파일은 workspace, env에 따라 서로 다른 파일로 관리할 수 있습니다.</p>

<p><br /></p>

<h3 id="terraform-migration">Terraform Migration</h3>

<p>이미 생성되어 있는 수 많은 인프라를 한번에 Terraform으로 옮기는 일은 정말 어렵습니다.
우선 모듈마다 점진적으로 마이그레이션 하는 방법을 추천드립니다.
Terraform은 아래의 코드처럼 이미 생성되어 있는 리소스를 불러올 수 있습니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">resource <span class="s2">"aws_vpc"</span> <span class="s2">"default"</span> <span class="o">{</span>
  <span class="c"># resource configuration...</span>
<span class="o">}</span>

<span class="c"># update remote state</span>
<span class="gp">$ </span>terraform import aws_vpc.default vpc-abc12345</code></pre></figure>

<p>또는 data 블럭을 이용해서 id, arn 등의 값을 불러올 수 있습니다.
예를 들어 아래는 Packer로 생성된 가장 최근 버전의 AMI를 불러오는 코드입니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">data <span class="s2">"aws_ami"</span> <span class="s2">"app"</span> <span class="o">{</span>
  most_recent <span class="o">=</span> <span class="nb">true
  </span>name_regex  <span class="o">=</span> <span class="s2">"app-</span><span class="se">\\</span><span class="s2">d{10}"</span>
  owners      <span class="o">=</span> <span class="o">[</span><span class="s2">"account_number"</span><span class="o">]</span>
<span class="o">}</span></code></pre></figure>

<p><br /></p>

<h3 id="terraform-module">Terraform Module</h3>

<p>Terraform은 모듈화를 통해 인프라를 재사용할 수 있습니다.
하지만 먼저 기존의 인프라를 어떻게 모듈화할지 많은 고민이 필요합니다.
자주 변경되어야 하는 일부분은 Terraform 관리 대상에서 제외시키는 방법도 있습니다.
또한 인프라 장애 대응이 필요한 부분은 쉽게 HA를 구성할 수 있도록 작성해야 합니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">module <span class="s2">"network"</span> <span class="o">{</span>
   <span class="nb">source</span> <span class="o">=</span> <span class="s2">"./network"</span>
   name   <span class="o">=</span> <span class="s2">"default"</span>
   cidr   <span class="o">=</span> <span class="s2">"000.0.0.0/16"</span>

   azs    <span class="o">=</span> <span class="o">[</span><span class="s2">"ap-northeast-2a"</span>, <span class="s2">"ap-northeast-2c"</span><span class="o">]</span>
   public_subnets <span class="o">=</span> <span class="o">[</span><span class="s2">"000.0.0.0/22"</span>, <span class="s2">"111.1.1.1/22"</span><span class="o">]</span>

   tags <span class="o">=</span> <span class="o">{</span>
      dept    <span class="o">=</span> <span class="s2">"mydept"</span>
      service <span class="o">=</span> <span class="s2">"app"</span>
   <span class="o">}</span>
<span class="o">}</span>

<span class="c"># common tags</span>
tags <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">merge</span><span class="p">(var.tags, map(</span><span class="s2">"Name"</span><span class="p">, format(</span><span class="s2">"%s-public-%s"</span><span class="p">, var.name, var.azs[count.index])))</span><span class="k">}</span><span class="s2">"</span></code></pre></figure>

<p>각 모듈은 Input과 Output Variable을 가집니다.
위의 예시는 네트워크에 관련된 모듈입니다.
모듈을 통해 생성된 모든 리소스는 공통된 태그를 통해 관리할 수 있으며
만일 네트워크 구성을 변경해야하는 경우, CIDR 값만 수정하면 됩니다.</p>

<p><br /></p>

<h3 id="terraform-loop-conditionls-012">Terraform Loop, Conditionls (0.12)</h3>

<p>Terraform은 0.12 버전을 기점으로 더 효율적인 코드를 작성할 수 있게 되었습니다.
따라서 새로 시작하신다면 0.12+ 버전 사용을 권장드립니다.
예시를 통해 Terraform에서 루프를 어떻게 정의하는지 설명드리겠습니다.
아래의 예시는 IAM Role에 Policy를 연결하는 코드입니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">locals <span class="o">{</span>
   lambda_backend_policy_arns <span class="o">=</span> <span class="o">[</span>
      <span class="s2">"arn:aws:iam::aws:policy/AmazonRDSFullAccess"</span>,
      <span class="s2">"arn:aws:iam::aws:policy/CloudWatchFullAccess"</span>,
      <span class="s2">"arn:aws:iam::aws:policy/AmazonDynamoDBFullAccess"</span>,
   <span class="o">]</span>
<span class="o">}</span>

resource <span class="s2">"aws_iam_role_policy_attachment"</span> <span class="s2">"attach"</span> <span class="o">{</span>
   count <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">length</span><span class="p">(local.lambda_backend_policy_arns)</span><span class="k">}</span><span class="s2">"</span>

   role <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">aws_iam_role</span><span class="p">.lambda_backend.name</span><span class="k">}</span><span class="s2">"</span>
   policy_arn <span class="o">=</span> <span class="s2">"</span><span class="k">${</span><span class="nv">local</span><span class="p">.lambda_backend_arns[count.index]</span><span class="k">}</span><span class="s2">"</span>
<span class="o">}</span></code></pre></figure>

<p>이전에는 위와 같이 Array 타입의 인덱스를 통해 Loop를 정의해야 했습니다.
하지만 0.12 버전부터 for-loop, for-each 구문을 지원하기 시작했습니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">variable <span class="s2">"subnet_numbers"</span> <span class="o">{</span>
   default <span class="o">=</span> <span class="o">{</span>
      <span class="s2">"ap-northeast-2a"</span> <span class="o">=</span> 1
      <span class="s2">"ap-northeast-2b"</span> <span class="o">=</span> 2
      <span class="s2">"ap-northeast-2c"</span> <span class="o">=</span> 3
   <span class="o">}</span>
<span class="o">}</span>

resource <span class="s2">"aws_subnet"</span> <span class="s2">"example"</span> <span class="o">{</span>
   for_each <span class="o">=</span> var.subnet_numbers
   
   vpc_id            <span class="o">=</span> aws_vpc.example.id
   availability_zone <span class="o">=</span> each.key
   cidr_block        <span class="o">=</span> cidrsubset<span class="o">(</span>
      aws_vpc.example.cidr_block, each.value
   <span class="o">)</span>
<span class="o">}</span></code></pre></figure>

<p>이외에도 찾아보시면 다양한 타입과 연산을 지원합니다.
이 글이 처음 입문하시는데 조금 도움이 되셨으면 좋겠습니다!</p>

<p>​</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/Swalloow" style="background-image: url(/assets/images/avatar.png)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/Swalloow">Swalloow</a></h4>

                
                    <p> Interested in Data Science & Engineering</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Seoul, Korea</span>
                    <span class="author-link icon-link"><a href="http://swalloow.github.io/"> swalloow.github.io/</a></span>
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Terraform 입문자를 위한 미세 팁&amp;url=http://swalloow.github.io/tf-tips"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://swalloow.github.io/tf-tips"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://swalloow.github.io/tf-tips"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'swalloow'; // required: replace example with your forum shortname
        var disqus_identifier = '/tf-tips';
        var disqus_url = 'http://swalloow.github.io//tf-tips';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev no-cover" href="/serverless-etl">
            <section class="post">
                <h2>Serverless ETL 서비스들에 대한 리뷰</h2>
                <p>​ 15년 AWS Lambda가 출시된 이후, 뜨거운 반응을 보이며 다양한 서버리스 서비스들이 출시되었다. 그 중...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Swalloow Blog</a> &copy; 2019</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-89689523-1', 'auto');
	    ga('send', 'pageview');

     </script>
</body>
</html>
