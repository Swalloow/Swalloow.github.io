<!DOCTYPE html>
<html amp lang="ko">
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>JWT를 구현하면서 마주치게 되는 고민들</title>
    <meta name="description" content="Swalloow Blog - About Data Science, Data Engineering" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- [[! highlight.js ]] -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <link rel="canonical" href="http://example.ampproject.org/article-metadata.html" />
    <style>.hljs { background: none; }</style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="Swalloow Blog" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Swalloow Blog" />
    <meta property="og:description" content="About Data Science, Data Engineering" />
    <meta property="og:url" content="/" />
    <meta property="og:image" content="/assets/images/cover_main.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Swalloow Blog" />
    <meta name="twitter:description" content="About Data Science, Data Engineering" />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image:src" content="/assets/images/cover_main.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Swalloow Blog",
    "url": "/",
    "image": "/assets/images/cover_main.jpg",
    "description": "About Data Science, Data Engineering"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Swalloow Blog" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        <li class="nav-personal " role="presentation"><a href="/tag/Personal">Personal</a></li>
        <li class="nav-develop " role="presentation"><a href="/tag/Develop">Develop</a></li>
        <li class="nav-devops " role="presentation"><a href="/tag/DevOps">DevOps</a></li>
        <li class="nav-datascience " role="presentation"><a href="/tag/DataScience">DataScience</a></li>
        <li class="nav-dataengineering " role="presentation"><a href="/tag/DataEngineering">DataEngineering</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/cover_develop.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/ghost.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-Develop">

        <header class="post-header">
            <h1 class="post-title">JWT를 구현하면서 마주치게 되는 고민들</h1>
            <section class="post-meta">
            <!-- <a href='/'>Swalloow</a> -->
            <time class="post-date" datetime="2017-03-03">03 Mar 2017</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/Develop'>Develop</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>​   ​</p>

<h1 id="json-web-token">JSON Web Token</h1>

<p>책에서 JWT를 쓴다면 만료시간을 꼭 명시적으로 두도록 하고 중간마다 토큰을 재 발행하도록 권장하시고 계시는데여.
그러면 초기에 토큰을 발행할때 만료시간을 주고 그것을 클라이언트한테 넘기고, 클라이언트가 api 호출할때 토큰을 받아 항상 만료 시간을 
검사해서 만료시간이 지나지 않았다며? 시간을 늘려서 다시 토큰을 만들고 API 서버에서 새로운 토큰을 클라이언트한테 전달하라는 말씀인지여? 토큰 재발행에 대한 로직이 잘 이해가 가지 않습니다!!^^ 제가 아직 많이 몰라서여… 감사합니다.</p>

<p>클라이언트가 토큰의 만료시간을 알 수 있기 때문에, 클라이언트에서 판단해서 만료시간이 넘었으면 토큰 재발급을 요청하는게 가장 일반적인 방법이 아닐까 합니다.</p>

<p>리프레시 관련해서 정확한 내용이 정해져 있는 것은 아닙니다만 일반적인 API를 보면 최초 발급시 access token과 refresh token 2개를 발급하고 access token으로 API를 사용하다가 만료시간이 지나면 만료시간을 길게 준 refresh token을 이용해서 access token을 다시 발급합니다. 여기서 refresh token에 대한 재발급 이슈도 남게 되고 토큰 만료시간 길이에 대한 이슈등이 있는데 이는 서비스의 민감도에 따라 다른것 같습니다.</p>

<p>​   ​</p>

<ul>
  <li>클라이언트에서 만료시간을 체크해서 서버에 토큰을 재발급하도록 요청</li>
  <li>토큰을 리프레시 할 경우, 기존에 있던 토큰을 강제로 만료시켜야 함</li>
  <li>보통 access token과 refresh token을 처음에 발급</li>
  <li>이후에 만료시간이 지나면 refresh token을 통해 새로운 토큰을 발급 받음</li>
  <li>Claim set은 암호화하지 않은 내용이기 때문에 중요한 데이터가 들어가면 안댐</li>
  <li>scope는 admin, user 이런게 아닌지? 개별 서비스 이용 토큰</li>
</ul>

<p>​   ​</p>

<h1 id="refresh-tokens-when-to-use-them-and-how-they-interact-with-jwts">Refresh Tokens: When to Use Them and How They Interact with JWTs</h1>

<p>모던 웹에서의 리프레시 토큰에 대해 간단히 알아보고 가벼운 예제를 통해 어떻게 동작하는지 살펴보자.</p>

<h2 id="token-types">Token types</h2>

<p>여기에서는 access token과 refresh token만 다룰 예정입니다.</p>

<ul>
  <li>access token은 리소스에 직접 접근할 수 있도록 해주는 정보만을 가지고 있다. 즉, 클라이언트는 access token이 있어야 서버 자원에 접근할 수 있다는 소리다. access token은 짧은 수명을 가지며, 만료기간을 갖는다.</li>
</ul>

<p><img src="/assets/images/access token.png" alt="access_token" /></p>

<ul>
  <li>refresh token은 새로운 access token을 발급받기 위한 정보를 갖는다. 즉, 클라이언트가 access token이 없거나 만료되었다면 refresh token을 통해 Auth Server에 요청해서 발급받을 수 있다. refresh token 또한 만료기간이 있지만 길다. refresh token은 중요하기 때문에 외부에 노출되지 않도록 엄격하게 관리해야 한다.</li>
</ul>

<p><img src="/assets/images/refresh token.png" alt="refresh_token" /></p>

<p>토큰이 안전하게 관리되는지 여부는 어떻게 구현하느냐에 달려있습니다. 보통은 access token에 대해 직접적으로 인증(direct authorization) 체크합니다. 무슨 말이냐 하면, access token이 서버 자원에 접근하려고 하면 서버가 토큰에 있는 정보를 읽어 스스로 인증여부를 결정합니다. 반면에, refresh token은 Auth Server에 대한 체크가 필요합니다. 이때 다음과 같은 세 가지 사항을 고려해야 합니다.</p>

<ol>
  <li>
    <p>빠른 인증 과정을 위해 토큰에 정보를 적게 담아야 한다.</p>
  </li>
  <li>
    <p>노출된 access token에 대해서는 빠르게 만료시켜 보호된 리소스에 접근할 수 있는 가능성을 줄어야 한다.</p>
  </li>
  <li>
    <p>Sliding sessions (뒤에서 설명)</p>
  </li>
</ol>

<h2 id="sliding-sessions">Sliding sessions</h2>

<p>Sliding sessions은 일정 기간 사용하지 않으면 만료되는 세션입니다. 이 세션은 refresh token과 access token을 통해 구현할 수 있습니다. 먼저, 사용자가 작업을 수행하려하면 새 access token이 발급됩니다. 반면, 사용자가 만료된 access token을 사용하려 하면 세션은 비활성화되며 새 access token을 요청합니다. 이 상황에서 refresh token을 통해 새로운 토큰을 발급받을 지 유무는 개발 팀이 결정하기에 따라 다릅니다.</p>

<h2 id="security-considerations">Security considerations</h2>

<p>refresh token의 수명은 아주 깁니다. 달리 말하면, 길게 저장되기 때문에 외부 공격으로부터 안전하게 저장되어야 합니다. refresh token이 유출되면 만료될 때 까지 새로운 토큰을 얻고 사용할 수 있습니다. 따라서, 다른 사람이 유출된 토큰을 사용하지 못하게 하려면 refresh token을 인증된 단일 클라이언트에 발행되어야 합니다. access token 역시 보안이 중요하지만, 수명이 짧기 때문에 refresh token의 보안에 각별히 주의하여야 합니다.</p>

<p>JWT는 기존의 OAuth2와 어떻게 연동될까?</p>

<p>기존의 /outh/token endpoint 에 의해 발급되는 모든 토큰은 OAuth2 미들웨어에 의해 보호 받는다.</p>

<p><code class="highlighter-rouge">json
{
	"token_type":"bearer",
	"access_token":"eyJ0eXAiOiJKV1QiLCJh",
	"expires_in":20,
	"refresh_token":"fdb8fdbecf1d03ce5e6125c067733c0d51de209c"
}
</code></p>

<p>인증 헤더는 BASE64로 인코딩 된 정보를 갖는다.</p>

<p>만료된 토큰을 통해 접근하려고 하면 다음과 같은 오류가 나타난다.</p>

<p><code class="highlighter-rouge">json
{
	"code":401,
	"error":"invalid_token",
	"error_description":"The access token provided has expired."
}
</code></p>

<p>refresh token은 보안을 향상시키고 지연 시간을 줄이고 인증 서버에 대한 액세스 패턴을 향상시킵니다. 구현은 JWT + JWS와 같은 도구를 사용하여 간단해질 수 있습니다.</p>

<p>​   ​</p>

<h4 id="section">참고링크</h4>

<ul>
  <li><a href="https://auth0.com/blog/ten-things-you-should-know-about-tokens-and-cookies/">10 things you should know about tokens and cookies</a></li>
  <li><a href="https://auth0.com/learn/refresh-tokens/">Learn refresh tokens</a></li>
  <li><a href="http://stackoverflow.com/questions/30826726/how-to-identify-if-the-oauth-token-has-expired">How to identify if the OAuth token has expired</a></li>
</ul>

<p>​   ​</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/Swalloow" style="background-image: url(/assets/images/avatar.png)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/Swalloow">Swalloow</a></h4>

                
                    <p> Interested in Data Science & Engineering</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Seoul, Korea</span>
                    <span class="author-link icon-link"><a href="http://swalloow.github.io/"> swalloow.github.io/</a></span>
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=JWT를 구현하면서 마주치게 되는 고민들&amp;url=http://swalloow.github.io/flask-jwt"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://swalloow.github.io/flask-jwt"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://swalloow.github.io/flask-jwt"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'swalloow'; // required: replace example with your forum shortname
        var disqus_identifier = '/flask-jwt';
        var disqus_url = 'http://swalloow.github.io//flask-jwt';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/cover_develop.jpg)" href="/https-ssl">
            <section class="post">
                <h2>HTTPS와 SSL 인증서, 그리고 SHA1 알고리즘</h2>
                <p>​ ​ 크롬 업데이트 이후 몇몇 웹 페이지는 브라우저 주소 창에 안전하지 않음이 나타나고, 아니면...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Swalloow Blog</a> &copy; 2017</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-89689523-1', 'auto');
	    ga('send', 'pageview');

     </script>
</body>
</html>
