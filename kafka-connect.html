<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>Kafka Connect로 S3에 데이터를 저장해보자</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- [[! highlight.js ]] -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    
        <meta property="og:site_name" content="Swalloow Blog" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="Kafka Connect로 S3에 데이터를 저장해보자" />
        <meta property="og:description" content="​ Kafka에는 정말 유용한 컴포넌트들이 존재합니다. 오늘은 그 중 하나인 Kafka-Connect에 대해 알아보고, Confluent에서 제공하는 Kafka-Connect-S3를 활용하여 S3로 데이터를 저장하는..." />
        <meta property="og:url" content="/" />
        <meta property="og:image" content="/assets/images/cover_main.jpg" />
    

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Swalloow Blog" />
    <meta name="twitter:description" content="About Data Science, Data Engineering" />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image:src" content="/assets/images/cover_main.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Swalloow Blog",
    "url": "/",
    "image": "/assets/images/cover_main.jpg",
    "description": "About Data Science, Data Engineering"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Swalloow Blog" href="/feed.xml" />

</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        <li class="nav-personal " role="presentation"><a href="/tag/Personal">Personal</a></li>
        <li class="nav-develop " role="presentation"><a href="/tag/Develop">Develop</a></li>
        <li class="nav-devops " role="presentation"><a href="/tag/DevOps">DevOps</a></li>
        <li class="nav-datascience " role="presentation"><a href="/tag/DataScience">DataScience</a></li>
        <li class="nav-dataengineering " role="presentation"><a href="/tag/DataEngineering">DataEngineering</a></li>
        <li class="nav-financial " role="presentation"><a href="/tag/Financial">Financial</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/ghost.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-DataEngineering">

        <header class="post-header">
            <h1 class="post-title">Kafka Connect로 S3에 데이터를 저장해보자</h1>
            <section class="post-meta">
            <!-- <a href='/'>Swalloow</a> -->
            <time class="post-date" datetime="2018-11-16">16 Nov 2018</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/DataEngineering'>Dataengineering</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>​</p>

<p>Kafka에는 정말 유용한 컴포넌트들이 존재합니다.
오늘은 그 중 하나인 Kafka-Connect에 대해 알아보고,
Confluent에서 제공하는 Kafka-Connect-S3를 활용하여
S3로 데이터를 저장하는 방법에 대해 정리해보려고 합니다.</p>

<p>​</p>

<h2 id="kafka-connect">Kafka Connect</h2>

<p><img src="http://drive.google.com/uc?export=view&amp;id=172qcC4a0mgYnkeZHlH7HH4lar1dAebA3" alt="kafka-connect" /></p>

<p>우리는 서버로부터 생성되는 데이터를 실시간으로 Kafka에 보내기도 하고,
Kafka Topic에 쌓여있는 데이터를 실시간으로 RDBMS, Object Storage와 같은 시스템에 보내기도 합니다.
Kafka Connect는 위의 그림과 같이 다양한 시스템과 Kafka 사이의 연결을 도와주는 역할을 하는 컴포넌트입니다.
Source System에서 Kafka로 들어가는 Connector를 Source Connect라 부르고,
Kafka에서 Target System으로 보내는 Connector를 Sink Connect라 부릅니다.</p>

<p>Kafka Connect는 JSON, Avro, Protobuf 등의 다양한 직렬화 포멧을 지원하며
Kafka Schema Registry와 연동시켜 공통된 스키마 지정을 할 수도 있습니다.</p>

<p>사실 Fluentd와 ELK Stack에서 사용하는 Logstash 등 서로 다른 시스템 간의 브릿지 역할을 하는 프레임워크들은 다양하게 존재합니다.
하지만 Kafka Connect가 갖는 강점은 Kafka와 긴밀히 연동되어 있다는 점 입니다.</p>

<p>Kafka Connect를 사용하지 않고 데이터를 실시간으로 전달하기 위해서는 Producer, Consumer API를 사용해야 합니다.
이 과정에서 이미 처리되거나 실패한 데이터를 추적한다거나, 데이터 분산처리, 작업을 배포하는 등의 작업을 수행해야만 합니다.</p>

<p>Kafka Connect는 앞의 모든 작업을 수행할 뿐만 아니라 connector task를 클러스터 전체에 자동으로 배포합니다.
또한, Connect Worker 중에 하나가 실패하거나 Network partition이 발생하더라도 실행하던 작업을 나머지 Worker들에게 자동으로 재조정합니다.
Offset을 자동으로 관리, 유지하기 때문에 재시작하더라도 중단 시점부터 다시 시작할 수 있고 (Exactly Once Delivery),
High performance Kafka library로 작성되어 빠르며 불필요한 polling 작업을 수행하지 않습니다.
무엇보다 코드 한 줄 없이 사용하기 편하다는 것도 큰 강점입니다.
혹시 Kafka를 이미 중앙 집중형 로그 저장소로 사용하고 있다면 Kafka Connect를 고려해볼만 하다고 생각합니다.</p>

<p>​</p>

<h2 id="kafka-connect-s3">Kafka-Connect-S3</h2>

<p>이 글에서는 Confluent로 Kafka를 설치하지 않은 경우를 예시로 들겠습니다.
이미 confluent-hub를 설치하셨거나 Confluent로 Kafka를 설치하셨다면 공식문서를 따라가시면 됩니다.</p>

<p><img src="http://drive.google.com/uc?export=view&amp;id=1R80lOarW9k1RGv2kYAYxNz_-q6wUsm28" alt="aws-kafka-s3" /></p>

<p>데이터 인프라가 AWS 환경에 구축되어 있다면 S3를 Cold Storage로 많이 사용하게 됩니다.
최대한 단순하게 그림을 그려보면 위의 그림과 같은 아키텍쳐가 나오게 됩니다.
여기에서는 Kafka에서 S3로 실시간 데이터를 저장하기 위해 Kafka-Connect-S3를 사용하게 됩니다.</p>

<p>먼저 confluent에서 kafka-connect-s3를 다운받아 plugins 경로에 추가합니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>wget https://api.hub.confluent.io/api/plugins/confluentinc/kafka-connect-s3/versions/4.1.1/archive
<span class="gp">$ </span>unzip archive
<span class="gp">$ </span>mkdir -p plugins/kafka-connect-s3
<span class="gp">$ </span>cp confluentinc-kafka-connect-s3-4.1.1/lib/<span class="k">*</span> plugins/kafka-connect-s3/</code></pre></figure>

<p>이제 kafka config 경로에 <code class="highlighter-rouge">connect.properties</code>라는 이름으로 설정 파일을 추가합니다.
<code class="highlighter-rouge">bootstrap.servers</code>와 <code class="highlighter-rouge">plugin.path</code> 경로는 상황에 맞게 수정하시면 됩니다.
추가로 kafka 클러스터를 private network로 연결하고 싶다면 9093 포트를 사용해주시면 됩니다.</p>

<script src="https://gist.github.com/Swalloow/3657a0f3c44e969f388a39ff135d38d3.js"></script>

<p>​</p>

<p>기존 클러스터에 Authentication credentials, encryption이 설정되어 있다면,
connect.properties에 관련 설정을 추가해주셔야 합니다.</p>

<p>다음 S3에 데이터가 저장될 Bucket을 생성하고, AWS Credentials를 설정합니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>pip install awscli
<span class="gp">$ </span>aws configure</code></pre></figure>

<p>sink connector 관련 설정 파일을 <code class="highlighter-rouge">s3-sink.properties</code>라는 이름으로 config 경로에 추가합니다.
topics와 s3.bucket.name의 이름은 맞게 수정해주셔야 합니다.</p>

<script src="https://gist.github.com/Swalloow/6dcc4604ca3847afa631d35ffaa24ac4.js"></script>

<p>​</p>

<p>이제 Kafka 설치 경로로 이동하고 Kafka-Connect를 실행시킵니다.
여기에서는 standalone mode로 실행시켰지만, 경우에 따라 cluster mode로 실행하거나
docker container로 실행시켜도 됩니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">./bin/connect-standalone.sh connect.properties s3-sink.properties</code></pre></figure>

<p>이제 지정한 S3 Bucket의 topic/my-topic-name/2018-11-16 경로에 가시면
지정한 설정 값에 따라 파일이 저장되는 것을 확인하실 수 있습니다.</p>

<p><img src="http://drive.google.com/uc?export=view&amp;id=1bepmpAHi7kwUnqvGOwyq0i8jSMIhhMeU" alt="" /></p>

<p>이미 Yahoo의 kafka-manager를 사용하고 계신 분들은 consumers 메뉴로 가시면
topic 마다 lag도 모니터링할 수 있습니다.</p>

<p>​</p>

<h3 id="kafka-connect-s3-configuration">Kafka-Connect-S3 Configuration</h3>

<p>데이터 인프라에 맞게 수정해야할 옵션은 아래와 같습니다.</p>

<ul>
  <li><strong>s3.part.size</strong>: S3의 multi part upload 사이즈를 지정</li>
  <li><strong>flush.size</strong>: file commit 시 저장할 record의 수 (파일 사이즈와 연관)</li>
  <li><strong>partitioner.class</strong>: partition 기준을 지정 (TimeBasedPartitioner는 시간을 기준으로 파티셔닝)</li>
</ul>

<p>이외에도 Avro Format과 Schema Registry를 사용하신다면 <code class="highlighter-rouge">format.class</code>, <code class="highlighter-rouge">schema.generator.class</code>를 수정해야 합니다.
더 자세한 내용은 <a href="https://docs.confluent.io/5.0.0/connect/kafka-connect-s3/configuration_options.html#s3-configuration-options">공식문서</a>에서 확인하시면 됩니다.</p>

<p>​</p>

<h2 id="reference">Reference</h2>

<p>사실 Kafka는 이미 대부분의 데이터 파이프라인에서 활용하고 있다는 것이 강점이라고 생각합니다.
ETL 과정이 다양하고 복잡할 수록 새로운 프레임워크가 추가되고 아키텍쳐가 복잡해지기 마련인데,
Kafka의 다양한 컴포넌트들을 잘 활용하면 아키텍쳐를 단순화시킬 수도 있습니다.</p>

<ul>
  <li>https://www.confluent.io/blog/kafka-connect-deep-dive-converters-serialization-explained</li>
  <li>https://docs.confluent.io/5.0.0/connect/kafka-connect-s3/index.html</li>
</ul>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/Swalloow" style="background-image: url(/assets/images/avatar.png)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/Swalloow">Swalloow</a></h4>

                
                    <p> Interested in Data Science & Engineering</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Seoul, Korea</span>
                    <span class="author-link icon-link"><a href="http://swalloow.github.io/"> swalloow.github.io/</a></span>
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=Kafka Connect로 S3에 데이터를 저장해보자&amp;url=http://swalloow.github.io/kafka-connect"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://swalloow.github.io/kafka-connect"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://swalloow.github.io/kafka-connect"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'swalloow'; // required: replace example with your forum shortname
        var disqus_identifier = '/kafka-connect';
        var disqus_url = 'http://swalloow.github.io//kafka-connect';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story no-cover" href="/airflow-contrib">
            <section class="post">
                <h2>Apache Airflow에 기여하면서 배운 점들</h2>
                <p>​ Apache Airflow는 코드를 통해 워크플로우를 관리하고 모니터링 할 수 있도록 도와주는 플랫폼이다. Airflow 프로젝트에...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev no-cover" href="/start">
            <section class="post">
                <h2>17-18년 블로그 회고 및 다짐</h2>
                <p>​ 지킬 블로그로 이사한지도 벌써 2년이 다 되어 간다. 항상 이 맘때쯤이면 글쓰는 횟수가 줄어들고...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Swalloow Blog</a> &copy; 2019</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-89689523-1', 'auto');
	    ga('send', 'pageview');

     </script>
</body>
</html>
