<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- [[! Document Settings ]] -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- [[! Page Meta ]] -->
    <title>EKS 클러스터에 VPC CIDR 추가하기</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- [[! Styles'n'Scripts ]] -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css"
          href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- [[! highlight.js ]] -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- [[! Ghost outputs important style and meta data with this tag ]] -->
        <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    <link rel="canonical" href="/" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    
        <meta property="og:site_name" content="Swalloow Blog" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="EKS 클러스터에 VPC CIDR 추가하기" />
        <meta property="og:description" content="​ 앞서 정리했던 EKS의 VPC 네트워크 구성 이해하기 글에서 언급한 바와 같이 내 요구사항보다 적은 범위의 대역으로 클러스터를 생성한다면 VPC..." />
        <meta property="og:url" content="/" />
        <meta property="og:image" content="/assets/images/cover_main.jpg" />
    

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Swalloow Blog" />
    <meta name="twitter:description" content="About Data Science, Data Engineering" />
    <meta name="twitter:url" content="/" />
    <meta name="twitter:image:src" content="/assets/images/cover_main.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "Swalloow Blog",
    "url": "/",
    "image": "/assets/images/cover_main.jpg",
    "description": "About Data Science, Data Engineering"
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="Swalloow Blog" href="/feed.xml" />

</head>
<body class="home-template nav-closed">

    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        <li class="nav-personal " role="presentation"><a href="/tag/Personal">Personal</a></li>
        <li class="nav-develop " role="presentation"><a href="/tag/Develop">Develop</a></li>
        <li class="nav-devops " role="presentation"><a href="/tag/DevOps">DevOps</a></li>
        <li class="nav-datascience " role="presentation"><a href="/tag/DataScience">DataScience</a></li>
        <li class="nav-dataengineering " role="presentation"><a href="/tag/DataEngineering">DataEngineering</a></li>
        <li class="nav-financial " role="presentation"><a href="/tag/Financial">Financial</a></li>
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- [[! Everything else gets inserted here ]] -->
        <!-- < default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/ghost.png" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-DevOps">

        <header class="post-header">
            <h1 class="post-title">EKS 클러스터에 VPC CIDR 추가하기</h1>
            <section class="post-meta">
            <!-- <a href='/'>Swalloow</a> -->
            <time class="post-date" datetime="2020-03-14">14 Mar 2020</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/DevOps'>Devops</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <p>​<br /></p>

<p>앞서 정리했던 <a href="https://swalloow.github.io/eks-vpc-cni">EKS의 VPC 네트워크 구성 이해하기</a> 글에서 언급한 바와 같이 내 요구사항보다 적은 범위의 대역으로 클러스터를 생성한다면 VPC CNI로 인한 IP 제한에 마주할 수 있습니다.</p>

<p>처음부터 넓은 범위의 대역으로 생성하면 좋겠지만 이미 클러스터를 생성한 이후에는 어떻게 하면 좋을까요? 
이러한 경우에는 VPC에 새로운 CIDR을 할당하고 이를 클러스터에 추가할 수 있습니다.</p>

<p>​<br /></p>

<h3 id="vpc-cidr">VPC CIDR</h3>

<p><img src="http://drive.google.com/uc?export=view&amp;id=1i0LURjsrJbJWwqaVikpEDg3DQtmPhUp-" alt="" /></p>

<p>먼저 확장하고자 하는 VPC를 선택한 후 새로운 CIDR 범위를 추가해주어야 합니다. 저는 위의 그림과 같이 10.X.X.X와 100.X.X.X 범위를 추가해주었습니다. 이후 새로운 CIDR 범위를 사용하여 서브넷을 생성한 다음 라우팅 테이블을 연결해줍니다.
EKS에서 서브넷을 검색 가능하도록 하기 위해 아래와 같은 태그를 추가해줍니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">Key</span><span class="o">=</span>kubernetes.io/cluster/yourClusterName,Value<span class="o">=</span>shared</code></pre></figure>

<p><br /></p>

<h3 id="custom-eni-config">Custom ENI Config</h3>

<p>이제 새로운 CIDR 범위를 사용하도록 CNI 플러그인 설정을 변경해주어야 합니다. 먼저 클러스터에서 사용 중인 CNI 플러그인 버전을 확인하고 만일 1.5.3 미만인 경우 최신 버전으로 업데이트 합니다. (2020년 3월 기준, 최신 버전은 1.6 입니다)</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>kubectl describe daemonset aws-node --namespace kube-system | grep Image | cut -d <span class="s2">"/"</span> -f 2
<span class="gp">$ </span>kubectl apply -f https://raw.githubusercontent.com/aws/amazon-vpc-cni-k8s/master/config/v1.6/aws-k8s-cni.yaml</code></pre></figure>

<p>설치한 이후에 <code class="highlighter-rouge">kubectl get crd</code>를 통해 <strong>ENIConfig CRD</strong>가 제대로 설치되었는지 확인해줍니다. 만약 설치가 안되었다면 아래의 파일을 통해 CRD를 정의해주시면 됩니다.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="s">apiVersion</span><span class="pi">:</span> <span class="s">apiextensions.k8s.io/v1beta1</span>
<span class="s">kind</span><span class="pi">:</span> <span class="s">CustomResourceDefinition</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">eniconfigs.crd.k8s.amazonaws.com</span>
<span class="s">spec</span><span class="pi">:</span>
  <span class="s">scope</span><span class="pi">:</span> <span class="s">Cluster</span>
  <span class="s">group</span><span class="pi">:</span> <span class="s">crd.k8s.amazonaws.com</span>
  <span class="s">version</span><span class="pi">:</span> <span class="s">v1alpha1</span>
  <span class="s">names</span><span class="pi">:</span>
    <span class="s">plural</span><span class="pi">:</span> <span class="s">eniconfigs</span>
    <span class="s">singular</span><span class="pi">:</span> <span class="s">eniconfig</span>
    <span class="s">kind</span><span class="pi">:</span> <span class="s">ENIConfig</span></code></pre></figure>

<p>이후에 aws-node daemonset에서 커스텀 네트워크 설정을 활성화하는 환경변수를 업데이트 해줍니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$ </span>kubectl <span class="nb">set </span>env daemonset aws-node -n kube-system <span class="nv">AWS_VPC_K8S_CNI_CUSTOM_NETWORK_CFG</span><span class="o">=</span><span class="nb">true</span></code></pre></figure>

<p>이제 앞서 생성한 서브넷에 대해 ENIConfig CRD를 생성해줍니다.
아래는 ap-northeast-2a, 2c에 대한 2개의 서브넷에 대한 파일입니다.
보안 그룹도 클러스터 설정에 맞게 정의해주시면 됩니다.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="s">apiVersion</span><span class="pi">:</span> <span class="s">crd.k8s.amazonaws.com/v1alpha1</span>
<span class="s">kind</span><span class="pi">:</span> <span class="s">ENIConfig</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">private-user-2a</span>
<span class="s">spec</span><span class="pi">:</span>
  <span class="s">subnet</span><span class="pi">:</span> <span class="s">subnet-0ddddaaaaddddccdd</span>
  <span class="s">securityGroups</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">sg-05555598cc88ffd00</span>

<span class="nn">---</span>
<span class="s">apiVersion</span><span class="pi">:</span> <span class="s">crd.k8s.amazonaws.com/v1alpha1</span>
<span class="s">kind</span><span class="pi">:</span> <span class="s">ENIConfig</span>
<span class="s">metadata</span><span class="pi">:</span>
  <span class="s">name</span><span class="pi">:</span> <span class="s">private-user-2c</span>
<span class="s">spec</span><span class="pi">:</span>
  <span class="s">subnet</span><span class="pi">:</span> <span class="s">subnet-0ccccaaaaddddccee</span>
  <span class="s">securityGroups</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">sg-05555598cc88ffd00</span></code></pre></figure>

<p>마지막으로 클러스터에 해당하는 노드 그룹의 어노테이션을 수정해주어야 합니다. <a href="https://github.com/terraform-aws-modules/terraform-aws-eks">terraform-aws-eks</a> 모듈을 통해 클러스터를 생성하셨다면 <code class="highlighter-rouge">worker_groups</code> 하위에 <code class="highlighter-rouge">kubelet_extra_args</code> 변수 설정을 통해 오토스케일링 그룹 설정을 수정할 수 있습니다.</p>

<p>추가되어야할 어노테이션 값은 아래와 같습니다.
Value 값의 경우, 위에서 추가한 ENIConfig CRD의 name metadata를 넣어주시면 됩니다. 업데이트 이후에는 노드를 재시작해주어야 정상적으로 적용됩니다.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">k8s.amazonaws.com/eniConfig<span class="o">=</span>private-user-2c</code></pre></figure>

<p><br /></p>

<h3 id="reference">Reference</h3>

<ul>
  <li><a href="https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html">https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/cni-custom-network.html</a></li>
  <li><a href="https://aws.amazon.com/ko/premiumsupport/knowledge-center/eks-multiple-cidr-ranges/">https://aws.amazon.com/ko/premiumsupport/knowledge-center/eks-multiple-cidr-ranges/</a></li>
</ul>

<p>​<br /></p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->

            
            <figure class="author-image">
                <a class="img" href="/author/Swalloow" style="background-image: url(/assets/images/avatar.png)"><span class="hidden">'s Picture</span></a>
            </figure>
            

            <section class="author">
                <h4><a href="/author/Swalloow">Swalloow</a></h4>

                
                    <p> Interested in Data Science & Engineering</p>
                
                <div class="author-meta">
                    <span class="author-location icon-location"> Seoul, Korea</span>
                    <span class="author-link icon-link"><a href="http://swalloow.github.io/"> swalloow.github.io/</a></span>
                </div>
            </section>

            <!-- /author  -->

            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="http://twitter.com/share?text=EKS 클러스터에 VPC CIDR 추가하기&amp;url=http://swalloow.github.io/eks-cidr"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://swalloow.github.io/eks-cidr"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://swalloow.github.io/eks-cidr"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

            <!-- Add Disqus Comments -->
            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev no-cover" href="/aws-cert">
            <section class="post">
                <h2>AWS Solutions Architect Associate 취득 후기</h2>
                <p>​ 그동안 관심은 있었지만 굳이 내 돈주고 시험볼 생각이 없었기에 미루고 있다가 12월까지 취득하면 50달러를...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">Swalloow Blog</a> &copy; 2020</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/biomadeira/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- [[! Ghost outputs important scripts and data with this tag ]] -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <!-- [[! The main JavaScript file for Casper ]] -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-89689523-1', 'auto');
	    ga('send', 'pageview');

     </script>
</body>
</html>
